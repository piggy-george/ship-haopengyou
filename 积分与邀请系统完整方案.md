# ç§¯åˆ†ä¸é‚€è¯·ç³»ç»Ÿå®Œæ•´æŠ€æœ¯æ–¹æ¡ˆ

## ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯
- **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
- **åˆ›å»ºæ—¥æœŸ**: 2025-10-18
- **é¡¹ç›®**: å¥½æœ‹å‹ AI é€ ç‰©å¹³å°
- **å…³è”æ–‡æ¡£**: `shipany-docs/17-é‚€è¯·è¿”ä½£.md`, `è…¾è®¯æ··å…ƒ3D_APIæ¥å£æ–‡æ¡£.md`

---

## ğŸ¯ ä¸€ã€éœ€æ±‚æ¦‚è¿°

### 1.1 æ ¸å¿ƒåŠŸèƒ½

#### âœ… ç§¯åˆ†èµ é€æœºåˆ¶
- **é»˜è®¤æ³¨å†Œå¥–åŠ±**: æ–°ç”¨æˆ·æ³¨å†Œè·å¾— **100 ç§¯åˆ†**
- **é‚€è¯·æ³¨å†Œå¥–åŠ±**:
  - æ–°ç”¨æˆ·è·å¾—: **100ï¼ˆåŸºç¡€ï¼‰+ 50ï¼ˆé‚€è¯·å¥–åŠ±ï¼‰= 150 ç§¯åˆ†**
  - é‚€è¯·äººè·å¾—: **50 ç§¯åˆ†** å¥–åŠ±
  - å¥–åŠ±å‘æ”¾æ—¶æœº: **æ³¨å†Œæ—¶ç«‹å³å‘æ”¾**ï¼ˆæ— éœ€ç­‰å¾…æ¿€æ´»ï¼‰

#### ğŸ”‘ é‚€è¯·ç ç³»ç»Ÿ
- æ¯ä¸ªç”¨æˆ·æ‹¥æœ‰å”¯ä¸€é‚€è¯·ç ï¼ˆ8ä½å­—ç¬¦ï¼ŒåŸºäº UUID ç”Ÿæˆï¼‰
- æ³¨å†Œæ—¶å¯é€‰å¡«å†™é‚€è¯·ç 
- é‚€è¯·å…³ç³»è¿½è¸ªï¼ˆè®°å½•è°é‚€è¯·äº†è°ï¼‰
- **å•ç”¨æˆ·é‚€è¯·ä¸Šé™**: 100äººï¼ˆé˜²æ­¢æ¶æ„åˆ·é‚€è¯·ï¼‰

#### ğŸ’° ç§¯åˆ†æ¶ˆè€—æœºåˆ¶
- å¯¹æ¥è…¾è®¯æ··å…ƒ 3D API
- æ ¹æ® API å®é™…è¿”å›çš„æ¶ˆè€—é‡æ‰£é™¤ç§¯åˆ†ï¼ˆ1:1 å¯¹åº”ï¼‰
- ç§¯åˆ†ä¸è¶³æ—¶ç”Ÿæˆå‰å¼¹çª—æç¤ºï¼Œå¼•å¯¼å……å€¼
- **ç”Ÿæˆå¤±è´¥è¿”è¿˜ç§¯åˆ†**ï¼ˆä¸è…¾è®¯æ··å…ƒ 3D æœºåˆ¶ä¸€è‡´ï¼‰

#### ğŸ’³ ç§¯åˆ†å……å€¼åŠŸèƒ½ï¼ˆé¢„ç•™ï¼‰
- ç”¨æˆ·å¯ä»˜è´¹å……å€¼ç§¯åˆ†ï¼ˆæš‚ä¸å®ç°ï¼Œé¢„ç•™æ¥å£ï¼‰
- å……å€¼æ¡£ä½å’Œä»·æ ¼åç»­å¼€æ”¾

#### â° ç§¯åˆ†æœ‰æ•ˆæœŸ
- èµ é€ç§¯åˆ†ï¼š**æ°¸ä¹…æœ‰æ•ˆ**
- é‚€è¯·ç§¯åˆ†ï¼š**æ°¸ä¹…æœ‰æ•ˆ**
- å……å€¼ç§¯åˆ†ï¼š**æ°¸ä¹…æœ‰æ•ˆ**
- æ‰€æœ‰ç§¯åˆ†ç»Ÿä¸€å½’ç±»ï¼Œæ— è¿‡æœŸæœºåˆ¶

#### ğŸ“Š ç®¡ç†åå°åŠŸèƒ½
- ç”¨æˆ·ç§¯åˆ†æ¶ˆè€—åˆ—è¡¨
- ç”¨æˆ·é‚€è¯·è®°å½•æŸ¥è¯¢
- ç§¯åˆ†æ‰‹åŠ¨è°ƒæ•´åŠŸèƒ½
- æ¶ˆè€—ç»Ÿè®¡å’Œæ•°æ®åˆ†æ

---

## ğŸ—„ï¸ äºŒã€æ•°æ®åº“è®¾è®¡

### 2.1 ç°æœ‰è¡¨ç»“æ„åˆ†æ

#### `users` è¡¨ï¼ˆå·²å­˜åœ¨ï¼‰
```sql
-- ç°æœ‰å­—æ®µ
id: integer (ä¸»é”®)
uuid: varchar(255) UNIQUE
email: varchar(255)
credits: integer DEFAULT 0              -- âœ… å·²æœ‰ç§¯åˆ†ä½™é¢å­—æ®µ
invite_code: varchar(255) DEFAULT ''    -- âœ… å·²æœ‰é‚€è¯·ç å­—æ®µ
invited_by: varchar(255) DEFAULT ''     -- âœ… å·²æœ‰é‚€è¯·äººå­—æ®µ
created_at: timestamp
...
```

**âœ… çŠ¶æ€**: å­—æ®µå®Œå¤‡ï¼Œæ— éœ€ä¿®æ”¹

---

### 2.2 æ–°å¢è¡¨ç»“æ„

#### 2.2.1 `credit_transactions` è¡¨ï¼ˆæ–°å¢ç§¯åˆ†è®°å½•è¡¨ï¼‰

**è¯´æ˜**: ç°æœ‰ `credits` è¡¨ä»…è®°å½•è®¢å•å……å€¼ï¼Œéœ€æ–°å¢é€šç”¨ç§¯åˆ†äº¤æ˜“è¡¨

```sql
CREATE TABLE credit_transactions (
  id SERIAL PRIMARY KEY,
  uuid VARCHAR(255) NOT NULL UNIQUE,
  user_uuid VARCHAR(255) NOT NULL,

  -- äº¤æ˜“ç±»å‹
  type VARCHAR(50) NOT NULL,              -- 'register', 'invite_reward', 'invite_new_user', 'consume_3d', 'refund', 'admin_adjust', 'purchase'
  amount INTEGER NOT NULL,                -- ç§¯åˆ†å˜åŠ¨ï¼ˆæ­£æ•°=å¢åŠ ï¼Œè´Ÿæ•°=æ‰£é™¤ï¼‰
  balance_after INTEGER NOT NULL,         -- æ“ä½œåçš„ç§¯åˆ†ä½™é¢ï¼ˆå†—ä½™å­—æ®µï¼Œä¾¿äºå¯¹è´¦ï¼‰

  -- å…³è”ä¿¡æ¯
  related_user_uuid VARCHAR(255),         -- å…³è”ç”¨æˆ·ï¼ˆé‚€è¯·åœºæ™¯ä¸ºè¢«é‚€è¯·äºº/é‚€è¯·äººï¼‰
  related_record_uuid VARCHAR(255),       -- å…³è”è®°å½•ï¼ˆ3Dç”Ÿæˆè®°å½•ã€è®¢å•ç­‰ï¼‰
  order_no VARCHAR(255),                  -- å…³è”è®¢å•å·ï¼ˆå……å€¼åœºæ™¯ï¼‰

  -- æè¿°ä¿¡æ¯
  description TEXT,                       -- äº¤æ˜“è¯´æ˜
  metadata JSON,                          -- æ‰©å±•å…ƒæ•°æ®ï¼ˆå­˜å‚¨é¢å¤–ä¿¡æ¯ï¼‰

  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

  INDEX idx_user_uuid (user_uuid),
  INDEX idx_type (type),
  INDEX idx_created_at (created_at)
);
```

**ç§¯åˆ†ç±»å‹ (type) æšä¸¾**:
```typescript
enum CreditTransactionType {
  Register = 'register',              // æ³¨å†Œå¥–åŠ±
  InviteReward = 'invite_reward',     // é‚€è¯·ä»–äººå¥–åŠ±
  InviteNewUser = 'invite_new_user',  // è¢«é‚€è¯·äººå¥–åŠ±
  Consume3D = 'consume_3d',           // 3Dç”Ÿæˆæ¶ˆè€—
  Refund = 'refund',                  // ç”Ÿæˆå¤±è´¥é€€æ¬¾
  AdminAdjust = 'admin_adjust',       // ç®¡ç†å‘˜æ‰‹åŠ¨è°ƒæ•´
  Purchase = 'purchase',              // è´­ä¹°å……å€¼ï¼ˆé¢„ç•™ï¼‰
}
```

---

#### 2.2.2 `invitations` è¡¨ï¼ˆæ–°å¢é‚€è¯·è®°å½•è¡¨ï¼‰

**è¯´æ˜**: ç°æœ‰ `affiliates` è¡¨ä»…è®°å½•æ”¯ä»˜å…³è”ï¼Œéœ€ç‹¬ç«‹é‚€è¯·è¡¨

```sql
CREATE TABLE invitations (
  id SERIAL PRIMARY KEY,
  uuid VARCHAR(255) NOT NULL UNIQUE,

  -- é‚€è¯·å…³ç³»
  inviter_uuid VARCHAR(255) NOT NULL,     -- é‚€è¯·äººUUID
  invitee_uuid VARCHAR(255) NOT NULL,     -- è¢«é‚€è¯·äººUUID
  invitation_code VARCHAR(255) NOT NULL,  -- ä½¿ç”¨çš„é‚€è¯·ç 

  -- å¥–åŠ±ä¿¡æ¯
  inviter_reward INTEGER NOT NULL,        -- é‚€è¯·äººè·å¾—ç§¯åˆ†ï¼ˆ50ï¼‰
  invitee_reward INTEGER NOT NULL,        -- è¢«é‚€è¯·äººè·å¾—ç§¯åˆ†ï¼ˆ50ï¼‰

  -- çŠ¶æ€è¿½è¸ª
  status VARCHAR(50) NOT NULL DEFAULT 'completed',  -- 'completed', 'cancelled'

  -- æ—¶é—´è®°å½•
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

  INDEX idx_inviter (inviter_uuid),
  INDEX idx_invitee (invitee_uuid),
  UNIQUE constraint_unique_invitee (invitee_uuid)   -- æ¯ä¸ªç”¨æˆ·åªèƒ½è¢«é‚€è¯·ä¸€æ¬¡
);
```

---

#### 2.2.3 æ‰©å±• `ai_generation_records` è¡¨

**è¯´æ˜**: ç°æœ‰è¡¨å·²æœ‰åŸºç¡€å­—æ®µï¼Œéœ€æ–°å¢ç§¯åˆ†æ¶ˆè€—å­—æ®µ

```sql
ALTER TABLE ai_generation_records ADD COLUMN IF NOT EXISTS
  credits_consumed INTEGER DEFAULT 0,              -- å®é™…æ¶ˆè€—ç§¯åˆ†ï¼ˆAPIè¿”å›ï¼‰
  credits_refunded INTEGER DEFAULT 0,              -- é€€è¿˜ç§¯åˆ†ï¼ˆå¤±è´¥åœºæ™¯ï¼‰
  credits_transaction_uuid VARCHAR(255);           -- å…³è”ç§¯åˆ†äº¤æ˜“è®°å½•UUID
```

---

### 2.3 æ•°æ®åº“è¿ç§»è„šæœ¬

#### è¿ç§»æ–‡ä»¶: `migrations/001_credits_invitation_system.sql`

```sql
-- ============================================
-- ç§¯åˆ†ä¸é‚€è¯·ç³»ç»Ÿæ•°æ®åº“è¿ç§»
-- ç‰ˆæœ¬: v1.0
-- æ—¥æœŸ: 2025-10-18
-- ============================================

-- 1. åˆ›å»ºç§¯åˆ†äº¤æ˜“è®°å½•è¡¨
CREATE TABLE IF NOT EXISTS credit_transactions (
  id SERIAL PRIMARY KEY,
  uuid VARCHAR(255) NOT NULL UNIQUE,
  user_uuid VARCHAR(255) NOT NULL,
  type VARCHAR(50) NOT NULL,
  amount INTEGER NOT NULL,
  balance_after INTEGER NOT NULL,
  related_user_uuid VARCHAR(255),
  related_record_uuid VARCHAR(255),
  order_no VARCHAR(255),
  description TEXT,
  metadata JSON,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_credit_transactions_user ON credit_transactions(user_uuid);
CREATE INDEX idx_credit_transactions_type ON credit_transactions(type);
CREATE INDEX idx_credit_transactions_created ON credit_transactions(created_at);

-- 2. åˆ›å»ºé‚€è¯·è®°å½•è¡¨
CREATE TABLE IF NOT EXISTS invitations (
  id SERIAL PRIMARY KEY,
  uuid VARCHAR(255) NOT NULL UNIQUE,
  inviter_uuid VARCHAR(255) NOT NULL,
  invitee_uuid VARCHAR(255) NOT NULL,
  invitation_code VARCHAR(255) NOT NULL,
  inviter_reward INTEGER NOT NULL DEFAULT 50,
  invitee_reward INTEGER NOT NULL DEFAULT 50,
  status VARCHAR(50) NOT NULL DEFAULT 'completed',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_invitations_inviter ON invitations(inviter_uuid);
CREATE INDEX idx_invitations_invitee ON invitations(invitee_uuid);
ALTER TABLE invitations ADD CONSTRAINT unique_invitee UNIQUE (invitee_uuid);

-- 3. æ‰©å±• ai_generation_records è¡¨
ALTER TABLE ai_generation_records
  ADD COLUMN IF NOT EXISTS credits_consumed INTEGER DEFAULT 0,
  ADD COLUMN IF NOT EXISTS credits_refunded INTEGER DEFAULT 0,
  ADD COLUMN IF NOT EXISTS credits_transaction_uuid VARCHAR(255);

-- 4. æ›´æ–°ç°æœ‰ç”¨æˆ·çš„é‚€è¯·ç ï¼ˆå¦‚æœä¸ºç©ºï¼‰
UPDATE users
SET invite_code = SUBSTRING(MD5(RANDOM()::text), 1, 8)
WHERE invite_code = '' OR invite_code IS NULL;

-- 5. åˆ›å»ºæŸ¥è¯¢é‚€è¯·ç»Ÿè®¡çš„è§†å›¾ï¼ˆä¾¿äºç®¡ç†åå°ï¼‰
CREATE OR REPLACE VIEW invitation_stats AS
SELECT
  u.uuid as user_uuid,
  u.email,
  u.nickname,
  u.credits,
  u.invite_code,
  COUNT(DISTINCT i.invitee_uuid) as total_invites,
  COALESCE(SUM(i.inviter_reward), 0) as total_invite_rewards
FROM users u
LEFT JOIN invitations i ON u.uuid = i.inviter_uuid AND i.status = 'completed'
GROUP BY u.uuid, u.email, u.nickname, u.credits, u.invite_code;

-- 6. åˆ›å»ºç”¨æˆ·ç§¯åˆ†æ¶ˆè€—ç»Ÿè®¡è§†å›¾
CREATE OR REPLACE VIEW user_credits_summary AS
SELECT
  u.uuid as user_uuid,
  u.email,
  u.nickname,
  u.credits as current_balance,
  COALESCE(SUM(CASE WHEN ct.amount > 0 THEN ct.amount ELSE 0 END), 0) as total_earned,
  COALESCE(SUM(CASE WHEN ct.amount < 0 THEN ABS(ct.amount) ELSE 0 END), 0) as total_spent,
  COUNT(CASE WHEN ct.type = 'consume_3d' THEN 1 END) as generation_count
FROM users u
LEFT JOIN credit_transactions ct ON u.uuid = ct.user_uuid
GROUP BY u.uuid, u.email, u.nickname, u.credits;

COMMENT ON TABLE credit_transactions IS 'ç§¯åˆ†äº¤æ˜“è®°å½•è¡¨ - è®°å½•æ‰€æœ‰ç§¯åˆ†å˜åŠ¨';
COMMENT ON TABLE invitations IS 'é‚€è¯·è®°å½•è¡¨ - è®°å½•ç”¨æˆ·é‚€è¯·å…³ç³»';
COMMENT ON VIEW invitation_stats IS 'é‚€è¯·ç»Ÿè®¡è§†å›¾ - ç”¨äºç®¡ç†åå°å±•ç¤º';
COMMENT ON VIEW user_credits_summary IS 'ç”¨æˆ·ç§¯åˆ†æ±‡æ€»è§†å›¾ - ç”¨äºç®¡ç†åå°ç»Ÿè®¡';
```

---

## ğŸ’» ä¸‰ã€åç«¯å®ç°

### 3.1 æ•°æ®æ¨¡å‹å®šä¹‰

#### æ–‡ä»¶: `src/db/schema.ts`

```typescript
// åœ¨ç°æœ‰ schema.ts ä¸­æ–°å¢ä»¥ä¸‹è¡¨å®šä¹‰

// ç§¯åˆ†äº¤æ˜“è®°å½•è¡¨
export const creditTransactions = pgTable("credit_transactions", {
  id: integer().primaryKey().generatedAlwaysAsIdentity(),
  uuid: varchar({ length: 255 }).notNull().unique(),
  user_uuid: varchar({ length: 255 }).notNull(),
  type: varchar({ length: 50 }).notNull(),
  amount: integer().notNull(),
  balance_after: integer().notNull(),
  related_user_uuid: varchar({ length: 255 }),
  related_record_uuid: varchar({ length: 255 }),
  order_no: varchar({ length: 255 }),
  description: text(),
  metadata: json(),
  created_at: timestamp({ withTimezone: true }).defaultNow(),
}, (table) => [
  index("credit_transactions_user_idx").on(table.user_uuid),
  index("credit_transactions_type_idx").on(table.type),
  index("credit_transactions_created_idx").on(table.created_at),
]);

// é‚€è¯·è®°å½•è¡¨
export const invitations = pgTable("invitations", {
  id: integer().primaryKey().generatedAlwaysAsIdentity(),
  uuid: varchar({ length: 255 }).notNull().unique(),
  inviter_uuid: varchar({ length: 255 }).notNull(),
  invitee_uuid: varchar({ length: 255 }).notNull(),
  invitation_code: varchar({ length: 255 }).notNull(),
  inviter_reward: integer().notNull().default(50),
  invitee_reward: integer().notNull().default(50),
  status: varchar({ length: 50 }).notNull().default('completed'),
  created_at: timestamp({ withTimezone: true }).defaultNow(),
}, (table) => [
  index("invitations_inviter_idx").on(table.inviter_uuid),
  index("invitations_invitee_idx").on(table.invitee_uuid),
  unique("unique_invitee").on(table.invitee_uuid),
]);

// æ‰©å±• ai_generation_records è¡¨
export const aiGenerationRecords = pgTable("ai_generation_records", {
  // ... ç°æœ‰å­—æ®µ ...
  credits_consumed: integer().default(0),
  credits_refunded: integer().default(0),
  credits_transaction_uuid: varchar({ length: 255 }),
});
```

---

### 3.2 ä¸šåŠ¡é€»è¾‘å±‚

#### æ–‡ä»¶: `src/services/credits-system.ts` ï¼ˆæ–°å»ºï¼‰

```typescript
import { db } from '@/db';
import { users, creditTransactions, invitations } from '@/db/schema';
import { eq, sql, desc } from 'drizzle-orm';
import { getUuid } from '@/lib/hash';

// ==================== å¸¸é‡å®šä¹‰ ====================

export const CREDITS_CONFIG = {
  REGISTER_REWARD: 100,        // æ³¨å†Œå¥–åŠ±
  INVITE_REWARD_INVITER: 50,   // é‚€è¯·äººå¥–åŠ±
  INVITE_REWARD_INVITEE: 50,   // è¢«é‚€è¯·äººå¥–åŠ±
  MAX_INVITES_PER_USER: 100,   // å•ç”¨æˆ·é‚€è¯·ä¸Šé™
} as const;

export enum CreditTransactionType {
  Register = 'register',
  InviteReward = 'invite_reward',
  InviteNewUser = 'invite_new_user',
  Consume3D = 'consume_3d',
  Refund = 'refund',
  AdminAdjust = 'admin_adjust',
  Purchase = 'purchase',
}

// ==================== ç§¯åˆ†æ“ä½œæ ¸å¿ƒå‡½æ•° ====================

/**
 * å¢åŠ ç”¨æˆ·ç§¯åˆ†ï¼ˆé€šç”¨å‡½æ•°ï¼‰
 */
export async function addCredits({
  userUuid,
  amount,
  type,
  description,
  relatedUserUuid,
  relatedRecordUuid,
  orderNo,
  metadata,
}: {
  userUuid: string;
  amount: number;
  type: CreditTransactionType;
  description: string;
  relatedUserUuid?: string;
  relatedRecordUuid?: string;
  orderNo?: string;
  metadata?: any;
}) {
  return await db.transaction(async (tx) => {
    // 1. æ›´æ–°ç”¨æˆ·ç§¯åˆ†ä½™é¢
    const [updatedUser] = await tx
      .update(users)
      .set({
        credits: sql`${users.credits} + ${amount}`,
      })
      .where(eq(users.uuid, userUuid))
      .returning();

    if (!updatedUser) {
      throw new Error('ç”¨æˆ·ä¸å­˜åœ¨');
    }

    // 2. åˆ›å»ºç§¯åˆ†äº¤æ˜“è®°å½•
    const [transaction] = await tx
      .insert(creditTransactions)
      .values({
        uuid: getUuid(),
        user_uuid: userUuid,
        type,
        amount,
        balance_after: updatedUser.credits,
        related_user_uuid: relatedUserUuid,
        related_record_uuid: relatedRecordUuid,
        order_no: orderNo,
        description,
        metadata: metadata ? JSON.stringify(metadata) : null,
        created_at: new Date(),
      })
      .returning();

    return {
      transaction,
      newBalance: updatedUser.credits,
    };
  });
}

/**
 * æ‰£é™¤ç”¨æˆ·ç§¯åˆ†ï¼ˆç”¨äº3Dç”Ÿæˆæ¶ˆè€—ï¼‰
 */
export async function deductCredits({
  userUuid,
  amount,
  type,
  description,
  relatedRecordUuid,
  metadata,
}: {
  userUuid: string;
  amount: number;
  type: CreditTransactionType;
  description: string;
  relatedRecordUuid?: string;
  metadata?: any;
}) {
  return await db.transaction(async (tx) => {
    // 1. æ£€æŸ¥ç”¨æˆ·ç§¯åˆ†æ˜¯å¦è¶³å¤Ÿ
    const [user] = await tx
      .select()
      .from(users)
      .where(eq(users.uuid, userUuid))
      .limit(1);

    if (!user) {
      throw new Error('ç”¨æˆ·ä¸å­˜åœ¨');
    }

    if (user.credits < amount) {
      throw new Error('ç§¯åˆ†ä¸è¶³');
    }

    // 2. æ‰£é™¤ç§¯åˆ†
    const [updatedUser] = await tx
      .update(users)
      .set({
        credits: sql`${users.credits} - ${amount}`,
      })
      .where(eq(users.uuid, userUuid))
      .returning();

    // 3. åˆ›å»ºç§¯åˆ†äº¤æ˜“è®°å½•
    const [transaction] = await tx
      .insert(creditTransactions)
      .values({
        uuid: getUuid(),
        user_uuid: userUuid,
        type,
        amount: -amount, // è´Ÿæ•°è¡¨ç¤ºæ‰£é™¤
        balance_after: updatedUser.credits,
        related_record_uuid: relatedRecordUuid,
        description,
        metadata: metadata ? JSON.stringify(metadata) : null,
        created_at: new Date(),
      })
      .returning();

    return {
      transaction,
      newBalance: updatedUser.credits,
    };
  });
}

// ==================== æ³¨å†Œä¸é‚€è¯·é€»è¾‘ ====================

/**
 * å¤„ç†ç”¨æˆ·æ³¨å†Œç§¯åˆ†å¥–åŠ±
 */
export async function handleRegisterReward({
  userUuid,
  inviteCode,
}: {
  userUuid: string;
  inviteCode?: string;
}) {
  return await db.transaction(async (tx) => {
    // 1. å‘æ”¾æ³¨å†ŒåŸºç¡€å¥–åŠ±ï¼ˆ100ç§¯åˆ†ï¼‰
    await addCredits({
      userUuid,
      amount: CREDITS_CONFIG.REGISTER_REWARD,
      type: CreditTransactionType.Register,
      description: 'æ–°ç”¨æˆ·æ³¨å†Œå¥–åŠ±',
    });

    // 2. å¤„ç†é‚€è¯·ç é€»è¾‘
    if (inviteCode) {
      // 2.1 æŸ¥æ‰¾é‚€è¯·äºº
      const [inviter] = await tx
        .select()
        .from(users)
        .where(eq(users.invite_code, inviteCode))
        .limit(1);

      if (!inviter) {
        console.warn(`é‚€è¯·ç ä¸å­˜åœ¨: ${inviteCode}`);
        return { invited: false };
      }

      // 2.2 æ£€æŸ¥é‚€è¯·äººé‚€è¯·æ•°é‡ä¸Šé™
      const inviteCount = await tx
        .select({ count: sql<number>`count(*)` })
        .from(invitations)
        .where(eq(invitations.inviter_uuid, inviter.uuid));

      if (inviteCount[0].count >= CREDITS_CONFIG.MAX_INVITES_PER_USER) {
        console.warn(`é‚€è¯·äººå·²è¾¾ä¸Šé™: ${inviter.email}`);
        return { invited: false, reason: 'inviter_limit_reached' };
      }

      // 2.3 æ›´æ–°è¢«é‚€è¯·äººçš„ invited_by å­—æ®µ
      await tx
        .update(users)
        .set({ invited_by: inviter.uuid })
        .where(eq(users.uuid, userUuid));

      // 2.4 å‘æ”¾è¢«é‚€è¯·äººé¢å¤–å¥–åŠ±ï¼ˆ50ç§¯åˆ†ï¼‰
      await addCredits({
        userUuid,
        amount: CREDITS_CONFIG.INVITE_REWARD_INVITEE,
        type: CreditTransactionType.InviteNewUser,
        description: 'ä½¿ç”¨é‚€è¯·ç æ³¨å†Œå¥–åŠ±',
        relatedUserUuid: inviter.uuid,
      });

      // 2.5 å‘æ”¾é‚€è¯·äººå¥–åŠ±ï¼ˆ50ç§¯åˆ†ï¼‰
      await addCredits({
        userUuid: inviter.uuid,
        amount: CREDITS_CONFIG.INVITE_REWARD_INVITER,
        type: CreditTransactionType.InviteReward,
        description: `é‚€è¯·æ–°ç”¨æˆ·å¥–åŠ±`,
        relatedUserUuid: userUuid,
      });

      // 2.6 åˆ›å»ºé‚€è¯·è®°å½•
      await tx.insert(invitations).values({
        uuid: getUuid(),
        inviter_uuid: inviter.uuid,
        invitee_uuid: userUuid,
        invitation_code: inviteCode,
        inviter_reward: CREDITS_CONFIG.INVITE_REWARD_INVITER,
        invitee_reward: CREDITS_CONFIG.INVITE_REWARD_INVITEE,
        status: 'completed',
        created_at: new Date(),
      });

      return {
        invited: true,
        inviterEmail: inviter.email,
        inviterReward: CREDITS_CONFIG.INVITE_REWARD_INVITER,
        inviteeReward: CREDITS_CONFIG.INVITE_REWARD_INVITEE,
      };
    }

    return { invited: false };
  });
}

// ==================== 3Dç”Ÿæˆç§¯åˆ†æ¶ˆè€— ====================

/**
 * 3Dç”Ÿæˆå‰æ£€æŸ¥ç§¯åˆ†å¹¶é¢„æ‰£
 */
export async function check3DGenerationCredits({
  userUuid,
  estimatedCredits,
}: {
  userUuid: string;
  estimatedCredits: number;
}) {
  const [user] = await db
    .select()
    .from(users)
    .where(eq(users.uuid, userUuid))
    .limit(1);

  if (!user) {
    throw new Error('ç”¨æˆ·ä¸å­˜åœ¨');
  }

  if (user.credits < estimatedCredits) {
    return {
      sufficient: false,
      currentBalance: user.credits,
      required: estimatedCredits,
      shortage: estimatedCredits - user.credits,
    };
  }

  return {
    sufficient: true,
    currentBalance: user.credits,
    required: estimatedCredits,
  };
}

/**
 * 3Dç”ŸæˆæˆåŠŸåæ‰£é™¤å®é™…ç§¯åˆ†
 */
export async function consume3DGenerationCredits({
  userUuid,
  recordUuid,
  actualCredits,
  metadata,
}: {
  userUuid: string;
  recordUuid: string;
  actualCredits: number;
  metadata?: any;
}) {
  return await deductCredits({
    userUuid,
    amount: actualCredits,
    type: CreditTransactionType.Consume3D,
    description: `3Dæ¨¡å‹ç”Ÿæˆæ¶ˆè€—ï¼ˆ${actualCredits}ç§¯åˆ†ï¼‰`,
    relatedRecordUuid: recordUuid,
    metadata,
  });
}

/**
 * 3Dç”Ÿæˆå¤±è´¥é€€è¿˜ç§¯åˆ†
 */
export async function refund3DGenerationCredits({
  userUuid,
  recordUuid,
  refundAmount,
  reason,
}: {
  userUuid: string;
  recordUuid: string;
  refundAmount: number;
  reason: string;
}) {
  return await addCredits({
    userUuid,
    amount: refundAmount,
    type: CreditTransactionType.Refund,
    description: `3Dç”Ÿæˆå¤±è´¥é€€æ¬¾: ${reason}`,
    relatedRecordUuid: recordUuid,
  });
}

// ==================== æŸ¥è¯¢å‡½æ•° ====================

/**
 * è·å–ç”¨æˆ·ç§¯åˆ†äº¤æ˜“å†å²
 */
export async function getUserCreditTransactions({
  userUuid,
  page = 1,
  limit = 50,
}: {
  userUuid: string;
  page?: number;
  limit?: number;
}) {
  const offset = (page - 1) * limit;

  const transactions = await db
    .select()
    .from(creditTransactions)
    .where(eq(creditTransactions.user_uuid, userUuid))
    .orderBy(desc(creditTransactions.created_at))
    .limit(limit)
    .offset(offset);

  const total = await db
    .select({ count: sql<number>`count(*)` })
    .from(creditTransactions)
    .where(eq(creditTransactions.user_uuid, userUuid));

  return {
    transactions,
    pagination: {
      page,
      limit,
      total: total[0].count,
      totalPages: Math.ceil(total[0].count / limit),
    },
  };
}

/**
 * è·å–ç”¨æˆ·é‚€è¯·è®°å½•
 */
export async function getUserInvitations({
  userUuid,
  page = 1,
  limit = 50,
}: {
  userUuid: string;
  page?: number;
  limit?: number;
}) {
  const offset = (page - 1) * limit;

  const invites = await db
    .select({
      invitation: invitations,
      invitee: users,
    })
    .from(invitations)
    .leftJoin(users, eq(invitations.invitee_uuid, users.uuid))
    .where(eq(invitations.inviter_uuid, userUuid))
    .orderBy(desc(invitations.created_at))
    .limit(limit)
    .offset(offset);

  const total = await db
    .select({ count: sql<number>`count(*)` })
    .from(invitations)
    .where(eq(invitations.inviter_uuid, userUuid));

  return {
    invitations: invites,
    pagination: {
      page,
      limit,
      total: total[0].count,
      totalPages: Math.ceil(total[0].count / limit),
    },
  };
}
```

---

### 3.3 ä¿®æ”¹æ³¨å†Œé€»è¾‘

#### æ–‡ä»¶: `src/app/api/auth/register/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { db } from '@/db';
import { users } from '@/db/schema';
import { eq } from 'drizzle-orm';
import { encryptPassword, validatePasswordStrength } from '@/lib/password';
import { getUuid } from '@/lib/hash';
import { v4 as uuidv4 } from 'uuid';
import { handleRegisterReward } from '@/services/credits-system';

export async function POST(req: NextRequest) {
  try {
    const { email, password, nickname, inviteCode } = await req.json();

    // 1. éªŒè¯è¾“å…¥
    if (!email || !password) {
      return NextResponse.json(
        { error: 'é‚®ç®±å’Œå¯†ç ä¸èƒ½ä¸ºç©º' },
        { status: 400 }
      );
    }

    // éªŒè¯é‚®ç®±æ ¼å¼
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      return NextResponse.json(
        { error: 'é‚®ç®±æ ¼å¼ä¸æ­£ç¡®' },
        { status: 400 }
      );
    }

    // éªŒè¯å¯†ç å¼ºåº¦
    const passwordValidation = validatePasswordStrength(password);
    if (!passwordValidation.valid) {
      return NextResponse.json(
        { error: passwordValidation.message },
        { status: 400 }
      );
    }

    // 2. æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²å­˜åœ¨
    const existingUser = await db
      .select()
      .from(users)
      .where(eq(users.email, email.toLowerCase()))
      .limit(1);

    if (existingUser.length > 0) {
      return NextResponse.json(
        { error: 'è¯¥é‚®ç®±å·²è¢«æ³¨å†Œ' },
        { status: 400 }
      );
    }

    // 3. åŠ å¯†å¯†ç 
    const passwordEncrypted = encryptPassword(password);

    // 4. ç”Ÿæˆå”¯ä¸€é‚€è¯·ç 
    const userInviteCode = uuidv4().substring(0, 8);
    const userUuid = getUuid();

    // 5. åˆ›å»ºç”¨æˆ·ï¼ˆåˆå§‹ç§¯åˆ†ä¸º0ï¼Œåç»­é€šè¿‡ç§¯åˆ†ç³»ç»Ÿå‘æ”¾ï¼‰
    const newUser = await db.insert(users).values({
      uuid: userUuid,
      email: email.toLowerCase(),
      nickname: nickname || email.split('@')[0],
      password_encrypted: passwordEncrypted,
      account_type: 'email',
      credits: 0, // åˆå§‹ä¸º0ï¼Œç”±ç§¯åˆ†ç³»ç»Ÿç»Ÿä¸€ç®¡ç†
      invite_code: userInviteCode,
      signin_type: 'credentials',
      signin_provider: 'email',
      created_at: new Date(),
    }).returning();

    // 6. å‘æ”¾æ³¨å†Œå¥–åŠ±å’Œå¤„ç†é‚€è¯·é€»è¾‘
    const rewardResult = await handleRegisterReward({
      userUuid: newUser[0].uuid,
      inviteCode: inviteCode || undefined,
    });

    console.log('[æ³¨å†ŒæˆåŠŸ]', {
      email: newUser[0].email,
      nickname: newUser[0].nickname,
      inviteCode: inviteCode || 'none',
      rewardResult,
    });

    return NextResponse.json({
      success: true,
      message: 'æ³¨å†ŒæˆåŠŸ',
      user: {
        email: newUser[0].email,
        nickname: newUser[0].nickname,
        inviteCode: newUser[0].invite_code,
        creditsAwarded: rewardResult.invited
          ? CREDITS_CONFIG.REGISTER_REWARD + CREDITS_CONFIG.INVITE_REWARD_INVITEE
          : CREDITS_CONFIG.REGISTER_REWARD,
      },
    });

  } catch (error: any) {
    console.error('[æ³¨å†Œå¤±è´¥]', error);
    return NextResponse.json(
      { error: 'æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•' },
      { status: 500 }
    );
  }
}
```

---

### 3.4 ä¿®æ”¹3Dç”ŸæˆAPI

#### æ–‡ä»¶: `src/app/api/ai/generate/text-to-3d/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { getServerSession } from 'next-auth';
import { authOptions } from '@/auth/config';
import { Model3DService } from '@/lib/ai/model3d-service';
import { db } from '@/db';
import { aiGenerationRecords } from '@/db/schema';
import { getUuid } from '@/lib/hash';
import {
  check3DGenerationCredits,
  consume3DGenerationCredits
} from '@/services/credits-system';

export async function POST(req: NextRequest) {
  try {
    const session = await getServerSession(authOptions);
    if (!session?.user?.uuid) {
      return NextResponse.json({ error: 'æœªç™»å½•' }, { status: 401 });
    }

    const body = await req.json();
    const { version, prompt, imageUrl, ...otherParams } = body;

    // 1. ä½¿ç”¨ Model3DService è®¡ç®—é¢„ä¼°ç§¯åˆ†
    const service = new Model3DService();
    const estimatedCredits = service.calculateCredits({
      version,
      prompt,
      imageUrl,
      ...otherParams,
    });

    // 2. æ£€æŸ¥ç”¨æˆ·ç§¯åˆ†æ˜¯å¦è¶³å¤Ÿ
    const creditCheck = await check3DGenerationCredits({
      userUuid: session.user.uuid,
      estimatedCredits,
    });

    if (!creditCheck.sufficient) {
      return NextResponse.json({
        error: 'insufficient_credits',
        message: 'ç§¯åˆ†ä¸è¶³',
        data: {
          currentBalance: creditCheck.currentBalance,
          required: creditCheck.required,
          shortage: creditCheck.shortage,
        },
      }, { status: 402 }); // 402 Payment Required
    }

    // 3. åˆ›å»ºç”Ÿæˆè®°å½•
    const recordUuid = getUuid();
    const [record] = await db.insert(aiGenerationRecords).values({
      uuid: recordUuid,
      user_uuid: session.user.uuid,
      type: 'text23d',
      prompt: prompt || null,
      params: JSON.stringify({ version, imageUrl, ...otherParams }),
      status: 'pending',
      created_at: new Date(),
      credits_consumed: 0, // å¾…APIè¿”å›åæ›´æ–°
    }).returning();

    // 4. è°ƒç”¨è…¾è®¯æ··å…ƒ3D API
    const result = await service.generateModel({
      version,
      prompt,
      imageUrl,
      ...otherParams,
    });

    // 5. APIè°ƒç”¨æˆåŠŸï¼Œæ‰£é™¤å®é™…ç§¯åˆ†
    // æ³¨æ„: è¿™é‡Œä½¿ç”¨é¢„ä¼°å€¼ï¼Œå®é™…åº”åœ¨æŸ¥è¯¢ä»»åŠ¡å®Œæˆåæ ¹æ®APIè¿”å›æ‰£é™¤
    const consumeResult = await consume3DGenerationCredits({
      userUuid: session.user.uuid,
      recordUuid: record.uuid,
      actualCredits: estimatedCredits,
      metadata: {
        version,
        jobId: result.jobId,
        prompt: prompt?.substring(0, 100),
      },
    });

    // 6. æ›´æ–°ç”Ÿæˆè®°å½•
    await db.update(aiGenerationRecords)
      .set({
        cloud_job_id: result.jobId,
        status: 'processing',
        credits_consumed: estimatedCredits,
        credits_transaction_uuid: consumeResult.transaction.uuid,
      })
      .where(eq(aiGenerationRecords.uuid, recordUuid));

    return NextResponse.json({
      success: true,
      data: {
        recordUuid,
        jobId: result.jobId,
        creditsConsumed: estimatedCredits,
        newBalance: consumeResult.newBalance,
      },
    });

  } catch (error: any) {
    console.error('[3Dç”Ÿæˆå¤±è´¥]', error);

    if (error.message === 'ç§¯åˆ†ä¸è¶³') {
      return NextResponse.json({
        error: 'insufficient_credits',
        message: 'ç§¯åˆ†ä¸è¶³ï¼Œè¯·å……å€¼åé‡è¯•',
      }, { status: 402 });
    }

    return NextResponse.json({
      error: 'generation_failed',
      message: error.message || 'ç”Ÿæˆå¤±è´¥',
    }, { status: 500 });
  }
}
```

---

### 3.5 å¤„ç†ç”Ÿæˆå¤±è´¥é€€æ¬¾

#### æ–‡ä»¶: `src/lib/queue/model3d-queue.ts` (ä¿®æ”¹)

```typescript
import { refund3DGenerationCredits } from '@/services/credits-system';
import { db } from '@/db';
import { aiGenerationRecords } from '@/db/schema';
import { eq } from 'drizzle-orm';

// åœ¨æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€çš„é€»è¾‘ä¸­æ·»åŠ 
export async function handleJobFailure(recordUuid: string, errorMessage: string) {
  // 1. è·å–ç”Ÿæˆè®°å½•
  const [record] = await db
    .select()
    .from(aiGenerationRecords)
    .where(eq(aiGenerationRecords.uuid, recordUuid))
    .limit(1);

  if (!record) {
    throw new Error('è®°å½•ä¸å­˜åœ¨');
  }

  // 2. å¦‚æœå·²æ‰£é™¤ç§¯åˆ†ï¼Œåˆ™é€€æ¬¾
  if (record.credits_consumed > 0 && record.credits_refunded === 0) {
    const refundResult = await refund3DGenerationCredits({
      userUuid: record.user_uuid,
      recordUuid: record.uuid,
      refundAmount: record.credits_consumed,
      reason: errorMessage,
    });

    // 3. æ›´æ–°è®°å½•
    await db.update(aiGenerationRecords)
      .set({
        status: 'failed',
        error_message: errorMessage,
        credits_refunded: record.credits_consumed,
      })
      .where(eq(aiGenerationRecords.uuid, recordUuid));

    console.log('[ç§¯åˆ†é€€æ¬¾]', {
      recordUuid,
      userUuid: record.user_uuid,
      refundAmount: record.credits_consumed,
      newBalance: refundResult.newBalance,
    });
  }
}
```

---

## ğŸ¨ å››ã€å‰ç«¯å®ç°

### 4.1 æ³¨å†Œé¡µé¢æ·»åŠ é‚€è¯·ç è¾“å…¥

#### æ–‡ä»¶: `src/components/auth/RegisterForm.tsx` (ä¿®æ”¹)

```typescript
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { cacheGet } from '@/lib/cache';
import { CacheKey } from '@/services/constant';

export default function RegisterForm() {
  const router = useRouter();
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [nickname, setNickname] = useState('');
  const [inviteCode, setInviteCode] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  // ä»ç¼“å­˜ä¸­è¯»å–é‚€è¯·ç 
  useEffect(() => {
    const cachedCode = cacheGet(CacheKey.InviteCode);
    if (cachedCode) {
      setInviteCode(cachedCode);
    }
  }, []);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError('');

    try {
      const res = await fetch('/api/auth/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password, nickname, inviteCode }),
      });

      const data = await res.json();

      if (!res.ok) {
        throw new Error(data.error || 'æ³¨å†Œå¤±è´¥');
      }

      // æ³¨å†ŒæˆåŠŸï¼Œæ˜¾ç¤ºå¥–åŠ±ä¿¡æ¯
      alert(`æ³¨å†ŒæˆåŠŸï¼æ‚¨å·²è·å¾— ${data.user.creditsAwarded} ç§¯åˆ†`);
      router.push('/login');

    } catch (err: any) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      {/* é‚®ç®± */}
      <input
        type="email"
        placeholder="é‚®ç®±"
        value={email}
        onChange={(e) => setEmail(e.target.value)}
        required
      />

      {/* å¯†ç  */}
      <input
        type="password"
        placeholder="å¯†ç ï¼ˆè‡³å°‘8ä½ï¼‰"
        value={password}
        onChange={(e) => setPassword(e.target.value)}
        required
      />

      {/* æ˜µç§° */}
      <input
        type="text"
        placeholder="æ˜µç§°ï¼ˆå¯é€‰ï¼‰"
        value={nickname}
        onChange={(e) => setNickname(e.target.value)}
      />

      {/* é‚€è¯·ç  */}
      <div>
        <input
          type="text"
          placeholder="é‚€è¯·ç ï¼ˆå¯é€‰ï¼‰"
          value={inviteCode}
          onChange={(e) => setInviteCode(e.target.value)}
        />
        {inviteCode && (
          <p className="text-sm text-green-600 mt-1">
            âœ… ä½¿ç”¨é‚€è¯·ç å¯é¢å¤–è·å¾— 50 ç§¯åˆ†
          </p>
        )}
      </div>

      {error && <p className="text-red-500">{error}</p>}

      <button type="submit" disabled={loading}>
        {loading ? 'æ³¨å†Œä¸­...' : 'æ³¨å†Œ'}
      </button>
    </form>
  );
}
```

---

### 4.2 ç§¯åˆ†ä¸è¶³å¼¹çª—ç»„ä»¶

#### æ–‡ä»¶: `src/components/credits/InsufficientCreditsModal.tsx` (æ–°å»º)

```typescript
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';

interface Props {
  isOpen: boolean;
  onClose: () => void;
  currentBalance: number;
  required: number;
  shortage: number;
}

export default function InsufficientCreditsModal({
  isOpen,
  onClose,
  currentBalance,
  required,
  shortage,
}: Props) {
  const router = useRouter();
  const [dontShowToday, setDontShowToday] = useState(false);

  if (!isOpen) return null;

  const handleClose = () => {
    if (dontShowToday) {
      // å­˜å‚¨åˆ° localStorageï¼Œä»Šæ—¥ä¸å†æ˜¾ç¤º
      const today = new Date().toISOString().split('T')[0];
      localStorage.setItem('hideCreditsWarning', today);
    }
    onClose();
  };

  const handleRecharge = () => {
    // è·³è½¬åˆ°å……å€¼é¡µé¢ï¼ˆé¢„ç•™ï¼‰
    router.push('/pricing');
    handleClose();
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <div className="text-center">
          <div className="text-5xl mb-4">ğŸ’°</div>
          <h2 className="text-2xl font-bold mb-2">ç§¯åˆ†ä¸è¶³</h2>
          <p className="text-gray-600 mb-6">
            å½“å‰æ“ä½œéœ€è¦ <span className="font-bold text-red-500">{required}</span> ç§¯åˆ†ï¼Œ
            æ‚¨çš„ä½™é¢ä¸º <span className="font-bold">{currentBalance}</span> ç§¯åˆ†ï¼Œ
            è¿˜éœ€è¦ <span className="font-bold text-red-500">{shortage}</span> ç§¯åˆ†
          </p>

          <div className="space-y-3">
            <button
              onClick={handleRecharge}
              className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition"
            >
              ğŸ’³ å……å€¼ç§¯åˆ†ï¼ˆå³å°†å¼€æ”¾ï¼‰
            </button>

            <button
              onClick={handleClose}
              className="w-full border border-gray-300 py-3 rounded-lg font-semibold hover:bg-gray-50 transition"
            >
              å–æ¶ˆ
            </button>
          </div>

          <div className="mt-4">
            <label className="flex items-center justify-center text-sm text-gray-500">
              <input
                type="checkbox"
                checked={dontShowToday}
                onChange={(e) => setDontShowToday(e.target.checked)}
                className="mr-2"
              />
              ä»Šæ—¥ä¸å†æé†’
            </label>
          </div>
        </div>
      </div>
    </div>
  );
}
```

---

### 4.3 æˆ‘çš„é‚€è¯·é¡µé¢

#### æ–‡ä»¶: `src/app/[locale]/(default)/(console)/my-invites/page.tsx` (ä¿®æ”¹)

```typescript
'use client';

import { useEffect, useState } from 'react';
import { useSession } from 'next-auth/react';

export default function MyInvitesPage() {
  const { data: session } = useSession();
  const [inviteCode, setInviteCode] = useState('');
  const [invitations, setInvitations] = useState([]);
  const [stats, setStats] = useState({ total: 0, totalRewards: 0 });
  const [copied, setCopied] = useState(false);

  useEffect(() => {
    if (session?.user?.invite_code) {
      setInviteCode(session.user.invite_code);
      fetchInvitations();
    }
  }, [session]);

  const fetchInvitations = async () => {
    const res = await fetch('/api/user/invitations');
    const data = await res.json();
    setInvitations(data.invitations);
    setStats(data.stats);
  };

  const inviteLink = `${window.location.origin}/i/${inviteCode}`;

  const copyLink = () => {
    navigator.clipboard.writeText(inviteLink);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  return (
    <div className="max-w-4xl mx-auto p-6">
      <h1 className="text-3xl font-bold mb-6">æˆ‘çš„é‚€è¯·</h1>

      {/* é‚€è¯·ç»Ÿè®¡ */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
        <div className="bg-blue-50 p-6 rounded-lg">
          <p className="text-sm text-gray-600">ç´¯è®¡é‚€è¯·</p>
          <p className="text-3xl font-bold text-blue-600">{stats.total}</p>
          <p className="text-xs text-gray-500 mt-1">ä¸Šé™ 100 äºº</p>
        </div>

        <div className="bg-green-50 p-6 rounded-lg">
          <p className="text-sm text-gray-600">ç´¯è®¡å¥–åŠ±</p>
          <p className="text-3xl font-bold text-green-600">{stats.totalRewards}</p>
          <p className="text-xs text-gray-500 mt-1">ç§¯åˆ†</p>
        </div>

        <div className="bg-purple-50 p-6 rounded-lg">
          <p className="text-sm text-gray-600">å•æ¬¡å¥–åŠ±</p>
          <p className="text-3xl font-bold text-purple-600">50</p>
          <p className="text-xs text-gray-500 mt-1">ç§¯åˆ†/äºº</p>
        </div>
      </div>

      {/* é‚€è¯·é“¾æ¥ */}
      <div className="bg-white border-2 border-dashed border-blue-300 p-6 rounded-lg mb-8">
        <h2 className="text-lg font-semibold mb-3">æ‚¨çš„ä¸“å±é‚€è¯·é“¾æ¥</h2>
        <div className="flex gap-2">
          <input
            type="text"
            value={inviteLink}
            readOnly
            className="flex-1 p-3 border rounded-lg bg-gray-50"
          />
          <button
            onClick={copyLink}
            className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
          >
            {copied ? 'âœ“ å·²å¤åˆ¶' : 'å¤åˆ¶é“¾æ¥'}
          </button>
        </div>
        <p className="text-sm text-gray-500 mt-3">
          ğŸ’¡ åˆ†äº«æ­¤é“¾æ¥ï¼Œæ¯é‚€è¯·1äººæ³¨å†Œå¯è·å¾— <span className="font-bold text-blue-600">50ç§¯åˆ†</span> å¥–åŠ±
        </p>
      </div>

      {/* é‚€è¯·è®°å½• */}
      <div>
        <h2 className="text-xl font-semibold mb-4">é‚€è¯·è®°å½•</h2>
        {invitations.length === 0 ? (
          <p className="text-center text-gray-500 py-8">æš‚æ— é‚€è¯·è®°å½•</p>
        ) : (
          <div className="space-y-3">
            {invitations.map((invite: any) => (
              <div key={invite.uuid} className="border p-4 rounded-lg flex justify-between items-center">
                <div>
                  <p className="font-semibold">{invite.invitee.email}</p>
                  <p className="text-sm text-gray-500">
                    {new Date(invite.created_at).toLocaleDateString()}
                  </p>
                </div>
                <div className="text-right">
                  <p className="text-green-600 font-bold">+{invite.inviter_reward} ç§¯åˆ†</p>
                  <p className="text-xs text-gray-500">{invite.status}</p>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}
```

---

## ğŸ› ï¸ äº”ã€ç®¡ç†åå°

### 5.1 ç”¨æˆ·ç§¯åˆ†ç®¡ç†é¡µé¢

#### æ–‡ä»¶: `src/app/[locale]/(admin)/admin/credits/page.tsx` (æ–°å»º)

```typescript
'use client';

import { useEffect, useState } from 'react';
import { useSession } from 'next-auth/react';

export default function AdminCreditsPage() {
  const { data: session } = useSession();
  const [users, setUsers] = useState([]);
  const [selectedUser, setSelectedUser] = useState(null);
  const [adjustAmount, setAdjustAmount] = useState(0);
  const [adjustReason, setAdjustReason] = useState('');

  useEffect(() => {
    fetchUsers();
  }, []);

  const fetchUsers = async () => {
    const res = await fetch('/api/admin/credits/users');
    const data = await res.json();
    setUsers(data.users);
  };

  const handleAdjustCredits = async () => {
    if (!selectedUser || adjustAmount === 0) return;

    const res = await fetch('/api/admin/credits/adjust', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        userUuid: selectedUser.uuid,
        amount: adjustAmount,
        reason: adjustReason,
      }),
    });

    if (res.ok) {
      alert('ç§¯åˆ†è°ƒæ•´æˆåŠŸ');
      fetchUsers();
      setSelectedUser(null);
      setAdjustAmount(0);
      setAdjustReason('');
    }
  };

  // ç®¡ç†å‘˜æƒé™æ£€æŸ¥
  if (!session?.user?.is_admin) {
    return <div>æ— æƒé™è®¿é—®</div>;
  }

  return (
    <div className="p-6">
      <h1 className="text-3xl font-bold mb-6">ç”¨æˆ·ç§¯åˆ†ç®¡ç†</h1>

      <div className="bg-white rounded-lg shadow overflow-hidden">
        <table className="min-w-full">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-6 py-3 text-left">ç”¨æˆ·</th>
              <th className="px-6 py-3 text-left">å½“å‰ç§¯åˆ†</th>
              <th className="px-6 py-3 text-left">ç´¯è®¡è·å¾—</th>
              <th className="px-6 py-3 text-left">ç´¯è®¡æ¶ˆè€—</th>
              <th className="px-6 py-3 text-left">é‚€è¯·äººæ•°</th>
              <th className="px-6 py-3 text-left">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody className="divide-y">
            {users.map((user: any) => (
              <tr key={user.uuid}>
                <td className="px-6 py-4">
                  <div>
                    <p className="font-semibold">{user.nickname}</p>
                    <p className="text-sm text-gray-500">{user.email}</p>
                  </div>
                </td>
                <td className="px-6 py-4 font-bold">{user.current_balance}</td>
                <td className="px-6 py-4 text-green-600">+{user.total_earned}</td>
                <td className="px-6 py-4 text-red-600">-{user.total_spent}</td>
                <td className="px-6 py-4">{user.total_invites}</td>
                <td className="px-6 py-4">
                  <button
                    onClick={() => setSelectedUser(user)}
                    className="text-blue-600 hover:underline"
                  >
                    è°ƒæ•´ç§¯åˆ†
                  </button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {/* è°ƒæ•´ç§¯åˆ†å¼¹çª— */}
      {selectedUser && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
          <div className="bg-white p-6 rounded-lg max-w-md w-full">
            <h2 className="text-xl font-bold mb-4">è°ƒæ•´ç”¨æˆ·ç§¯åˆ†</h2>
            <p className="mb-4">
              ç”¨æˆ·: <span className="font-semibold">{selectedUser.email}</span>
            </p>
            <p className="mb-4">
              å½“å‰ç§¯åˆ†: <span className="font-bold">{selectedUser.current_balance}</span>
            </p>

            <div className="space-y-4">
              <div>
                <label className="block mb-2">è°ƒæ•´æ•°é‡</label>
                <input
                  type="number"
                  value={adjustAmount}
                  onChange={(e) => setAdjustAmount(Number(e.target.value))}
                  className="w-full border p-2 rounded"
                  placeholder="æ­£æ•°å¢åŠ ï¼Œè´Ÿæ•°æ‰£é™¤"
                />
              </div>

              <div>
                <label className="block mb-2">è°ƒæ•´åŸå› </label>
                <textarea
                  value={adjustReason}
                  onChange={(e) => setAdjustReason(e.target.value)}
                  className="w-full border p-2 rounded"
                  rows={3}
                />
              </div>

              <div className="flex gap-2">
                <button
                  onClick={handleAdjustCredits}
                  className="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700"
                >
                  ç¡®è®¤è°ƒæ•´
                </button>
                <button
                  onClick={() => setSelectedUser(null)}
                  className="flex-1 border py-2 rounded hover:bg-gray-50"
                >
                  å–æ¶ˆ
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
```

---

### 5.2 ç§¯åˆ†æ¶ˆè€—ç»Ÿè®¡é¡µé¢

#### æ–‡ä»¶: `src/app/[locale]/(admin)/admin/consumption-stats/page.tsx` (æ–°å»º)

```typescript
'use client';

import { useEffect, useState } from 'react';
import { Line } from 'react-chartjs-2';

export default function ConsumptionStatsPage() {
  const [stats, setStats] = useState({
    totalConsumption: 0,
    totalUsers: 0,
    avgPerUser: 0,
    dailyData: [],
  });
  const [recentConsumptions, setRecentConsumptions] = useState([]);

  useEffect(() => {
    fetchStats();
    fetchRecentConsumptions();
  }, []);

  const fetchStats = async () => {
    const res = await fetch('/api/admin/stats/consumption');
    const data = await res.json();
    setStats(data);
  };

  const fetchRecentConsumptions = async () => {
    const res = await fetch('/api/admin/credits/consumptions?limit=50');
    const data = await res.json();
    setRecentConsumptions(data.consumptions);
  };

  return (
    <div className="p-6">
      <h1 className="text-3xl font-bold mb-6">ç§¯åˆ†æ¶ˆè€—ç»Ÿè®¡</h1>

      {/* ç»Ÿè®¡å¡ç‰‡ */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div className="bg-white p-6 rounded-lg shadow">
          <p className="text-gray-600 mb-2">æ€»æ¶ˆè€—ç§¯åˆ†</p>
          <p className="text-4xl font-bold text-red-600">{stats.totalConsumption}</p>
        </div>

        <div className="bg-white p-6 rounded-lg shadow">
          <p className="text-gray-600 mb-2">æ¶ˆè€—ç”¨æˆ·æ•°</p>
          <p className="text-4xl font-bold text-blue-600">{stats.totalUsers}</p>
        </div>

        <div className="bg-white p-6 rounded-lg shadow">
          <p className="text-gray-600 mb-2">äººå‡æ¶ˆè€—</p>
          <p className="text-4xl font-bold text-purple-600">{stats.avgPerUser.toFixed(1)}</p>
        </div>
      </div>

      {/* æ¶ˆè€—è¶‹åŠ¿å›¾ */}
      <div className="bg-white p-6 rounded-lg shadow mb-8">
        <h2 className="text-xl font-semibold mb-4">æ¯æ—¥æ¶ˆè€—è¶‹åŠ¿</h2>
        {/* Chart.js å›¾è¡¨ç»„ä»¶ */}
      </div>

      {/* æœ€è¿‘æ¶ˆè€—è®°å½• */}
      <div className="bg-white rounded-lg shadow">
        <div className="px-6 py-4 border-b">
          <h2 className="text-xl font-semibold">æœ€è¿‘æ¶ˆè€—è®°å½•</h2>
        </div>
        <table className="min-w-full">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-6 py-3 text-left">æ—¶é—´</th>
              <th className="px-6 py-3 text-left">ç”¨æˆ·</th>
              <th className="px-6 py-3 text-left">æ¶ˆè€—ç§¯åˆ†</th>
              <th className="px-6 py-3 text-left">ç±»å‹</th>
              <th className="px-6 py-3 text-left">è¯´æ˜</th>
            </tr>
          </thead>
          <tbody className="divide-y">
            {recentConsumptions.map((record: any) => (
              <tr key={record.uuid}>
                <td className="px-6 py-4 text-sm">
                  {new Date(record.created_at).toLocaleString()}
                </td>
                <td className="px-6 py-4">{record.user_email}</td>
                <td className="px-6 py-4 font-bold text-red-600">
                  {Math.abs(record.amount)}
                </td>
                <td className="px-6 py-4">
                  <span className="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs">
                    {record.type}
                  </span>
                </td>
                <td className="px-6 py-4 text-sm text-gray-600">
                  {record.description}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}
```

---

## ğŸ“¡ å…­ã€APIæ¥å£æ±‡æ€»

### 6.1 ç”¨æˆ·ç«¯API

| æ¥å£è·¯å¾„ | æ–¹æ³• | è¯´æ˜ |
|---------|------|------|
| `/api/auth/register` | POST | ç”¨æˆ·æ³¨å†Œï¼ˆå«é‚€è¯·ç å¤„ç†ï¼‰ |
| `/api/user/credits` | GET | è·å–å½“å‰ç”¨æˆ·ç§¯åˆ†ä½™é¢ |
| `/api/user/credits/transactions` | GET | è·å–ç§¯åˆ†äº¤æ˜“å†å² |
| `/api/user/invitations` | GET | è·å–æˆ‘çš„é‚€è¯·è®°å½• |
| `/api/ai/generate/text-to-3d` | POST | 3Dç”Ÿæˆï¼ˆå«ç§¯åˆ†æ‰£é™¤ï¼‰ |

### 6.2 ç®¡ç†å‘˜API

| æ¥å£è·¯å¾„ | æ–¹æ³• | è¯´æ˜ |
|---------|------|------|
| `/api/admin/credits/users` | GET | è·å–æ‰€æœ‰ç”¨æˆ·ç§¯åˆ†ä¿¡æ¯ |
| `/api/admin/credits/adjust` | POST | æ‰‹åŠ¨è°ƒæ•´ç”¨æˆ·ç§¯åˆ† |
| `/api/admin/credits/consumptions` | GET | è·å–ç§¯åˆ†æ¶ˆè€—è®°å½• |
| `/api/admin/stats/consumption` | GET | è·å–æ¶ˆè€—ç»Ÿè®¡æ•°æ® |
| `/api/admin/invitations` | GET | è·å–æ‰€æœ‰é‚€è¯·è®°å½• |

---

## ğŸ”„ ä¸ƒã€å®æ–½æ­¥éª¤

### Phase 1: æ•°æ®åº“å‡†å¤‡ï¼ˆ1å¤©ï¼‰
1. âœ… æ‰§è¡Œæ•°æ®åº“è¿ç§»è„šæœ¬
2. âœ… éªŒè¯è¡¨ç»“æ„å’Œç´¢å¼•
3. âœ… å¤‡ä»½ç°æœ‰æ•°æ®

### Phase 2: åç«¯æ ¸å¿ƒåŠŸèƒ½ï¼ˆ2-3å¤©ï¼‰
1. âœ… å®ç° `src/services/credits-system.ts`
2. âœ… ä¿®æ”¹æ³¨å†ŒAPIæ”¯æŒé‚€è¯·ç 
3. âœ… ä¿®æ”¹3Dç”ŸæˆAPIæ”¯æŒç§¯åˆ†æ‰£é™¤
4. âœ… å®ç°ç§¯åˆ†é€€æ¬¾é€»è¾‘
5. âœ… ç¼–å†™å•å…ƒæµ‹è¯•

### Phase 3: å‰ç«¯åŠŸèƒ½ï¼ˆ2å¤©ï¼‰
1. âœ… æ³¨å†Œé¡µé¢æ·»åŠ é‚€è¯·ç è¾“å…¥æ¡†
2. âœ… å®ç°ç§¯åˆ†ä¸è¶³å¼¹çª—
3. âœ… å®Œå–„"æˆ‘çš„é‚€è¯·"é¡µé¢
4. âœ… ç”¨æˆ·ç§¯åˆ†æ˜¾ç¤ºç»„ä»¶

### Phase 4: ç®¡ç†åå°ï¼ˆ2å¤©ï¼‰
1. âœ… ç”¨æˆ·ç§¯åˆ†ç®¡ç†é¡µé¢
2. âœ… ç§¯åˆ†æ¶ˆè€—ç»Ÿè®¡é¡µé¢
3. âœ… é‚€è¯·è®°å½•æŸ¥è¯¢é¡µé¢
4. âœ… æ•°æ®å¯¼å‡ºåŠŸèƒ½

### Phase 5: æµ‹è¯•ä¸ä¸Šçº¿ï¼ˆ1-2å¤©ï¼‰
1. âœ… åŠŸèƒ½æµ‹è¯•
2. âœ… è¾¹ç•Œæƒ…å†µæµ‹è¯•
3. âœ… æ€§èƒ½æµ‹è¯•
4. âœ… ç°åº¦å‘å¸ƒ
5. âœ… ç›‘æ§å‘Šè­¦é…ç½®

---

## ğŸ§ª å…«ã€æµ‹è¯•ç”¨ä¾‹

### 8.1 æ³¨å†Œä¸é‚€è¯·æµ‹è¯•

#### æµ‹è¯•åœºæ™¯1: æ™®é€šæ³¨å†Œï¼ˆæ— é‚€è¯·ç ï¼‰
```
è¾“å…¥: { email: "user1@test.com", password: "password123" }
é¢„æœŸç»“æœ:
  - ç”¨æˆ·åˆ›å»ºæˆåŠŸ
  - è·å¾—100ç§¯åˆ†
  - credit_transactions æœ‰1æ¡ type='register' è®°å½•
```

#### æµ‹è¯•åœºæ™¯2: ä½¿ç”¨é‚€è¯·ç æ³¨å†Œ
```
å‰ç½®æ¡ä»¶: é‚€è¯·äºº inviter@test.com (invite_code='ABC12345')
è¾“å…¥: { email: "user2@test.com", password: "password123", inviteCode: "ABC12345" }
é¢„æœŸç»“æœ:
  - æ–°ç”¨æˆ·è·å¾—150ç§¯åˆ†ï¼ˆ100åŸºç¡€+50é‚€è¯·ï¼‰
  - é‚€è¯·äººè·å¾—50ç§¯åˆ†
  - credit_transactions æœ‰3æ¡è®°å½•
  - invitations è¡¨æ–°å¢1æ¡è®°å½•
  - æ–°ç”¨æˆ·çš„ invited_by å­—æ®µä¸ºé‚€è¯·äººUUID
```

#### æµ‹è¯•åœºæ™¯3: é‚€è¯·ä¸Šé™æµ‹è¯•
```
å‰ç½®æ¡ä»¶: é‚€è¯·äººå·²é‚€è¯·100äºº
è¾“å…¥: ç¬¬101äººä½¿ç”¨è¯¥é‚€è¯·ç æ³¨å†Œ
é¢„æœŸç»“æœ:
  - æ–°ç”¨æˆ·ä»…è·å¾—100ç§¯åˆ†ï¼ˆåŸºç¡€å¥–åŠ±ï¼‰
  - é‚€è¯·äººä¸è·å¾—å¥–åŠ±
  - invitations è¡¨ä¸æ–°å¢è®°å½•
```

---

### 8.2 ç§¯åˆ†æ¶ˆè€—æµ‹è¯•

#### æµ‹è¯•åœºæ™¯4: ç§¯åˆ†è¶³å¤Ÿçš„3Dç”Ÿæˆ
```
å‰ç½®æ¡ä»¶: ç”¨æˆ·æœ‰200ç§¯åˆ†
è¾“å…¥: ç”Ÿæˆéœ€è¦50ç§¯åˆ†çš„3Dæ¨¡å‹
é¢„æœŸç»“æœ:
  - æ‰£é™¤50ç§¯åˆ†ï¼Œä½™é¢150
  - credit_transactions æ–°å¢1æ¡ type='consume_3d' è®°å½•
  - ai_generation_records çš„ credits_consumed=50
```

#### æµ‹è¯•åœºæ™¯5: ç§¯åˆ†ä¸è¶³çš„3Dç”Ÿæˆ
```
å‰ç½®æ¡ä»¶: ç”¨æˆ·æœ‰30ç§¯åˆ†
è¾“å…¥: ç”Ÿæˆéœ€è¦50ç§¯åˆ†çš„3Dæ¨¡å‹
é¢„æœŸç»“æœ:
  - è¿”å› 402 çŠ¶æ€ç 
  - ç§¯åˆ†ä¸æ‰£é™¤
  - æç¤ºç§¯åˆ†ä¸è¶³ï¼Œå·®é¢20
```

#### æµ‹è¯•åœºæ™¯6: ç”Ÿæˆå¤±è´¥é€€æ¬¾
```
å‰ç½®æ¡ä»¶: å·²æ‰£é™¤50ç§¯åˆ†ï¼Œè…¾è®¯APIè¿”å›å¤±è´¥
è¾“å…¥: ä»»åŠ¡æŸ¥è¯¢è¿”å› status='FAIL'
é¢„æœŸç»“æœ:
  - é€€è¿˜50ç§¯åˆ†
  - credit_transactions æ–°å¢1æ¡ type='refund' è®°å½•
  - ai_generation_records çš„ credits_refunded=50
```

---

### 8.3 ç®¡ç†åå°æµ‹è¯•

#### æµ‹è¯•åœºæ™¯7: ç®¡ç†å‘˜æ‰‹åŠ¨è°ƒæ•´ç§¯åˆ†
```
å‰ç½®æ¡ä»¶: ç®¡ç†å‘˜ç™»å½•ï¼Œé€‰æ‹©ç”¨æˆ·Aï¼ˆå½“å‰100ç§¯åˆ†ï¼‰
è¾“å…¥: è°ƒæ•´+50ç§¯åˆ†ï¼ŒåŸå› ="æ´»åŠ¨å¥–åŠ±"
é¢„æœŸç»“æœ:
  - ç”¨æˆ·Aç§¯åˆ†å˜ä¸º150
  - credit_transactions æ–°å¢1æ¡ type='admin_adjust' è®°å½•
```

---

## ğŸ“Š ä¹ã€æ•°æ®ç›‘æ§æŒ‡æ ‡

### 9.1 æ ¸å¿ƒæŒ‡æ ‡

| æŒ‡æ ‡åç§° | è¯´æ˜ | å‘Šè­¦é˜ˆå€¼ |
|---------|------|---------|
| æ—¥æ–°å¢ç”¨æˆ· | æ¯æ—¥æ³¨å†Œç”¨æˆ·æ•° | - |
| é‚€è¯·è½¬åŒ–ç‡ | ä½¿ç”¨é‚€è¯·ç æ³¨å†Œæ¯”ä¾‹ | < 20% éœ€ä¼˜åŒ– |
| äººå‡ç§¯åˆ†æ¶ˆè€— | ç”¨æˆ·å¹³å‡æ¶ˆè€—ç§¯åˆ† | - |
| ç§¯åˆ†ä½™é¢é¢„è­¦ | ç§¯åˆ†ä¸è¶³æ‹¦æˆªæ¬¡æ•° | > 100æ¬¡/å¤© |
| é€€æ¬¾ç‡ | ç”Ÿæˆå¤±è´¥é€€æ¬¾æ¯”ä¾‹ | > 10% éœ€æ’æŸ¥ |

### 9.2 SQLæŸ¥è¯¢ç¤ºä¾‹

#### æŸ¥è¯¢ä»Šæ—¥æ³¨å†Œç”¨æˆ·æ•°
```sql
SELECT COUNT(*) as today_users
FROM users
WHERE DATE(created_at) = CURRENT_DATE;
```

#### æŸ¥è¯¢é‚€è¯·è½¬åŒ–ç‡
```sql
SELECT
  COUNT(DISTINCT invitee_uuid)::FLOAT / COUNT(DISTINCT uuid) * 100 as invite_rate
FROM users
WHERE created_at >= CURRENT_DATE - INTERVAL '7 days';
```

#### æŸ¥è¯¢TOP10ç§¯åˆ†æ¶ˆè€—ç”¨æˆ·
```sql
SELECT
  u.email,
  u.nickname,
  SUM(ABS(ct.amount)) as total_consumption
FROM credit_transactions ct
JOIN users u ON ct.user_uuid = u.uuid
WHERE ct.type = 'consume_3d'
GROUP BY u.uuid, u.email, u.nickname
ORDER BY total_consumption DESC
LIMIT 10;
```

---

## ğŸ” åã€å®‰å…¨ä¸é£æ§

### 10.1 åä½œå¼Šæœºåˆ¶

#### 1. IPé™åˆ¶
- åŒä¸€IP 24å°æ—¶å†…æœ€å¤šæ³¨å†Œ3ä¸ªè´¦å·
- å®ç°: åœ¨æ³¨å†Œæ—¶è®°å½• `signin_ip`ï¼ŒæŸ¥è¯¢é™åˆ¶

#### 2. é‚€è¯·ä¸Šé™
- å•ç”¨æˆ·æœ€å¤šé‚€è¯·100äºº
- å®ç°: å·²åœ¨ `handleRegisterReward` ä¸­å®ç°

#### 3. ç§¯åˆ†å¼‚å¸¸ç›‘æ§
- å•ç”¨æˆ·å•æ—¥ç§¯åˆ†å˜åŠ¨è¶…è¿‡1000è‡ªåŠ¨æ ‡è®°
- å®ç°: å®šæ—¶ä»»åŠ¡æ‰«æ `credit_transactions`

### 10.2 æ•°æ®ä¸€è‡´æ€§ä¿éšœ

#### 1. æ•°æ®åº“äº‹åŠ¡
- æ‰€æœ‰ç§¯åˆ†æ“ä½œä½¿ç”¨ `db.transaction`
- ç¡®ä¿ç§¯åˆ†æ‰£é™¤å’Œè®°å½•åˆ›å»ºåŸå­æ€§

#### 2. ä½™é¢æ ¡éªŒ
- å®šæœŸå¯¹æ¯” `users.credits` å’Œ `credit_transactions` æ±‡æ€»
- SQLè„šæœ¬:
```sql
SELECT
  u.uuid,
  u.credits as db_balance,
  COALESCE(SUM(ct.amount), 0) as calculated_balance,
  u.credits - COALESCE(SUM(ct.amount), 0) as diff
FROM users u
LEFT JOIN credit_transactions ct ON u.uuid = ct.user_uuid
GROUP BY u.uuid, u.credits
HAVING u.credits != COALESCE(SUM(ct.amount), 0);
```

---

## ğŸ“ åä¸€ã€åç»­ä¼˜åŒ–æ–¹å‘

### 11.1 åŠŸèƒ½æ‰©å±•
1. **ç§¯åˆ†å……å€¼ç³»ç»Ÿ**
   - æ¥å…¥æ”¯ä»˜ç½‘å…³ï¼ˆStripe/å¾®ä¿¡æ”¯ä»˜ï¼‰
   - å……å€¼æ¡£ä½é…ç½®
   - å……å€¼ä¼˜æƒ æ´»åŠ¨

2. **ç§¯åˆ†ç­‰çº§ä½“ç³»**
   - VIPç­‰çº§ï¼ˆæ¶ˆè´¹æ»¡Xç§¯åˆ†å‡çº§ï¼‰
   - ç­‰çº§ä¸“å±æƒç›Š
   - ç§¯åˆ†åŠ æˆ

3. **é‚€è¯·æ’è¡Œæ¦œ**
   - å‘¨/æœˆé‚€è¯·æ’è¡Œ
   - é¢å¤–å¥–åŠ±æœºåˆ¶

4. **ç§¯åˆ†å…‘æ¢å•†åŸ**
   - å®ç‰©/è™šæ‹Ÿå•†å“å…‘æ¢
   - åº“å­˜ç®¡ç†

### 11.2 æ€§èƒ½ä¼˜åŒ–
1. **ç¼“å­˜ç­–ç•¥**
   - Redisç¼“å­˜ç”¨æˆ·ç§¯åˆ†ä½™é¢
   - å‡å°‘æ•°æ®åº“æŸ¥è¯¢

2. **å¼‚æ­¥å¤„ç†**
   - ç§¯åˆ†å‘æ”¾å¼‚æ­¥åŒ–ï¼ˆé˜Ÿåˆ—ï¼‰
   - å‡å°‘æ³¨å†Œå“åº”æ—¶é—´

3. **æ•°æ®å½’æ¡£**
   - å†å²äº¤æ˜“è®°å½•å®šæœŸå½’æ¡£
   - ä¿æŒä¸»è¡¨æ€§èƒ½

---

## ğŸ“š åäºŒã€é™„å½•

### 12.1 å¸¸é‡é…ç½®æ–‡ä»¶

#### æ–‡ä»¶: `src/config/credits.ts`

```typescript
export const CREDITS_CONFIG = {
  // ç§¯åˆ†å¥–åŠ±
  REGISTER_REWARD: 100,
  INVITE_REWARD_INVITER: 50,
  INVITE_REWARD_INVITEE: 50,

  // é™åˆ¶
  MAX_INVITES_PER_USER: 100,
  MAX_DAILY_REGISTRATIONS_PER_IP: 3,

  // 3Dç”Ÿæˆé¢„ä¼°ç§¯åˆ†ï¼ˆç”¨äºå‰ç«¯å±•ç¤ºï¼‰
  ESTIMATE_3D_BASIC: 0,      // åŸºç¡€ç‰ˆæš‚æ— ç§¯åˆ†è®¡è´¹
  ESTIMATE_3D_PRO_MIN: 15,   // ä¸“ä¸šç‰ˆæœ€ä½
  ESTIMATE_3D_PRO_MAX: 55,   // ä¸“ä¸šç‰ˆæœ€é«˜
  ESTIMATE_3D_RAPID_MIN: 10, // æé€Ÿç‰ˆæœ€ä½
  ESTIMATE_3D_RAPID_MAX: 15, // æé€Ÿç‰ˆæœ€é«˜
} as const;

export const CREDIT_TRANSACTION_DESCRIPTIONS = {
  register: 'æ–°ç”¨æˆ·æ³¨å†Œå¥–åŠ±',
  invite_reward: 'é‚€è¯·å¥½å‹æ³¨å†Œå¥–åŠ±',
  invite_new_user: 'ä½¿ç”¨é‚€è¯·ç æ³¨å†Œé¢å¤–å¥–åŠ±',
  consume_3d: '3Dæ¨¡å‹ç”Ÿæˆæ¶ˆè€—',
  refund: 'ç”Ÿæˆå¤±è´¥é€€æ¬¾',
  admin_adjust: 'ç®¡ç†å‘˜æ‰‹åŠ¨è°ƒæ•´',
  purchase: 'å……å€¼è´­ä¹°',
} as const;
```

---

### 12.2 ç±»å‹å®šä¹‰æ–‡ä»¶

#### æ–‡ä»¶: `src/types/credits.d.ts`

```typescript
export interface CreditTransaction {
  id: number;
  uuid: string;
  user_uuid: string;
  type: 'register' | 'invite_reward' | 'invite_new_user' | 'consume_3d' | 'refund' | 'admin_adjust' | 'purchase';
  amount: number;
  balance_after: number;
  related_user_uuid?: string;
  related_record_uuid?: string;
  order_no?: string;
  description: string;
  metadata?: any;
  created_at: Date;
}

export interface Invitation {
  id: number;
  uuid: string;
  inviter_uuid: string;
  invitee_uuid: string;
  invitation_code: string;
  inviter_reward: number;
  invitee_reward: number;
  status: 'completed' | 'cancelled';
  created_at: Date;
}

export interface CreditCheckResult {
  sufficient: boolean;
  currentBalance: number;
  required: number;
  shortage?: number;
}
```

**æŠ€æœ¯äº®ç‚¹**:
- åŸºäºç°æœ‰ `shipany-docs/17-é‚€è¯·è¿”ä½£.md` æœºåˆ¶æ‰©å±•
- ä¿æŒä¸ç°æœ‰ `affiliates` è¡¨å…¼å®¹
- æ–°å¢ç‹¬ç«‹ `credit_transactions` å’Œ `invitations` è¡¨
- ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ä¿è¯ä¸€è‡´æ€§
- é¢„ç•™å……å€¼ã€ç­‰çº§ç­‰æ‰©å±•åŠŸèƒ½

**é¢„ä¼°å·¥ä½œé‡**: 8-10 äººå¤©

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-10-18
**å®¡æ ¸çŠ¶æ€**: å¾…å®¡æ ¸
