# 积分与邀请系统完整技术方案

## 📋 版本信息
- **文档版本**: v1.0
- **创建日期**: 2025-10-18
- **项目**: 好朋友 AI 造物平台
- **关联文档**: `shipany-docs/17-邀请返佣.md`, `腾讯混元3D_API接口文档.md`

---

## 🎯 一、需求概述

### 1.1 核心功能

#### ✅ 积分赠送机制
- **默认注册奖励**: 新用户注册获得 **100 积分**
- **邀请注册奖励**:
  - 新用户获得: **100（基础）+ 50（邀请奖励）= 150 积分**
  - 邀请人获得: **50 积分** 奖励
  - 奖励发放时机: **注册时立即发放**（无需等待激活）

#### 🔑 邀请码系统
- 每个用户拥有唯一邀请码（8位字符，基于 UUID 生成）
- 注册时可选填写邀请码
- 邀请关系追踪（记录谁邀请了谁）
- **单用户邀请上限**: 100人（防止恶意刷邀请）

#### 💰 积分消耗机制
- 对接腾讯混元 3D API
- 根据 API 实际返回的消耗量扣除积分（1:1 对应）
- 积分不足时生成前弹窗提示，引导充值
- **生成失败返还积分**（与腾讯混元 3D 机制一致）

#### 💳 积分充值功能（预留）
- 用户可付费充值积分（暂不实现，预留接口）
- 充值档位和价格后续开放

#### ⏰ 积分有效期
- 赠送积分：**永久有效**
- 邀请积分：**永久有效**
- 充值积分：**永久有效**
- 所有积分统一归类，无过期机制

#### 📊 管理后台功能
- 用户积分消耗列表
- 用户邀请记录查询
- 积分手动调整功能
- 消耗统计和数据分析

---

## 🗄️ 二、数据库设计

### 2.1 现有表结构分析

#### `users` 表（已存在）
```sql
-- 现有字段
id: integer (主键)
uuid: varchar(255) UNIQUE
email: varchar(255)
credits: integer DEFAULT 0              -- ✅ 已有积分余额字段
invite_code: varchar(255) DEFAULT ''    -- ✅ 已有邀请码字段
invited_by: varchar(255) DEFAULT ''     -- ✅ 已有邀请人字段
created_at: timestamp
...
```

**✅ 状态**: 字段完备，无需修改

---

### 2.2 新增表结构

#### 2.2.1 `credit_transactions` 表（新增积分记录表）

**说明**: 现有 `credits` 表仅记录订单充值，需新增通用积分交易表

```sql
CREATE TABLE credit_transactions (
  id SERIAL PRIMARY KEY,
  uuid VARCHAR(255) NOT NULL UNIQUE,
  user_uuid VARCHAR(255) NOT NULL,

  -- 交易类型
  type VARCHAR(50) NOT NULL,              -- 'register', 'invite_reward', 'invite_new_user', 'consume_3d', 'refund', 'admin_adjust', 'purchase'
  amount INTEGER NOT NULL,                -- 积分变动（正数=增加，负数=扣除）
  balance_after INTEGER NOT NULL,         -- 操作后的积分余额（冗余字段，便于对账）

  -- 关联信息
  related_user_uuid VARCHAR(255),         -- 关联用户（邀请场景为被邀请人/邀请人）
  related_record_uuid VARCHAR(255),       -- 关联记录（3D生成记录、订单等）
  order_no VARCHAR(255),                  -- 关联订单号（充值场景）

  -- 描述信息
  description TEXT,                       -- 交易说明
  metadata JSON,                          -- 扩展元数据（存储额外信息）

  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

  INDEX idx_user_uuid (user_uuid),
  INDEX idx_type (type),
  INDEX idx_created_at (created_at)
);
```

**积分类型 (type) 枚举**:
```typescript
enum CreditTransactionType {
  Register = 'register',              // 注册奖励
  InviteReward = 'invite_reward',     // 邀请他人奖励
  InviteNewUser = 'invite_new_user',  // 被邀请人奖励
  Consume3D = 'consume_3d',           // 3D生成消耗
  Refund = 'refund',                  // 生成失败退款
  AdminAdjust = 'admin_adjust',       // 管理员手动调整
  Purchase = 'purchase',              // 购买充值（预留）
}
```

---

#### 2.2.2 `invitations` 表（新增邀请记录表）

**说明**: 现有 `affiliates` 表仅记录支付关联，需独立邀请表

```sql
CREATE TABLE invitations (
  id SERIAL PRIMARY KEY,
  uuid VARCHAR(255) NOT NULL UNIQUE,

  -- 邀请关系
  inviter_uuid VARCHAR(255) NOT NULL,     -- 邀请人UUID
  invitee_uuid VARCHAR(255) NOT NULL,     -- 被邀请人UUID
  invitation_code VARCHAR(255) NOT NULL,  -- 使用的邀请码

  -- 奖励信息
  inviter_reward INTEGER NOT NULL,        -- 邀请人获得积分（50）
  invitee_reward INTEGER NOT NULL,        -- 被邀请人获得积分（50）

  -- 状态追踪
  status VARCHAR(50) NOT NULL DEFAULT 'completed',  -- 'completed', 'cancelled'

  -- 时间记录
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

  INDEX idx_inviter (inviter_uuid),
  INDEX idx_invitee (invitee_uuid),
  UNIQUE constraint_unique_invitee (invitee_uuid)   -- 每个用户只能被邀请一次
);
```

---

#### 2.2.3 扩展 `ai_generation_records` 表

**说明**: 现有表已有基础字段，需新增积分消耗字段

```sql
ALTER TABLE ai_generation_records ADD COLUMN IF NOT EXISTS
  credits_consumed INTEGER DEFAULT 0,              -- 实际消耗积分（API返回）
  credits_refunded INTEGER DEFAULT 0,              -- 退还积分（失败场景）
  credits_transaction_uuid VARCHAR(255);           -- 关联积分交易记录UUID
```

---

### 2.3 数据库迁移脚本

#### 迁移文件: `migrations/001_credits_invitation_system.sql`

```sql
-- ============================================
-- 积分与邀请系统数据库迁移
-- 版本: v1.0
-- 日期: 2025-10-18
-- ============================================

-- 1. 创建积分交易记录表
CREATE TABLE IF NOT EXISTS credit_transactions (
  id SERIAL PRIMARY KEY,
  uuid VARCHAR(255) NOT NULL UNIQUE,
  user_uuid VARCHAR(255) NOT NULL,
  type VARCHAR(50) NOT NULL,
  amount INTEGER NOT NULL,
  balance_after INTEGER NOT NULL,
  related_user_uuid VARCHAR(255),
  related_record_uuid VARCHAR(255),
  order_no VARCHAR(255),
  description TEXT,
  metadata JSON,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_credit_transactions_user ON credit_transactions(user_uuid);
CREATE INDEX idx_credit_transactions_type ON credit_transactions(type);
CREATE INDEX idx_credit_transactions_created ON credit_transactions(created_at);

-- 2. 创建邀请记录表
CREATE TABLE IF NOT EXISTS invitations (
  id SERIAL PRIMARY KEY,
  uuid VARCHAR(255) NOT NULL UNIQUE,
  inviter_uuid VARCHAR(255) NOT NULL,
  invitee_uuid VARCHAR(255) NOT NULL,
  invitation_code VARCHAR(255) NOT NULL,
  inviter_reward INTEGER NOT NULL DEFAULT 50,
  invitee_reward INTEGER NOT NULL DEFAULT 50,
  status VARCHAR(50) NOT NULL DEFAULT 'completed',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_invitations_inviter ON invitations(inviter_uuid);
CREATE INDEX idx_invitations_invitee ON invitations(invitee_uuid);
ALTER TABLE invitations ADD CONSTRAINT unique_invitee UNIQUE (invitee_uuid);

-- 3. 扩展 ai_generation_records 表
ALTER TABLE ai_generation_records
  ADD COLUMN IF NOT EXISTS credits_consumed INTEGER DEFAULT 0,
  ADD COLUMN IF NOT EXISTS credits_refunded INTEGER DEFAULT 0,
  ADD COLUMN IF NOT EXISTS credits_transaction_uuid VARCHAR(255);

-- 4. 更新现有用户的邀请码（如果为空）
UPDATE users
SET invite_code = SUBSTRING(MD5(RANDOM()::text), 1, 8)
WHERE invite_code = '' OR invite_code IS NULL;

-- 5. 创建查询邀请统计的视图（便于管理后台）
CREATE OR REPLACE VIEW invitation_stats AS
SELECT
  u.uuid as user_uuid,
  u.email,
  u.nickname,
  u.credits,
  u.invite_code,
  COUNT(DISTINCT i.invitee_uuid) as total_invites,
  COALESCE(SUM(i.inviter_reward), 0) as total_invite_rewards
FROM users u
LEFT JOIN invitations i ON u.uuid = i.inviter_uuid AND i.status = 'completed'
GROUP BY u.uuid, u.email, u.nickname, u.credits, u.invite_code;

-- 6. 创建用户积分消耗统计视图
CREATE OR REPLACE VIEW user_credits_summary AS
SELECT
  u.uuid as user_uuid,
  u.email,
  u.nickname,
  u.credits as current_balance,
  COALESCE(SUM(CASE WHEN ct.amount > 0 THEN ct.amount ELSE 0 END), 0) as total_earned,
  COALESCE(SUM(CASE WHEN ct.amount < 0 THEN ABS(ct.amount) ELSE 0 END), 0) as total_spent,
  COUNT(CASE WHEN ct.type = 'consume_3d' THEN 1 END) as generation_count
FROM users u
LEFT JOIN credit_transactions ct ON u.uuid = ct.user_uuid
GROUP BY u.uuid, u.email, u.nickname, u.credits;

COMMENT ON TABLE credit_transactions IS '积分交易记录表 - 记录所有积分变动';
COMMENT ON TABLE invitations IS '邀请记录表 - 记录用户邀请关系';
COMMENT ON VIEW invitation_stats IS '邀请统计视图 - 用于管理后台展示';
COMMENT ON VIEW user_credits_summary IS '用户积分汇总视图 - 用于管理后台统计';
```

---

## 💻 三、后端实现

### 3.1 数据模型定义

#### 文件: `src/db/schema.ts`

```typescript
// 在现有 schema.ts 中新增以下表定义

// 积分交易记录表
export const creditTransactions = pgTable("credit_transactions", {
  id: integer().primaryKey().generatedAlwaysAsIdentity(),
  uuid: varchar({ length: 255 }).notNull().unique(),
  user_uuid: varchar({ length: 255 }).notNull(),
  type: varchar({ length: 50 }).notNull(),
  amount: integer().notNull(),
  balance_after: integer().notNull(),
  related_user_uuid: varchar({ length: 255 }),
  related_record_uuid: varchar({ length: 255 }),
  order_no: varchar({ length: 255 }),
  description: text(),
  metadata: json(),
  created_at: timestamp({ withTimezone: true }).defaultNow(),
}, (table) => [
  index("credit_transactions_user_idx").on(table.user_uuid),
  index("credit_transactions_type_idx").on(table.type),
  index("credit_transactions_created_idx").on(table.created_at),
]);

// 邀请记录表
export const invitations = pgTable("invitations", {
  id: integer().primaryKey().generatedAlwaysAsIdentity(),
  uuid: varchar({ length: 255 }).notNull().unique(),
  inviter_uuid: varchar({ length: 255 }).notNull(),
  invitee_uuid: varchar({ length: 255 }).notNull(),
  invitation_code: varchar({ length: 255 }).notNull(),
  inviter_reward: integer().notNull().default(50),
  invitee_reward: integer().notNull().default(50),
  status: varchar({ length: 50 }).notNull().default('completed'),
  created_at: timestamp({ withTimezone: true }).defaultNow(),
}, (table) => [
  index("invitations_inviter_idx").on(table.inviter_uuid),
  index("invitations_invitee_idx").on(table.invitee_uuid),
  unique("unique_invitee").on(table.invitee_uuid),
]);

// 扩展 ai_generation_records 表
export const aiGenerationRecords = pgTable("ai_generation_records", {
  // ... 现有字段 ...
  credits_consumed: integer().default(0),
  credits_refunded: integer().default(0),
  credits_transaction_uuid: varchar({ length: 255 }),
});
```

---

### 3.2 业务逻辑层

#### 文件: `src/services/credits-system.ts` （新建）

```typescript
import { db } from '@/db';
import { users, creditTransactions, invitations } from '@/db/schema';
import { eq, sql, desc } from 'drizzle-orm';
import { getUuid } from '@/lib/hash';

// ==================== 常量定义 ====================

export const CREDITS_CONFIG = {
  REGISTER_REWARD: 100,        // 注册奖励
  INVITE_REWARD_INVITER: 50,   // 邀请人奖励
  INVITE_REWARD_INVITEE: 50,   // 被邀请人奖励
  MAX_INVITES_PER_USER: 100,   // 单用户邀请上限
} as const;

export enum CreditTransactionType {
  Register = 'register',
  InviteReward = 'invite_reward',
  InviteNewUser = 'invite_new_user',
  Consume3D = 'consume_3d',
  Refund = 'refund',
  AdminAdjust = 'admin_adjust',
  Purchase = 'purchase',
}

// ==================== 积分操作核心函数 ====================

/**
 * 增加用户积分（通用函数）
 */
export async function addCredits({
  userUuid,
  amount,
  type,
  description,
  relatedUserUuid,
  relatedRecordUuid,
  orderNo,
  metadata,
}: {
  userUuid: string;
  amount: number;
  type: CreditTransactionType;
  description: string;
  relatedUserUuid?: string;
  relatedRecordUuid?: string;
  orderNo?: string;
  metadata?: any;
}) {
  return await db.transaction(async (tx) => {
    // 1. 更新用户积分余额
    const [updatedUser] = await tx
      .update(users)
      .set({
        credits: sql`${users.credits} + ${amount}`,
      })
      .where(eq(users.uuid, userUuid))
      .returning();

    if (!updatedUser) {
      throw new Error('用户不存在');
    }

    // 2. 创建积分交易记录
    const [transaction] = await tx
      .insert(creditTransactions)
      .values({
        uuid: getUuid(),
        user_uuid: userUuid,
        type,
        amount,
        balance_after: updatedUser.credits,
        related_user_uuid: relatedUserUuid,
        related_record_uuid: relatedRecordUuid,
        order_no: orderNo,
        description,
        metadata: metadata ? JSON.stringify(metadata) : null,
        created_at: new Date(),
      })
      .returning();

    return {
      transaction,
      newBalance: updatedUser.credits,
    };
  });
}

/**
 * 扣除用户积分（用于3D生成消耗）
 */
export async function deductCredits({
  userUuid,
  amount,
  type,
  description,
  relatedRecordUuid,
  metadata,
}: {
  userUuid: string;
  amount: number;
  type: CreditTransactionType;
  description: string;
  relatedRecordUuid?: string;
  metadata?: any;
}) {
  return await db.transaction(async (tx) => {
    // 1. 检查用户积分是否足够
    const [user] = await tx
      .select()
      .from(users)
      .where(eq(users.uuid, userUuid))
      .limit(1);

    if (!user) {
      throw new Error('用户不存在');
    }

    if (user.credits < amount) {
      throw new Error('积分不足');
    }

    // 2. 扣除积分
    const [updatedUser] = await tx
      .update(users)
      .set({
        credits: sql`${users.credits} - ${amount}`,
      })
      .where(eq(users.uuid, userUuid))
      .returning();

    // 3. 创建积分交易记录
    const [transaction] = await tx
      .insert(creditTransactions)
      .values({
        uuid: getUuid(),
        user_uuid: userUuid,
        type,
        amount: -amount, // 负数表示扣除
        balance_after: updatedUser.credits,
        related_record_uuid: relatedRecordUuid,
        description,
        metadata: metadata ? JSON.stringify(metadata) : null,
        created_at: new Date(),
      })
      .returning();

    return {
      transaction,
      newBalance: updatedUser.credits,
    };
  });
}

// ==================== 注册与邀请逻辑 ====================

/**
 * 处理用户注册积分奖励
 */
export async function handleRegisterReward({
  userUuid,
  inviteCode,
}: {
  userUuid: string;
  inviteCode?: string;
}) {
  return await db.transaction(async (tx) => {
    // 1. 发放注册基础奖励（100积分）
    await addCredits({
      userUuid,
      amount: CREDITS_CONFIG.REGISTER_REWARD,
      type: CreditTransactionType.Register,
      description: '新用户注册奖励',
    });

    // 2. 处理邀请码逻辑
    if (inviteCode) {
      // 2.1 查找邀请人
      const [inviter] = await tx
        .select()
        .from(users)
        .where(eq(users.invite_code, inviteCode))
        .limit(1);

      if (!inviter) {
        console.warn(`邀请码不存在: ${inviteCode}`);
        return { invited: false };
      }

      // 2.2 检查邀请人邀请数量上限
      const inviteCount = await tx
        .select({ count: sql<number>`count(*)` })
        .from(invitations)
        .where(eq(invitations.inviter_uuid, inviter.uuid));

      if (inviteCount[0].count >= CREDITS_CONFIG.MAX_INVITES_PER_USER) {
        console.warn(`邀请人已达上限: ${inviter.email}`);
        return { invited: false, reason: 'inviter_limit_reached' };
      }

      // 2.3 更新被邀请人的 invited_by 字段
      await tx
        .update(users)
        .set({ invited_by: inviter.uuid })
        .where(eq(users.uuid, userUuid));

      // 2.4 发放被邀请人额外奖励（50积分）
      await addCredits({
        userUuid,
        amount: CREDITS_CONFIG.INVITE_REWARD_INVITEE,
        type: CreditTransactionType.InviteNewUser,
        description: '使用邀请码注册奖励',
        relatedUserUuid: inviter.uuid,
      });

      // 2.5 发放邀请人奖励（50积分）
      await addCredits({
        userUuid: inviter.uuid,
        amount: CREDITS_CONFIG.INVITE_REWARD_INVITER,
        type: CreditTransactionType.InviteReward,
        description: `邀请新用户奖励`,
        relatedUserUuid: userUuid,
      });

      // 2.6 创建邀请记录
      await tx.insert(invitations).values({
        uuid: getUuid(),
        inviter_uuid: inviter.uuid,
        invitee_uuid: userUuid,
        invitation_code: inviteCode,
        inviter_reward: CREDITS_CONFIG.INVITE_REWARD_INVITER,
        invitee_reward: CREDITS_CONFIG.INVITE_REWARD_INVITEE,
        status: 'completed',
        created_at: new Date(),
      });

      return {
        invited: true,
        inviterEmail: inviter.email,
        inviterReward: CREDITS_CONFIG.INVITE_REWARD_INVITER,
        inviteeReward: CREDITS_CONFIG.INVITE_REWARD_INVITEE,
      };
    }

    return { invited: false };
  });
}

// ==================== 3D生成积分消耗 ====================

/**
 * 3D生成前检查积分并预扣
 */
export async function check3DGenerationCredits({
  userUuid,
  estimatedCredits,
}: {
  userUuid: string;
  estimatedCredits: number;
}) {
  const [user] = await db
    .select()
    .from(users)
    .where(eq(users.uuid, userUuid))
    .limit(1);

  if (!user) {
    throw new Error('用户不存在');
  }

  if (user.credits < estimatedCredits) {
    return {
      sufficient: false,
      currentBalance: user.credits,
      required: estimatedCredits,
      shortage: estimatedCredits - user.credits,
    };
  }

  return {
    sufficient: true,
    currentBalance: user.credits,
    required: estimatedCredits,
  };
}

/**
 * 3D生成成功后扣除实际积分
 */
export async function consume3DGenerationCredits({
  userUuid,
  recordUuid,
  actualCredits,
  metadata,
}: {
  userUuid: string;
  recordUuid: string;
  actualCredits: number;
  metadata?: any;
}) {
  return await deductCredits({
    userUuid,
    amount: actualCredits,
    type: CreditTransactionType.Consume3D,
    description: `3D模型生成消耗（${actualCredits}积分）`,
    relatedRecordUuid: recordUuid,
    metadata,
  });
}

/**
 * 3D生成失败退还积分
 */
export async function refund3DGenerationCredits({
  userUuid,
  recordUuid,
  refundAmount,
  reason,
}: {
  userUuid: string;
  recordUuid: string;
  refundAmount: number;
  reason: string;
}) {
  return await addCredits({
    userUuid,
    amount: refundAmount,
    type: CreditTransactionType.Refund,
    description: `3D生成失败退款: ${reason}`,
    relatedRecordUuid: recordUuid,
  });
}

// ==================== 查询函数 ====================

/**
 * 获取用户积分交易历史
 */
export async function getUserCreditTransactions({
  userUuid,
  page = 1,
  limit = 50,
}: {
  userUuid: string;
  page?: number;
  limit?: number;
}) {
  const offset = (page - 1) * limit;

  const transactions = await db
    .select()
    .from(creditTransactions)
    .where(eq(creditTransactions.user_uuid, userUuid))
    .orderBy(desc(creditTransactions.created_at))
    .limit(limit)
    .offset(offset);

  const total = await db
    .select({ count: sql<number>`count(*)` })
    .from(creditTransactions)
    .where(eq(creditTransactions.user_uuid, userUuid));

  return {
    transactions,
    pagination: {
      page,
      limit,
      total: total[0].count,
      totalPages: Math.ceil(total[0].count / limit),
    },
  };
}

/**
 * 获取用户邀请记录
 */
export async function getUserInvitations({
  userUuid,
  page = 1,
  limit = 50,
}: {
  userUuid: string;
  page?: number;
  limit?: number;
}) {
  const offset = (page - 1) * limit;

  const invites = await db
    .select({
      invitation: invitations,
      invitee: users,
    })
    .from(invitations)
    .leftJoin(users, eq(invitations.invitee_uuid, users.uuid))
    .where(eq(invitations.inviter_uuid, userUuid))
    .orderBy(desc(invitations.created_at))
    .limit(limit)
    .offset(offset);

  const total = await db
    .select({ count: sql<number>`count(*)` })
    .from(invitations)
    .where(eq(invitations.inviter_uuid, userUuid));

  return {
    invitations: invites,
    pagination: {
      page,
      limit,
      total: total[0].count,
      totalPages: Math.ceil(total[0].count / limit),
    },
  };
}
```

---

### 3.3 修改注册逻辑

#### 文件: `src/app/api/auth/register/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { db } from '@/db';
import { users } from '@/db/schema';
import { eq } from 'drizzle-orm';
import { encryptPassword, validatePasswordStrength } from '@/lib/password';
import { getUuid } from '@/lib/hash';
import { v4 as uuidv4 } from 'uuid';
import { handleRegisterReward } from '@/services/credits-system';

export async function POST(req: NextRequest) {
  try {
    const { email, password, nickname, inviteCode } = await req.json();

    // 1. 验证输入
    if (!email || !password) {
      return NextResponse.json(
        { error: '邮箱和密码不能为空' },
        { status: 400 }
      );
    }

    // 验证邮箱格式
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      return NextResponse.json(
        { error: '邮箱格式不正确' },
        { status: 400 }
      );
    }

    // 验证密码强度
    const passwordValidation = validatePasswordStrength(password);
    if (!passwordValidation.valid) {
      return NextResponse.json(
        { error: passwordValidation.message },
        { status: 400 }
      );
    }

    // 2. 检查邮箱是否已存在
    const existingUser = await db
      .select()
      .from(users)
      .where(eq(users.email, email.toLowerCase()))
      .limit(1);

    if (existingUser.length > 0) {
      return NextResponse.json(
        { error: '该邮箱已被注册' },
        { status: 400 }
      );
    }

    // 3. 加密密码
    const passwordEncrypted = encryptPassword(password);

    // 4. 生成唯一邀请码
    const userInviteCode = uuidv4().substring(0, 8);
    const userUuid = getUuid();

    // 5. 创建用户（初始积分为0，后续通过积分系统发放）
    const newUser = await db.insert(users).values({
      uuid: userUuid,
      email: email.toLowerCase(),
      nickname: nickname || email.split('@')[0],
      password_encrypted: passwordEncrypted,
      account_type: 'email',
      credits: 0, // 初始为0，由积分系统统一管理
      invite_code: userInviteCode,
      signin_type: 'credentials',
      signin_provider: 'email',
      created_at: new Date(),
    }).returning();

    // 6. 发放注册奖励和处理邀请逻辑
    const rewardResult = await handleRegisterReward({
      userUuid: newUser[0].uuid,
      inviteCode: inviteCode || undefined,
    });

    console.log('[注册成功]', {
      email: newUser[0].email,
      nickname: newUser[0].nickname,
      inviteCode: inviteCode || 'none',
      rewardResult,
    });

    return NextResponse.json({
      success: true,
      message: '注册成功',
      user: {
        email: newUser[0].email,
        nickname: newUser[0].nickname,
        inviteCode: newUser[0].invite_code,
        creditsAwarded: rewardResult.invited
          ? CREDITS_CONFIG.REGISTER_REWARD + CREDITS_CONFIG.INVITE_REWARD_INVITEE
          : CREDITS_CONFIG.REGISTER_REWARD,
      },
    });

  } catch (error: any) {
    console.error('[注册失败]', error);
    return NextResponse.json(
      { error: '注册失败，请稍后重试' },
      { status: 500 }
    );
  }
}
```

---

### 3.4 修改3D生成API

#### 文件: `src/app/api/ai/generate/text-to-3d/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { getServerSession } from 'next-auth';
import { authOptions } from '@/auth/config';
import { Model3DService } from '@/lib/ai/model3d-service';
import { db } from '@/db';
import { aiGenerationRecords } from '@/db/schema';
import { getUuid } from '@/lib/hash';
import {
  check3DGenerationCredits,
  consume3DGenerationCredits
} from '@/services/credits-system';

export async function POST(req: NextRequest) {
  try {
    const session = await getServerSession(authOptions);
    if (!session?.user?.uuid) {
      return NextResponse.json({ error: '未登录' }, { status: 401 });
    }

    const body = await req.json();
    const { version, prompt, imageUrl, ...otherParams } = body;

    // 1. 使用 Model3DService 计算预估积分
    const service = new Model3DService();
    const estimatedCredits = service.calculateCredits({
      version,
      prompt,
      imageUrl,
      ...otherParams,
    });

    // 2. 检查用户积分是否足够
    const creditCheck = await check3DGenerationCredits({
      userUuid: session.user.uuid,
      estimatedCredits,
    });

    if (!creditCheck.sufficient) {
      return NextResponse.json({
        error: 'insufficient_credits',
        message: '积分不足',
        data: {
          currentBalance: creditCheck.currentBalance,
          required: creditCheck.required,
          shortage: creditCheck.shortage,
        },
      }, { status: 402 }); // 402 Payment Required
    }

    // 3. 创建生成记录
    const recordUuid = getUuid();
    const [record] = await db.insert(aiGenerationRecords).values({
      uuid: recordUuid,
      user_uuid: session.user.uuid,
      type: 'text23d',
      prompt: prompt || null,
      params: JSON.stringify({ version, imageUrl, ...otherParams }),
      status: 'pending',
      created_at: new Date(),
      credits_consumed: 0, // 待API返回后更新
    }).returning();

    // 4. 调用腾讯混元3D API
    const result = await service.generateModel({
      version,
      prompt,
      imageUrl,
      ...otherParams,
    });

    // 5. API调用成功，扣除实际积分
    // 注意: 这里使用预估值，实际应在查询任务完成后根据API返回扣除
    const consumeResult = await consume3DGenerationCredits({
      userUuid: session.user.uuid,
      recordUuid: record.uuid,
      actualCredits: estimatedCredits,
      metadata: {
        version,
        jobId: result.jobId,
        prompt: prompt?.substring(0, 100),
      },
    });

    // 6. 更新生成记录
    await db.update(aiGenerationRecords)
      .set({
        cloud_job_id: result.jobId,
        status: 'processing',
        credits_consumed: estimatedCredits,
        credits_transaction_uuid: consumeResult.transaction.uuid,
      })
      .where(eq(aiGenerationRecords.uuid, recordUuid));

    return NextResponse.json({
      success: true,
      data: {
        recordUuid,
        jobId: result.jobId,
        creditsConsumed: estimatedCredits,
        newBalance: consumeResult.newBalance,
      },
    });

  } catch (error: any) {
    console.error('[3D生成失败]', error);

    if (error.message === '积分不足') {
      return NextResponse.json({
        error: 'insufficient_credits',
        message: '积分不足，请充值后重试',
      }, { status: 402 });
    }

    return NextResponse.json({
      error: 'generation_failed',
      message: error.message || '生成失败',
    }, { status: 500 });
  }
}
```

---

### 3.5 处理生成失败退款

#### 文件: `src/lib/queue/model3d-queue.ts` (修改)

```typescript
import { refund3DGenerationCredits } from '@/services/credits-system';
import { db } from '@/db';
import { aiGenerationRecords } from '@/db/schema';
import { eq } from 'drizzle-orm';

// 在查询任务状态的逻辑中添加
export async function handleJobFailure(recordUuid: string, errorMessage: string) {
  // 1. 获取生成记录
  const [record] = await db
    .select()
    .from(aiGenerationRecords)
    .where(eq(aiGenerationRecords.uuid, recordUuid))
    .limit(1);

  if (!record) {
    throw new Error('记录不存在');
  }

  // 2. 如果已扣除积分，则退款
  if (record.credits_consumed > 0 && record.credits_refunded === 0) {
    const refundResult = await refund3DGenerationCredits({
      userUuid: record.user_uuid,
      recordUuid: record.uuid,
      refundAmount: record.credits_consumed,
      reason: errorMessage,
    });

    // 3. 更新记录
    await db.update(aiGenerationRecords)
      .set({
        status: 'failed',
        error_message: errorMessage,
        credits_refunded: record.credits_consumed,
      })
      .where(eq(aiGenerationRecords.uuid, recordUuid));

    console.log('[积分退款]', {
      recordUuid,
      userUuid: record.user_uuid,
      refundAmount: record.credits_consumed,
      newBalance: refundResult.newBalance,
    });
  }
}
```

---

## 🎨 四、前端实现

### 4.1 注册页面添加邀请码输入

#### 文件: `src/components/auth/RegisterForm.tsx` (修改)

```typescript
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { cacheGet } from '@/lib/cache';
import { CacheKey } from '@/services/constant';

export default function RegisterForm() {
  const router = useRouter();
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [nickname, setNickname] = useState('');
  const [inviteCode, setInviteCode] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  // 从缓存中读取邀请码
  useEffect(() => {
    const cachedCode = cacheGet(CacheKey.InviteCode);
    if (cachedCode) {
      setInviteCode(cachedCode);
    }
  }, []);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError('');

    try {
      const res = await fetch('/api/auth/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password, nickname, inviteCode }),
      });

      const data = await res.json();

      if (!res.ok) {
        throw new Error(data.error || '注册失败');
      }

      // 注册成功，显示奖励信息
      alert(`注册成功！您已获得 ${data.user.creditsAwarded} 积分`);
      router.push('/login');

    } catch (err: any) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      {/* 邮箱 */}
      <input
        type="email"
        placeholder="邮箱"
        value={email}
        onChange={(e) => setEmail(e.target.value)}
        required
      />

      {/* 密码 */}
      <input
        type="password"
        placeholder="密码（至少8位）"
        value={password}
        onChange={(e) => setPassword(e.target.value)}
        required
      />

      {/* 昵称 */}
      <input
        type="text"
        placeholder="昵称（可选）"
        value={nickname}
        onChange={(e) => setNickname(e.target.value)}
      />

      {/* 邀请码 */}
      <div>
        <input
          type="text"
          placeholder="邀请码（可选）"
          value={inviteCode}
          onChange={(e) => setInviteCode(e.target.value)}
        />
        {inviteCode && (
          <p className="text-sm text-green-600 mt-1">
            ✅ 使用邀请码可额外获得 50 积分
          </p>
        )}
      </div>

      {error && <p className="text-red-500">{error}</p>}

      <button type="submit" disabled={loading}>
        {loading ? '注册中...' : '注册'}
      </button>
    </form>
  );
}
```

---

### 4.2 积分不足弹窗组件

#### 文件: `src/components/credits/InsufficientCreditsModal.tsx` (新建)

```typescript
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';

interface Props {
  isOpen: boolean;
  onClose: () => void;
  currentBalance: number;
  required: number;
  shortage: number;
}

export default function InsufficientCreditsModal({
  isOpen,
  onClose,
  currentBalance,
  required,
  shortage,
}: Props) {
  const router = useRouter();
  const [dontShowToday, setDontShowToday] = useState(false);

  if (!isOpen) return null;

  const handleClose = () => {
    if (dontShowToday) {
      // 存储到 localStorage，今日不再显示
      const today = new Date().toISOString().split('T')[0];
      localStorage.setItem('hideCreditsWarning', today);
    }
    onClose();
  };

  const handleRecharge = () => {
    // 跳转到充值页面（预留）
    router.push('/pricing');
    handleClose();
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <div className="text-center">
          <div className="text-5xl mb-4">💰</div>
          <h2 className="text-2xl font-bold mb-2">积分不足</h2>
          <p className="text-gray-600 mb-6">
            当前操作需要 <span className="font-bold text-red-500">{required}</span> 积分，
            您的余额为 <span className="font-bold">{currentBalance}</span> 积分，
            还需要 <span className="font-bold text-red-500">{shortage}</span> 积分
          </p>

          <div className="space-y-3">
            <button
              onClick={handleRecharge}
              className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition"
            >
              💳 充值积分（即将开放）
            </button>

            <button
              onClick={handleClose}
              className="w-full border border-gray-300 py-3 rounded-lg font-semibold hover:bg-gray-50 transition"
            >
              取消
            </button>
          </div>

          <div className="mt-4">
            <label className="flex items-center justify-center text-sm text-gray-500">
              <input
                type="checkbox"
                checked={dontShowToday}
                onChange={(e) => setDontShowToday(e.target.checked)}
                className="mr-2"
              />
              今日不再提醒
            </label>
          </div>
        </div>
      </div>
    </div>
  );
}
```

---

### 4.3 我的邀请页面

#### 文件: `src/app/[locale]/(default)/(console)/my-invites/page.tsx` (修改)

```typescript
'use client';

import { useEffect, useState } from 'react';
import { useSession } from 'next-auth/react';

export default function MyInvitesPage() {
  const { data: session } = useSession();
  const [inviteCode, setInviteCode] = useState('');
  const [invitations, setInvitations] = useState([]);
  const [stats, setStats] = useState({ total: 0, totalRewards: 0 });
  const [copied, setCopied] = useState(false);

  useEffect(() => {
    if (session?.user?.invite_code) {
      setInviteCode(session.user.invite_code);
      fetchInvitations();
    }
  }, [session]);

  const fetchInvitations = async () => {
    const res = await fetch('/api/user/invitations');
    const data = await res.json();
    setInvitations(data.invitations);
    setStats(data.stats);
  };

  const inviteLink = `${window.location.origin}/i/${inviteCode}`;

  const copyLink = () => {
    navigator.clipboard.writeText(inviteLink);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  return (
    <div className="max-w-4xl mx-auto p-6">
      <h1 className="text-3xl font-bold mb-6">我的邀请</h1>

      {/* 邀请统计 */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
        <div className="bg-blue-50 p-6 rounded-lg">
          <p className="text-sm text-gray-600">累计邀请</p>
          <p className="text-3xl font-bold text-blue-600">{stats.total}</p>
          <p className="text-xs text-gray-500 mt-1">上限 100 人</p>
        </div>

        <div className="bg-green-50 p-6 rounded-lg">
          <p className="text-sm text-gray-600">累计奖励</p>
          <p className="text-3xl font-bold text-green-600">{stats.totalRewards}</p>
          <p className="text-xs text-gray-500 mt-1">积分</p>
        </div>

        <div className="bg-purple-50 p-6 rounded-lg">
          <p className="text-sm text-gray-600">单次奖励</p>
          <p className="text-3xl font-bold text-purple-600">50</p>
          <p className="text-xs text-gray-500 mt-1">积分/人</p>
        </div>
      </div>

      {/* 邀请链接 */}
      <div className="bg-white border-2 border-dashed border-blue-300 p-6 rounded-lg mb-8">
        <h2 className="text-lg font-semibold mb-3">您的专属邀请链接</h2>
        <div className="flex gap-2">
          <input
            type="text"
            value={inviteLink}
            readOnly
            className="flex-1 p-3 border rounded-lg bg-gray-50"
          />
          <button
            onClick={copyLink}
            className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
          >
            {copied ? '✓ 已复制' : '复制链接'}
          </button>
        </div>
        <p className="text-sm text-gray-500 mt-3">
          💡 分享此链接，每邀请1人注册可获得 <span className="font-bold text-blue-600">50积分</span> 奖励
        </p>
      </div>

      {/* 邀请记录 */}
      <div>
        <h2 className="text-xl font-semibold mb-4">邀请记录</h2>
        {invitations.length === 0 ? (
          <p className="text-center text-gray-500 py-8">暂无邀请记录</p>
        ) : (
          <div className="space-y-3">
            {invitations.map((invite: any) => (
              <div key={invite.uuid} className="border p-4 rounded-lg flex justify-between items-center">
                <div>
                  <p className="font-semibold">{invite.invitee.email}</p>
                  <p className="text-sm text-gray-500">
                    {new Date(invite.created_at).toLocaleDateString()}
                  </p>
                </div>
                <div className="text-right">
                  <p className="text-green-600 font-bold">+{invite.inviter_reward} 积分</p>
                  <p className="text-xs text-gray-500">{invite.status}</p>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}
```

---

## 🛠️ 五、管理后台

### 5.1 用户积分管理页面

#### 文件: `src/app/[locale]/(admin)/admin/credits/page.tsx` (新建)

```typescript
'use client';

import { useEffect, useState } from 'react';
import { useSession } from 'next-auth/react';

export default function AdminCreditsPage() {
  const { data: session } = useSession();
  const [users, setUsers] = useState([]);
  const [selectedUser, setSelectedUser] = useState(null);
  const [adjustAmount, setAdjustAmount] = useState(0);
  const [adjustReason, setAdjustReason] = useState('');

  useEffect(() => {
    fetchUsers();
  }, []);

  const fetchUsers = async () => {
    const res = await fetch('/api/admin/credits/users');
    const data = await res.json();
    setUsers(data.users);
  };

  const handleAdjustCredits = async () => {
    if (!selectedUser || adjustAmount === 0) return;

    const res = await fetch('/api/admin/credits/adjust', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        userUuid: selectedUser.uuid,
        amount: adjustAmount,
        reason: adjustReason,
      }),
    });

    if (res.ok) {
      alert('积分调整成功');
      fetchUsers();
      setSelectedUser(null);
      setAdjustAmount(0);
      setAdjustReason('');
    }
  };

  // 管理员权限检查
  if (!session?.user?.is_admin) {
    return <div>无权限访问</div>;
  }

  return (
    <div className="p-6">
      <h1 className="text-3xl font-bold mb-6">用户积分管理</h1>

      <div className="bg-white rounded-lg shadow overflow-hidden">
        <table className="min-w-full">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-6 py-3 text-left">用户</th>
              <th className="px-6 py-3 text-left">当前积分</th>
              <th className="px-6 py-3 text-left">累计获得</th>
              <th className="px-6 py-3 text-left">累计消耗</th>
              <th className="px-6 py-3 text-left">邀请人数</th>
              <th className="px-6 py-3 text-left">操作</th>
            </tr>
          </thead>
          <tbody className="divide-y">
            {users.map((user: any) => (
              <tr key={user.uuid}>
                <td className="px-6 py-4">
                  <div>
                    <p className="font-semibold">{user.nickname}</p>
                    <p className="text-sm text-gray-500">{user.email}</p>
                  </div>
                </td>
                <td className="px-6 py-4 font-bold">{user.current_balance}</td>
                <td className="px-6 py-4 text-green-600">+{user.total_earned}</td>
                <td className="px-6 py-4 text-red-600">-{user.total_spent}</td>
                <td className="px-6 py-4">{user.total_invites}</td>
                <td className="px-6 py-4">
                  <button
                    onClick={() => setSelectedUser(user)}
                    className="text-blue-600 hover:underline"
                  >
                    调整积分
                  </button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {/* 调整积分弹窗 */}
      {selectedUser && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
          <div className="bg-white p-6 rounded-lg max-w-md w-full">
            <h2 className="text-xl font-bold mb-4">调整用户积分</h2>
            <p className="mb-4">
              用户: <span className="font-semibold">{selectedUser.email}</span>
            </p>
            <p className="mb-4">
              当前积分: <span className="font-bold">{selectedUser.current_balance}</span>
            </p>

            <div className="space-y-4">
              <div>
                <label className="block mb-2">调整数量</label>
                <input
                  type="number"
                  value={adjustAmount}
                  onChange={(e) => setAdjustAmount(Number(e.target.value))}
                  className="w-full border p-2 rounded"
                  placeholder="正数增加，负数扣除"
                />
              </div>

              <div>
                <label className="block mb-2">调整原因</label>
                <textarea
                  value={adjustReason}
                  onChange={(e) => setAdjustReason(e.target.value)}
                  className="w-full border p-2 rounded"
                  rows={3}
                />
              </div>

              <div className="flex gap-2">
                <button
                  onClick={handleAdjustCredits}
                  className="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700"
                >
                  确认调整
                </button>
                <button
                  onClick={() => setSelectedUser(null)}
                  className="flex-1 border py-2 rounded hover:bg-gray-50"
                >
                  取消
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
```

---

### 5.2 积分消耗统计页面

#### 文件: `src/app/[locale]/(admin)/admin/consumption-stats/page.tsx` (新建)

```typescript
'use client';

import { useEffect, useState } from 'react';
import { Line } from 'react-chartjs-2';

export default function ConsumptionStatsPage() {
  const [stats, setStats] = useState({
    totalConsumption: 0,
    totalUsers: 0,
    avgPerUser: 0,
    dailyData: [],
  });
  const [recentConsumptions, setRecentConsumptions] = useState([]);

  useEffect(() => {
    fetchStats();
    fetchRecentConsumptions();
  }, []);

  const fetchStats = async () => {
    const res = await fetch('/api/admin/stats/consumption');
    const data = await res.json();
    setStats(data);
  };

  const fetchRecentConsumptions = async () => {
    const res = await fetch('/api/admin/credits/consumptions?limit=50');
    const data = await res.json();
    setRecentConsumptions(data.consumptions);
  };

  return (
    <div className="p-6">
      <h1 className="text-3xl font-bold mb-6">积分消耗统计</h1>

      {/* 统计卡片 */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div className="bg-white p-6 rounded-lg shadow">
          <p className="text-gray-600 mb-2">总消耗积分</p>
          <p className="text-4xl font-bold text-red-600">{stats.totalConsumption}</p>
        </div>

        <div className="bg-white p-6 rounded-lg shadow">
          <p className="text-gray-600 mb-2">消耗用户数</p>
          <p className="text-4xl font-bold text-blue-600">{stats.totalUsers}</p>
        </div>

        <div className="bg-white p-6 rounded-lg shadow">
          <p className="text-gray-600 mb-2">人均消耗</p>
          <p className="text-4xl font-bold text-purple-600">{stats.avgPerUser.toFixed(1)}</p>
        </div>
      </div>

      {/* 消耗趋势图 */}
      <div className="bg-white p-6 rounded-lg shadow mb-8">
        <h2 className="text-xl font-semibold mb-4">每日消耗趋势</h2>
        {/* Chart.js 图表组件 */}
      </div>

      {/* 最近消耗记录 */}
      <div className="bg-white rounded-lg shadow">
        <div className="px-6 py-4 border-b">
          <h2 className="text-xl font-semibold">最近消耗记录</h2>
        </div>
        <table className="min-w-full">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-6 py-3 text-left">时间</th>
              <th className="px-6 py-3 text-left">用户</th>
              <th className="px-6 py-3 text-left">消耗积分</th>
              <th className="px-6 py-3 text-left">类型</th>
              <th className="px-6 py-3 text-left">说明</th>
            </tr>
          </thead>
          <tbody className="divide-y">
            {recentConsumptions.map((record: any) => (
              <tr key={record.uuid}>
                <td className="px-6 py-4 text-sm">
                  {new Date(record.created_at).toLocaleString()}
                </td>
                <td className="px-6 py-4">{record.user_email}</td>
                <td className="px-6 py-4 font-bold text-red-600">
                  {Math.abs(record.amount)}
                </td>
                <td className="px-6 py-4">
                  <span className="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs">
                    {record.type}
                  </span>
                </td>
                <td className="px-6 py-4 text-sm text-gray-600">
                  {record.description}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}
```

---

## 📡 六、API接口汇总

### 6.1 用户端API

| 接口路径 | 方法 | 说明 |
|---------|------|------|
| `/api/auth/register` | POST | 用户注册（含邀请码处理） |
| `/api/user/credits` | GET | 获取当前用户积分余额 |
| `/api/user/credits/transactions` | GET | 获取积分交易历史 |
| `/api/user/invitations` | GET | 获取我的邀请记录 |
| `/api/ai/generate/text-to-3d` | POST | 3D生成（含积分扣除） |

### 6.2 管理员API

| 接口路径 | 方法 | 说明 |
|---------|------|------|
| `/api/admin/credits/users` | GET | 获取所有用户积分信息 |
| `/api/admin/credits/adjust` | POST | 手动调整用户积分 |
| `/api/admin/credits/consumptions` | GET | 获取积分消耗记录 |
| `/api/admin/stats/consumption` | GET | 获取消耗统计数据 |
| `/api/admin/invitations` | GET | 获取所有邀请记录 |

---

## 🔄 七、实施步骤

### Phase 1: 数据库准备（1天）
1. ✅ 执行数据库迁移脚本
2. ✅ 验证表结构和索引
3. ✅ 备份现有数据

### Phase 2: 后端核心功能（2-3天）
1. ✅ 实现 `src/services/credits-system.ts`
2. ✅ 修改注册API支持邀请码
3. ✅ 修改3D生成API支持积分扣除
4. ✅ 实现积分退款逻辑
5. ✅ 编写单元测试

### Phase 3: 前端功能（2天）
1. ✅ 注册页面添加邀请码输入框
2. ✅ 实现积分不足弹窗
3. ✅ 完善"我的邀请"页面
4. ✅ 用户积分显示组件

### Phase 4: 管理后台（2天）
1. ✅ 用户积分管理页面
2. ✅ 积分消耗统计页面
3. ✅ 邀请记录查询页面
4. ✅ 数据导出功能

### Phase 5: 测试与上线（1-2天）
1. ✅ 功能测试
2. ✅ 边界情况测试
3. ✅ 性能测试
4. ✅ 灰度发布
5. ✅ 监控告警配置

---

## 🧪 八、测试用例

### 8.1 注册与邀请测试

#### 测试场景1: 普通注册（无邀请码）
```
输入: { email: "user1@test.com", password: "password123" }
预期结果:
  - 用户创建成功
  - 获得100积分
  - credit_transactions 有1条 type='register' 记录
```

#### 测试场景2: 使用邀请码注册
```
前置条件: 邀请人 inviter@test.com (invite_code='ABC12345')
输入: { email: "user2@test.com", password: "password123", inviteCode: "ABC12345" }
预期结果:
  - 新用户获得150积分（100基础+50邀请）
  - 邀请人获得50积分
  - credit_transactions 有3条记录
  - invitations 表新增1条记录
  - 新用户的 invited_by 字段为邀请人UUID
```

#### 测试场景3: 邀请上限测试
```
前置条件: 邀请人已邀请100人
输入: 第101人使用该邀请码注册
预期结果:
  - 新用户仅获得100积分（基础奖励）
  - 邀请人不获得奖励
  - invitations 表不新增记录
```

---

### 8.2 积分消耗测试

#### 测试场景4: 积分足够的3D生成
```
前置条件: 用户有200积分
输入: 生成需要50积分的3D模型
预期结果:
  - 扣除50积分，余额150
  - credit_transactions 新增1条 type='consume_3d' 记录
  - ai_generation_records 的 credits_consumed=50
```

#### 测试场景5: 积分不足的3D生成
```
前置条件: 用户有30积分
输入: 生成需要50积分的3D模型
预期结果:
  - 返回 402 状态码
  - 积分不扣除
  - 提示积分不足，差额20
```

#### 测试场景6: 生成失败退款
```
前置条件: 已扣除50积分，腾讯API返回失败
输入: 任务查询返回 status='FAIL'
预期结果:
  - 退还50积分
  - credit_transactions 新增1条 type='refund' 记录
  - ai_generation_records 的 credits_refunded=50
```

---

### 8.3 管理后台测试

#### 测试场景7: 管理员手动调整积分
```
前置条件: 管理员登录，选择用户A（当前100积分）
输入: 调整+50积分，原因="活动奖励"
预期结果:
  - 用户A积分变为150
  - credit_transactions 新增1条 type='admin_adjust' 记录
```

---

## 📊 九、数据监控指标

### 9.1 核心指标

| 指标名称 | 说明 | 告警阈值 |
|---------|------|---------|
| 日新增用户 | 每日注册用户数 | - |
| 邀请转化率 | 使用邀请码注册比例 | < 20% 需优化 |
| 人均积分消耗 | 用户平均消耗积分 | - |
| 积分余额预警 | 积分不足拦截次数 | > 100次/天 |
| 退款率 | 生成失败退款比例 | > 10% 需排查 |

### 9.2 SQL查询示例

#### 查询今日注册用户数
```sql
SELECT COUNT(*) as today_users
FROM users
WHERE DATE(created_at) = CURRENT_DATE;
```

#### 查询邀请转化率
```sql
SELECT
  COUNT(DISTINCT invitee_uuid)::FLOAT / COUNT(DISTINCT uuid) * 100 as invite_rate
FROM users
WHERE created_at >= CURRENT_DATE - INTERVAL '7 days';
```

#### 查询TOP10积分消耗用户
```sql
SELECT
  u.email,
  u.nickname,
  SUM(ABS(ct.amount)) as total_consumption
FROM credit_transactions ct
JOIN users u ON ct.user_uuid = u.uuid
WHERE ct.type = 'consume_3d'
GROUP BY u.uuid, u.email, u.nickname
ORDER BY total_consumption DESC
LIMIT 10;
```

---

## 🔐 十、安全与风控

### 10.1 反作弊机制

#### 1. IP限制
- 同一IP 24小时内最多注册3个账号
- 实现: 在注册时记录 `signin_ip`，查询限制

#### 2. 邀请上限
- 单用户最多邀请100人
- 实现: 已在 `handleRegisterReward` 中实现

#### 3. 积分异常监控
- 单用户单日积分变动超过1000自动标记
- 实现: 定时任务扫描 `credit_transactions`

### 10.2 数据一致性保障

#### 1. 数据库事务
- 所有积分操作使用 `db.transaction`
- 确保积分扣除和记录创建原子性

#### 2. 余额校验
- 定期对比 `users.credits` 和 `credit_transactions` 汇总
- SQL脚本:
```sql
SELECT
  u.uuid,
  u.credits as db_balance,
  COALESCE(SUM(ct.amount), 0) as calculated_balance,
  u.credits - COALESCE(SUM(ct.amount), 0) as diff
FROM users u
LEFT JOIN credit_transactions ct ON u.uuid = ct.user_uuid
GROUP BY u.uuid, u.credits
HAVING u.credits != COALESCE(SUM(ct.amount), 0);
```

---

## 📝 十一、后续优化方向

### 11.1 功能扩展
1. **积分充值系统**
   - 接入支付网关（Stripe/微信支付）
   - 充值档位配置
   - 充值优惠活动

2. **积分等级体系**
   - VIP等级（消费满X积分升级）
   - 等级专属权益
   - 积分加成

3. **邀请排行榜**
   - 周/月邀请排行
   - 额外奖励机制

4. **积分兑换商城**
   - 实物/虚拟商品兑换
   - 库存管理

### 11.2 性能优化
1. **缓存策略**
   - Redis缓存用户积分余额
   - 减少数据库查询

2. **异步处理**
   - 积分发放异步化（队列）
   - 减少注册响应时间

3. **数据归档**
   - 历史交易记录定期归档
   - 保持主表性能

---

## 📚 十二、附录

### 12.1 常量配置文件

#### 文件: `src/config/credits.ts`

```typescript
export const CREDITS_CONFIG = {
  // 积分奖励
  REGISTER_REWARD: 100,
  INVITE_REWARD_INVITER: 50,
  INVITE_REWARD_INVITEE: 50,

  // 限制
  MAX_INVITES_PER_USER: 100,
  MAX_DAILY_REGISTRATIONS_PER_IP: 3,

  // 3D生成预估积分（用于前端展示）
  ESTIMATE_3D_BASIC: 0,      // 基础版暂无积分计费
  ESTIMATE_3D_PRO_MIN: 15,   // 专业版最低
  ESTIMATE_3D_PRO_MAX: 55,   // 专业版最高
  ESTIMATE_3D_RAPID_MIN: 10, // 极速版最低
  ESTIMATE_3D_RAPID_MAX: 15, // 极速版最高
} as const;

export const CREDIT_TRANSACTION_DESCRIPTIONS = {
  register: '新用户注册奖励',
  invite_reward: '邀请好友注册奖励',
  invite_new_user: '使用邀请码注册额外奖励',
  consume_3d: '3D模型生成消耗',
  refund: '生成失败退款',
  admin_adjust: '管理员手动调整',
  purchase: '充值购买',
} as const;
```

---

### 12.2 类型定义文件

#### 文件: `src/types/credits.d.ts`

```typescript
export interface CreditTransaction {
  id: number;
  uuid: string;
  user_uuid: string;
  type: 'register' | 'invite_reward' | 'invite_new_user' | 'consume_3d' | 'refund' | 'admin_adjust' | 'purchase';
  amount: number;
  balance_after: number;
  related_user_uuid?: string;
  related_record_uuid?: string;
  order_no?: string;
  description: string;
  metadata?: any;
  created_at: Date;
}

export interface Invitation {
  id: number;
  uuid: string;
  inviter_uuid: string;
  invitee_uuid: string;
  invitation_code: string;
  inviter_reward: number;
  invitee_reward: number;
  status: 'completed' | 'cancelled';
  created_at: Date;
}

export interface CreditCheckResult {
  sufficient: boolean;
  currentBalance: number;
  required: number;
  shortage?: number;
}
```

**技术亮点**:
- 基于现有 `shipany-docs/17-邀请返佣.md` 机制扩展
- 保持与现有 `affiliates` 表兼容
- 新增独立 `credit_transactions` 和 `invitations` 表
- 使用数据库事务保证一致性
- 预留充值、等级等扩展功能

**预估工作量**: 8-10 人天

---

**文档版本**: v1.0
**最后更新**: 2025-10-18
**审核状态**: 待审核
