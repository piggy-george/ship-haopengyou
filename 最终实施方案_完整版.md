# é‚®ç®±å¯†ç ç™»å½• + ç®¡ç†å‘˜åå° - æœ€ç»ˆå®Œæ•´å®æ–½æ–¹æ¡ˆ

> ğŸ“… åˆ›å»ºæ—¶é—´ï¼š2025-01-14  
> âœ… åŒ…å«æ‰€æœ‰å®ç°ç»†èŠ‚  
> ğŸ¯ ç”¨æˆ·é‚®ç®±å¯†ç å¯åœ¨ç®¡ç†åå°ä»¥æ˜æ–‡å½¢å¼æŸ¥çœ‹  
> â±ï¸ é¢„è®¡è€—æ—¶ï¼š2-3å°æ—¶

---

## ğŸ“Š åŠŸèƒ½éœ€æ±‚ç¡®è®¤

### âœ… è¦å®ç°çš„åŠŸèƒ½

1. âœ… ç”¨æˆ·æ³¨å†Œï¼ˆé‚®ç®± + å¯†ç ï¼‰
2. âœ… ç”¨æˆ·ç™»å½•ï¼ˆé‚®ç®± + å¯†ç ï¼‰
3. âœ… å¯†ç ä½¿ç”¨ **AES åŠ å¯†**å­˜å‚¨ï¼ˆå¯é€†ï¼Œç®¡ç†å‘˜èƒ½è§£å¯†æŸ¥çœ‹ï¼‰
4. âœ… ç®¡ç†å‘˜åå°æ˜¾ç¤ºç”¨æˆ·åˆ—è¡¨
5. âœ… ç®¡ç†å‘˜åå°**ä»¥æ˜æ–‡å½¢å¼æ˜¾ç¤ºç”¨æˆ·å¯†ç **
6. âœ… é…ç½®ç®¡ç†å‘˜é‚®ç®±è®¿é—®æ§åˆ¶

### âŒ ä¸å®ç°çš„åŠŸèƒ½

- âŒ é‚®ç®±éªŒè¯ç 
- âŒ å¿˜è®°å¯†ç åŠŸèƒ½
- âŒ Google/Github OAuthï¼ˆå·²æœ‰ä»£ç ï¼Œæš‚ä¸é…ç½®ï¼‰

---

## ğŸ—ï¸ æ¶æ„è¯´æ˜

### åŠ å¯†æ–¹å¼

```
ç”¨æˆ·æ³¨å†Œ/ç™»å½•:
åŸå§‹å¯†ç  "123456"
    â†“ AES åŠ å¯†ï¼ˆä½¿ç”¨ SECRET_KEYï¼‰
æ•°æ®åº“å­˜å‚¨: "U2FsdGVkX1+xxx..."
    â†“ AES è§£å¯†ï¼ˆç®¡ç†å‘˜æŸ¥çœ‹æ—¶ï¼‰
ç®¡ç†åå°æ˜¾ç¤º: "123456"  â† æ˜æ–‡æ˜¾ç¤º
```

### æŠ€æœ¯æ ˆ

- **åŠ å¯†åº“**ï¼šcrypto-jsï¼ˆAESåŠ å¯†ï¼‰
- **è®¤è¯æ¡†æ¶**ï¼šnext-authï¼ˆå·²æœ‰ï¼‰
- **æ•°æ®åº“**ï¼šPostgreSQLï¼ˆå·²æœ‰ï¼‰
- **UIç»„ä»¶**ï¼šshadcn/uiï¼ˆå·²æœ‰ï¼‰

---

## ğŸ“‹ è¯¦ç»†å®æ–½æ­¥éª¤

### æ­¥éª¤ 1ï¼šå®‰è£…ä¾èµ–ï¼ˆ5åˆ†é’Ÿï¼‰

**æ“ä½œ**ï¼šå®‰è£…å¯†ç åŠ å¯†åº“

```bash
cd /home/ubuntu/ship-haopengyou
npm install crypto-js @types/crypto-js
```

**é¢„æœŸè¾“å‡º**ï¼š

```
added 2 packages, and audited xxx packages in 5s
```

---

### æ­¥éª¤ 2ï¼šåˆ›å»ºå¯†ç å·¥å…·å‡½æ•°ï¼ˆ10åˆ†é’Ÿï¼‰

**æ–°å»ºæ–‡ä»¶**ï¼š`src/lib/password.ts`

**å®Œæ•´ä»£ç **ï¼š

```typescript
import CryptoJS from 'crypto-js';

// åŠ å¯†å¯†é’¥ï¼ˆä»ç¯å¢ƒå˜é‡è¯»å–ï¼‰
const SECRET_KEY = process.env.PASSWORD_SECRET_KEY || 'default-secret-key-please-change';

/**
 * åŠ å¯†å¯†ç ï¼ˆAES å¯é€†åŠ å¯†ï¼‰
 * @param password æ˜æ–‡å¯†ç 
 * @returns åŠ å¯†åçš„å¯†ç 
 */
export function encryptPassword(password: string): string {
  return CryptoJS.AES.encrypt(password, SECRET_KEY).toString();
}

/**
 * è§£å¯†å¯†ç 
 * @param encryptedPassword åŠ å¯†åçš„å¯†ç 
 * @returns æ˜æ–‡å¯†ç 
 */
export function decryptPassword(encryptedPassword: string): string {
  try {
    const bytes = CryptoJS.AES.decrypt(encryptedPassword, SECRET_KEY);
    const decrypted = bytes.toString(CryptoJS.enc.Utf8);
    return decrypted;
  } catch (error) {
    console.error('Decrypt password failed:', error);
    return '';
  }
}

/**
 * éªŒè¯å¯†ç æ˜¯å¦åŒ¹é…
 * @param password æ˜æ–‡å¯†ç 
 * @param encryptedPassword åŠ å¯†åçš„å¯†ç 
 * @returns æ˜¯å¦åŒ¹é…
 */
export function verifyPassword(password: string, encryptedPassword: string): boolean {
  const decrypted = decryptPassword(encryptedPassword);
  return decrypted === password;
}

/**
 * éªŒè¯å¯†ç å¼ºåº¦
 * @param password å¯†ç 
 * @returns éªŒè¯ç»“æœ
 */
export function validatePasswordStrength(password: string): {
  valid: boolean;
  message?: string;
} {
  if (!password || password.length < 6) {
    return {
      valid: false,
      message: 'å¯†ç é•¿åº¦è‡³å°‘ä¸º6ä½',
    };
  }

  if (password.length > 100) {
    return {
      valid: false,
      message: 'å¯†ç é•¿åº¦ä¸èƒ½è¶…è¿‡100ä½',
    };
  }

  return { valid: true };
}
```

**è¯´æ˜**ï¼š
- ä½¿ç”¨ AES å¯¹ç§°åŠ å¯†
- å¯†é’¥ä»ç¯å¢ƒå˜é‡è¯»å–
- æä¾›åŠ å¯†ã€è§£å¯†ã€éªŒè¯ä¸‰ä¸ªæ ¸å¿ƒåŠŸèƒ½

---

### æ­¥éª¤ 3ï¼šä¿®æ”¹æ•°æ®åº“ Schemaï¼ˆ10åˆ†é’Ÿï¼‰

**ä¿®æ”¹æ–‡ä»¶**ï¼š`src/db/schema.ts`

**ä½ç½®**ï¼šæ‰¾åˆ° `export const users = pgTable("users", {` è¿™ä¸€è¡Œ

**åœ¨ç°æœ‰å­—æ®µä¸­æ·»åŠ **ï¼š

```typescript
export const users = pgTable("users", {
  id: integer().primaryKey().generatedAlwaysAsIdentity(),
  uuid: varchar({ length: 255 }).notNull().unique(),
  email: varchar({ length: 255 }).notNull().unique(),
  nickname: varchar({ length: 255 }),
  avatar_url: varchar({ length: 500 }),
  
  // â¬‡ï¸â¬‡ï¸â¬‡ï¸ æ–°å¢å­—æ®µå¼€å§‹ â¬‡ï¸â¬‡ï¸â¬‡ï¸
  
  // åŠ å¯†åçš„å¯†ç ï¼ˆAESå¯é€†åŠ å¯†ï¼‰
  password_encrypted: varchar({ length: 500 }),
  
  // è´¦å·ç±»å‹ï¼šemail(é‚®ç®±å¯†ç ) æˆ– oauth(ç¬¬ä¸‰æ–¹ç™»å½•)
  account_type: varchar({ length: 50 }).default('oauth'),
  
  // â¬†ï¸â¬†ï¸â¬†ï¸ æ–°å¢å­—æ®µç»“æŸ â¬†ï¸â¬†ï¸â¬†ï¸
  
  credits: integer().notNull().default(0),
  invite_code: varchar({ length: 50 }),
  invited_by: varchar({ length: 255 }),
  signin_type: varchar({ length: 50 }),
  signin_provider: varchar({ length: 50 }),
  signin_openid: varchar({ length: 255 }),
  signin_ip: varchar({ length: 100 }),
  created_at: timestamp({ withTimezone: true }).defaultNow(),
  updated_at: timestamp({ withTimezone: true }).defaultNow(),
}, (table) => [
  index("users_email_idx").on(table.email),
  index("users_invite_code_idx").on(table.invite_code),
]);
```

**åº”ç”¨æ•°æ®åº“å˜æ›´**ï¼š

```bash
npm run db:push
```

**é¢„æœŸè¾“å‡º**ï¼š

```
âœ“ Applying changes...
âœ“ Changes applied successfully
```

---

### æ­¥éª¤ 4ï¼šåˆ›å»ºç”¨æˆ·æ³¨å†Œ APIï¼ˆ20åˆ†é’Ÿï¼‰

**æ–°å»ºæ–‡ä»¶**ï¼š`src/app/api/auth/register/route.ts`

**å®Œæ•´ä»£ç **ï¼š

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { db } from '@/db';
import { users } from '@/db/schema';
import { eq } from 'drizzle-orm';
import { encryptPassword, validatePasswordStrength } from '@/lib/password';
import { getUuid } from '@/lib/hash';
import { v4 as uuidv4 } from 'uuid';

export async function POST(req: NextRequest) {
  try {
    const { email, password, nickname } = await req.json();

    // 1. éªŒè¯è¾“å…¥
    if (!email || !password) {
      return NextResponse.json(
        { error: 'é‚®ç®±å’Œå¯†ç ä¸èƒ½ä¸ºç©º' },
        { status: 400 }
      );
    }

    // éªŒè¯é‚®ç®±æ ¼å¼
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      return NextResponse.json(
        { error: 'é‚®ç®±æ ¼å¼ä¸æ­£ç¡®' },
        { status: 400 }
      );
    }

    // éªŒè¯å¯†ç å¼ºåº¦
    const passwordValidation = validatePasswordStrength(password);
    if (!passwordValidation.valid) {
      return NextResponse.json(
        { error: passwordValidation.message },
        { status: 400 }
      );
    }

    // 2. æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²å­˜åœ¨
    const existingUser = await db
      .select()
      .from(users)
      .where(eq(users.email, email.toLowerCase()))
      .limit(1);

    if (existingUser.length > 0) {
      return NextResponse.json(
        { error: 'è¯¥é‚®ç®±å·²è¢«æ³¨å†Œ' },
        { status: 400 }
      );
    }

    // 3. åŠ å¯†å¯†ç 
    const passwordEncrypted = encryptPassword(password);

    // 4. ç”Ÿæˆé‚€è¯·ç 
    const inviteCode = uuidv4().substring(0, 8);

    // 5. åˆ›å»ºç”¨æˆ·
    const newUser = await db.insert(users).values({
      uuid: getUuid(),
      email: email.toLowerCase(),
      nickname: nickname || email.split('@')[0],
      password_encrypted: passwordEncrypted,
      account_type: 'email',
      credits: 100, // æ–°ç”¨æˆ·èµ é€100ç§¯åˆ†
      invite_code: inviteCode,
      signin_type: 'credentials',
      signin_provider: 'email',
      created_at: new Date(),
    }).returning();

    console.log('[æ³¨å†ŒæˆåŠŸ]', { email: newUser[0].email, nickname: newUser[0].nickname });

    return NextResponse.json({
      success: true,
      message: 'æ³¨å†ŒæˆåŠŸ',
      user: {
        email: newUser[0].email,
        nickname: newUser[0].nickname,
      },
    });

  } catch (error: any) {
    console.error('[æ³¨å†Œå¤±è´¥]', error);
    return NextResponse.json(
      { error: 'æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•' },
      { status: 500 }
    );
  }
}
```

**è¯´æ˜**ï¼š
- éªŒè¯é‚®ç®±æ ¼å¼å’Œå¯†ç å¼ºåº¦
- æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²æ³¨å†Œ
- ä½¿ç”¨ AES åŠ å¯†å¯†ç 
- è‡ªåŠ¨ç”Ÿæˆé‚€è¯·ç 
- èµ é€æ–°ç”¨æˆ·100ç§¯åˆ†

---

### æ­¥éª¤ 5ï¼šé…ç½® next-authï¼ˆ30åˆ†é’Ÿï¼‰

**ä¿®æ”¹æ–‡ä»¶**ï¼š`src/auth/config.ts`

#### 5.1 æ·»åŠ å¯¼å…¥ï¼ˆæ–‡ä»¶å¼€å¤´ï¼‰

åœ¨æ–‡ä»¶æœ€ä¸Šæ–¹æ·»åŠ ï¼š

```typescript
import { verifyPassword } from '@/lib/password';
import { db } from '@/db';
import { users } from '@/db/schema';
import { eq } from 'drizzle-orm';
```

#### 5.2 æ·»åŠ  Credentials Provider

æ‰¾åˆ° `let providers: Provider[] = [];` è¿™ä¸€è¡Œï¼ˆå¤§çº¦ç¬¬13è¡Œï¼‰ï¼Œåœ¨ä¸‹é¢æ·»åŠ ï¼š

```typescript
let providers: Provider[] = [];

// â¬‡ï¸â¬‡ï¸â¬‡ï¸ æ–°å¢ï¼šé‚®ç®±å¯†ç ç™»å½• â¬‡ï¸â¬‡ï¸â¬‡ï¸
providers.push(
  CredentialsProvider({
    id: "credentials",
    name: "é‚®ç®±å¯†ç ",
    credentials: {
      email: { 
        label: "é‚®ç®±", 
        type: "email", 
        placeholder: "[email protected]" 
      },
      password: { 
        label: "å¯†ç ", 
        type: "password" 
      },
    },

    async authorize(credentials, req) {
      try {
        if (!credentials?.email || !credentials?.password) {
          console.log("[ç™»å½•] ç¼ºå°‘é‚®ç®±æˆ–å¯†ç ");
          return null;
        }

        // æŸ¥æ‰¾ç”¨æˆ·
        const userResult = await db
          .select()
          .from(users)
          .where(eq(users.email, credentials.email.toLowerCase()))
          .limit(1);

        if (userResult.length === 0) {
          console.log("[ç™»å½•] ç”¨æˆ·ä¸å­˜åœ¨:", credentials.email);
          return null;
        }

        const user = userResult[0];

        // æ£€æŸ¥æ˜¯å¦æœ‰å¯†ç ï¼ˆé˜²æ­¢OAuthç”¨æˆ·ç”¨å¯†ç ç™»å½•ï¼‰
        if (!user.password_encrypted) {
          console.log("[ç™»å½•] OAuthç”¨æˆ·å°è¯•ç”¨å¯†ç ç™»å½•");
          return null;
        }

        // éªŒè¯å¯†ç 
        const isValidPassword = verifyPassword(
          credentials.password,
          user.password_encrypted
        );

        if (!isValidPassword) {
          console.log("[ç™»å½•] å¯†ç é”™è¯¯");
          return null;
        }

        console.log("[ç™»å½•æˆåŠŸ]", { email: user.email });

        // è¿”å›ç”¨æˆ·ä¿¡æ¯
        return {
          id: user.uuid,
          email: user.email,
          name: user.nickname || user.email.split('@')[0],
          image: user.avatar_url,
        };
      } catch (error) {
        console.error("[ç™»å½•å¼‚å¸¸]", error);
        return null;
      }
    },
  })
);
// â¬†ï¸â¬†ï¸â¬†ï¸ æ–°å¢ç»“æŸ â¬†ï¸â¬†ï¸â¬†ï¸
```

---

### æ­¥éª¤ 6ï¼šä¿®æ”¹è®¤è¯å¤„ç†å™¨ï¼ˆ15åˆ†é’Ÿï¼‰

**ä¿®æ”¹æ–‡ä»¶**ï¼š`src/auth/handler.ts`

#### 6.1 æ·»åŠ å¯¼å…¥ï¼ˆæ–‡ä»¶å¼€å¤´ï¼‰

```typescript
import { db } from '@/db';
import { users } from '@/db/schema';
import { eq } from 'drizzle-orm';
```

#### 6.2 ä¿®æ”¹ handleSignInUser å‡½æ•°

æ‰¾åˆ° `export async function handleSignInUser(` è¿™ä¸€è¡Œï¼Œåœ¨å‡½æ•°å¼€å¤´æ·»åŠ é‚®ç®±ç™»å½•å¤„ç†ï¼š

```typescript
export async function handleSignInUser(
  user: User | AdapterUser,
  account: Account
): Promise<UserType | null> {
  try {
    if (!user.email) {
      throw new Error("invalid signin user");
    }

    // â¬‡ï¸â¬‡ï¸â¬‡ï¸ æ–°å¢ï¼šé‚®ç®±å¯†ç ç™»å½•ç‰¹æ®Šå¤„ç† â¬‡ï¸â¬‡ï¸â¬‡ï¸
    if (account.provider === "credentials") {
      // é‚®ç®±å¯†ç ç™»å½•æ—¶ï¼Œç”¨æˆ·å·²åœ¨æ•°æ®åº“ä¸­ï¼Œç›´æ¥æŸ¥è¯¢è¿”å›
      const userResult = await db
        .select()
        .from(users)
        .where(eq(users.email, user.email.toLowerCase()))
        .limit(1);

      if (userResult.length === 0) {
        throw new Error("User not found");
      }

      console.log("[è®¤è¯å¤„ç†] é‚®ç®±å¯†ç ç™»å½•:", user.email);
      return userResult[0];
    }
    // â¬†ï¸â¬†ï¸â¬†ï¸ æ–°å¢ç»“æŸ â¬†ï¸â¬†ï¸â¬†ï¸

    // OAuth ç™»å½•é€»è¾‘ï¼ˆä¿æŒåŸæ ·ï¼‰
    if (!account.type || !account.provider || !account.providerAccountId) {
      throw new Error("invalid signin account");
    }

    // ... åŸæœ‰ä»£ç ä¿æŒä¸å˜ ...
```

---

### æ­¥éª¤ 7ï¼šåˆ›å»ºæ³¨å†Œé¡µé¢ï¼ˆ30åˆ†é’Ÿï¼‰

**æ–°å»ºæ–‡ä»¶**ï¼š`src/app/[locale]/(default)/auth/register/page.tsx`

**å®Œæ•´ä»£ç **ï¼š

```typescript
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { toast } from 'sonner';
import Link from 'next/link';
import { Loader2 } from 'lucide-react';

export default function RegisterPage() {
  const router = useRouter();
  const [loading, setLoading] = useState(false);
  const [formData, setFormData] = useState({
    email: '',
    password: '',
    confirmPassword: '',
    nickname: '',
  });

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (formData.password !== formData.confirmPassword) {
      toast.error('ä¸¤æ¬¡å¯†ç è¾“å…¥ä¸ä¸€è‡´');
      return;
    }

    setLoading(true);

    try {
      const response = await fetch('/api/auth/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email: formData.email,
          password: formData.password,
          nickname: formData.nickname,
        }),
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'æ³¨å†Œå¤±è´¥');
      }

      toast.success('æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•');
      router.push('/auth/signin');
    } catch (error: any) {
      toast.error(error.message || 'æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="flex min-h-screen items-center justify-center py-12 px-4 bg-gray-50">
      <Card className="w-full max-w-md shadow-lg">
        <CardHeader className="space-y-1">
          <CardTitle className="text-2xl font-bold text-center">åˆ›å»ºè´¦å·</CardTitle>
          <CardDescription className="text-center">
            è¾“å…¥æ‚¨çš„ä¿¡æ¯åˆ›å»ºæ–°è´¦å·
          </CardDescription>
        </CardHeader>
        <CardContent>
          <form onSubmit={handleSubmit} className="space-y-4">
            <div className="space-y-2">
              <Label htmlFor="email">é‚®ç®± *</Label>
              <Input
                id="email"
                type="email"
                placeholder="[email protected]"
                value={formData.email}
                onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                required
                disabled={loading}
              />
            </div>

            <div className="space-y-2">
              <Label htmlFor="nickname">æ˜µç§°ï¼ˆå¯é€‰ï¼‰</Label>
              <Input
                id="nickname"
                type="text"
                placeholder="æ‚¨çš„æ˜µç§°"
                value={formData.nickname}
                onChange={(e) => setFormData({ ...formData, nickname: e.target.value })}
                disabled={loading}
              />
              <p className="text-xs text-gray-500">ä¸å¡«å†™å°†ä½¿ç”¨é‚®ç®±å‰ç¼€ä½œä¸ºæ˜µç§°</p>
            </div>

            <div className="space-y-2">
              <Label htmlFor="password">å¯†ç  *</Label>
              <Input
                id="password"
                type="password"
                placeholder="è‡³å°‘6ä½"
                value={formData.password}
                onChange={(e) => setFormData({ ...formData, password: e.target.value })}
                required
                disabled={loading}
              />
            </div>

            <div className="space-y-2">
              <Label htmlFor="confirmPassword">ç¡®è®¤å¯†ç  *</Label>
              <Input
                id="confirmPassword"
                type="password"
                placeholder="å†æ¬¡è¾“å…¥å¯†ç "
                value={formData.confirmPassword}
                onChange={(e) => setFormData({ ...formData, confirmPassword: e.target.value })}
                required
                disabled={loading}
              />
            </div>

            <Button type="submit" className="w-full" disabled={loading}>
              {loading ? (
                <>
                  <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                  æ³¨å†Œä¸­...
                </>
              ) : (
                'æ³¨å†Œ'
              )}
            </Button>

            <div className="text-center text-sm text-muted-foreground">
              å·²æœ‰è´¦å·ï¼Ÿ{' '}
              <Link href="/auth/signin" className="text-primary hover:underline font-medium">
                ç«‹å³ç™»å½•
              </Link>
            </div>
          </form>
        </CardContent>
      </Card>
    </div>
  );
}
```

---

### æ­¥éª¤ 8ï¼šä¿®æ”¹ç™»å½•é¡µé¢ï¼ˆ20åˆ†é’Ÿï¼‰

**ä¿®æ”¹æ–‡ä»¶**ï¼š`src/components/sign/form.tsx`

#### 8.1 å°†ç»„ä»¶æ”¹ä¸ºå®¢æˆ·ç«¯ç»„ä»¶

åœ¨æ–‡ä»¶**æœ€é¡¶éƒ¨ç¬¬ä¸€è¡Œ**æ·»åŠ ï¼š

```typescript
'use client';
```

#### 8.2 æ·»åŠ å¿…è¦çš„å¯¼å…¥

åœ¨ import éƒ¨åˆ†æ·»åŠ ï¼š

```typescript
import { useState } from 'react';
import { signIn } from 'next-auth/react';
import { toast } from 'sonner';
import Link from 'next/link';
import { Loader2 } from 'lucide-react';
```

#### 8.3 åœ¨ç»„ä»¶å†…æ·»åŠ é‚®ç®±ç™»å½•è¡¨å•

åœ¨ç°æœ‰çš„ç»„ä»¶å‡½æ•°ä¸­ï¼Œæ‰¾åˆ° Google/Github ç™»å½•æŒ‰é’®çš„ä½ç½®ï¼Œåœ¨**æœ€åé¢**æ·»åŠ ï¼š

```typescript
export default function SignForm({
  className,
  ...props
}: React.ComponentPropsWithoutRef<"div">) {
  
  // â¬‡ï¸â¬‡ï¸â¬‡ï¸ æ–°å¢ï¼šçŠ¶æ€ç®¡ç† â¬‡ï¸â¬‡ï¸â¬‡ï¸
  const [emailLogin, setEmailLogin] = useState({
    email: '',
    password: '',
    loading: false,
  });
  // â¬†ï¸â¬†ï¸â¬†ï¸ æ–°å¢ç»“æŸ â¬†ï¸â¬†ï¸â¬†ï¸
  
  return (
    <div className={cn("flex flex-col gap-6", className)} {...props}>
      {/* ... ç°æœ‰çš„ Google/Github ç™»å½•æŒ‰é’® ... */}
      
      {/* â¬‡ï¸â¬‡ï¸â¬‡ï¸ æ–°å¢ï¼šé‚®ç®±å¯†ç ç™»å½• â¬‡ï¸â¬‡ï¸â¬‡ï¸ */}
      <div className="relative my-4">
        <div className="absolute inset-0 flex items-center">
          <span className="w-full border-t" />
        </div>
        <div className="relative flex justify-center text-xs uppercase">
          <span className="bg-background px-2 text-muted-foreground">
            æˆ–ä½¿ç”¨é‚®ç®±ç™»å½•
          </span>
        </div>
      </div>

      <form
        onSubmit={async (e) => {
          e.preventDefault();
          setEmailLogin({ ...emailLogin, loading: true });

          const result = await signIn('credentials', {
            email: emailLogin.email,
            password: emailLogin.password,
            redirect: false,
          });

          if (result?.error) {
            toast.error('ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥é‚®ç®±å’Œå¯†ç ');
            setEmailLogin({ ...emailLogin, loading: false });
          } else {
            toast.success('ç™»å½•æˆåŠŸ');
            window.location.href = '/';
          }
        }}
        className="space-y-3"
      >
        <div className="space-y-2">
          <label htmlFor="email" className="text-sm font-medium">
            é‚®ç®±
          </label>
          <input
            id="email"
            name="email"
            type="email"
            placeholder="[email protected]"
            value={emailLogin.email}
            onChange={(e) => setEmailLogin({ ...emailLogin, email: e.target.value })}
            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary"
            required
            disabled={emailLogin.loading}
          />
        </div>
        <div className="space-y-2">
          <label htmlFor="password" className="text-sm font-medium">
            å¯†ç 
          </label>
          <input
            id="password"
            name="password"
            type="password"
            placeholder="è¯·è¾“å…¥å¯†ç "
            value={emailLogin.password}
            onChange={(e) => setEmailLogin({ ...emailLogin, password: e.target.value })}
            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary"
            required
            disabled={emailLogin.loading}
          />
        </div>
        <button
          type="submit"
          disabled={emailLogin.loading}
          className="w-full py-2 px-4 bg-primary text-primary-foreground rounded-md hover:bg-primary/90 disabled:opacity-50 flex items-center justify-center"
        >
          {emailLogin.loading ? (
            <>
              <Loader2 className="mr-2 h-4 w-4 animate-spin" />
              ç™»å½•ä¸­...
            </>
          ) : (
            'ç™»å½•'
          )}
        </button>
      </form>

      <div className="text-center text-sm text-muted-foreground mt-4">
        è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ{' '}
        <Link href="/auth/register" className="text-primary hover:underline font-medium">
          ç«‹å³æ³¨å†Œ
        </Link>
      </div>
      {/* â¬†ï¸â¬†ï¸â¬†ï¸ æ–°å¢ç»“æŸ â¬†ï¸â¬†ï¸â¬†ï¸ */}
    </div>
  );
}
```

---

### æ­¥éª¤ 9ï¼šä¿®æ”¹ç”¨æˆ·åˆ—è¡¨æ˜¾ç¤ºå¯†ç ï¼ˆ15åˆ†é’Ÿï¼‰â­

**ä¿®æ”¹æ–‡ä»¶**ï¼š`src/app/[locale]/(admin)/admin/users/page.tsx`

**å®Œæ•´ä»£ç **ï¼ˆæ›¿æ¢æ•´ä¸ªæ–‡ä»¶ï¼‰ï¼š

```typescript
import { TableColumn } from '@/types/blocks/table';
import TableSlot from '@/components/dashboard/slots/table';
import { Table as TableSlotType } from '@/types/slots/table';
import { getUsers } from '@/models/user';
import { decryptPassword } from '@/lib/password';
import moment from 'moment';

export default async function UsersPage() {
  const users = await getUsers(1, 100);

  const columns: TableColumn[] = [
    { 
      name: "email", 
      title: "é‚®ç®±",
      className: "font-medium"
    },
    { 
      name: "nickname", 
      title: "æ˜µç§°" 
    },
    
    // â­ æ ¸å¿ƒåŠŸèƒ½ï¼šæ˜¾ç¤ºå¯†ç æ˜æ–‡
    {
      name: "password_encrypted",
      title: "å¯†ç ï¼ˆæ˜æ–‡ï¼‰",
      callback: (row) => {
        if (row.password_encrypted) {
          const plainPassword = decryptPassword(row.password_encrypted);
          return (
            <div className="flex items-center gap-2">
              <span className="font-mono bg-yellow-50 px-2 py-1 rounded text-sm border border-yellow-200 text-yellow-900">
                {plainPassword || 'è§£å¯†å¤±è´¥'}
              </span>
            </div>
          );
        }
        return <span className="text-gray-400 text-sm">OAuthç”¨æˆ·</span>;
      },
    },
    
    // è´¦å·ç±»å‹
    {
      name: "account_type",
      title: "è´¦å·ç±»å‹",
      callback: (row) => {
        if (row.account_type === 'email') {
          return (
            <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
              é‚®ç®±å¯†ç 
            </span>
          );
        }
        return (
          <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
            OAuth
          </span>
        );
      },
    },
    
    { 
      name: "credits", 
      title: "ç§¯åˆ†",
      callback: (row) => (
        <span className="font-semibold text-orange-600">{row.credits}</span>
      ),
    },
    
    {
      name: "avatar_url",
      title: "å¤´åƒ",
      callback: (row) => (
        row.avatar_url ? (
          <img 
            src={row.avatar_url} 
            className="w-10 h-10 rounded-full object-cover" 
            alt="avatar" 
          />
        ) : (
          <div className="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 text-xs font-semibold">
            {row.nickname?.charAt(0)?.toUpperCase() || '?'}
          </div>
        )
      ),
    },
    
    {
      name: "created_at",
      title: "æ³¨å†Œæ—¶é—´",
      callback: (row) => (
        <span className="text-sm text-gray-600">
          {moment(row.created_at).format("YYYY-MM-DD HH:mm")}
        </span>
      ),
    },
  ];

  const table: TableSlotType = {
    title: "ç”¨æˆ·åˆ—è¡¨",
    description: "ç®¡ç†æ‰€æœ‰æ³¨å†Œç”¨æˆ·ï¼ˆå¯†ç ä»¥æ˜æ–‡æ˜¾ç¤ºï¼‰",
    columns,
    data: users,
  };

  return <TableSlot {...table} />;
}
```

---

### æ­¥éª¤ 10ï¼šé…ç½®ç¯å¢ƒå˜é‡ï¼ˆ5åˆ†é’Ÿï¼‰

**ä¿®æ”¹æ–‡ä»¶**ï¼š`.env`

åœ¨æ–‡ä»¶ä¸­æ·»åŠ æˆ–ä¿®æ”¹ä»¥ä¸‹é…ç½®ï¼š

```bash
# ========================================
# ç®¡ç†å‘˜é…ç½®
# ========================================

# ç®¡ç†å‘˜é‚®ç®±ï¼ˆå¿…éœ€ï¼‰
# å‚è€ƒï¼šhttps://docs.shipany.ai/zh/admin-system/admin
# å¤šä¸ªç®¡ç†å‘˜ç”¨é€—å·åˆ†éš”
ADMIN_EMAILS = "[email protected]"

# ========================================
# å¯†ç åŠ å¯†å¯†é’¥ï¼ˆå¿…éœ€ï¼‰
# ========================================

# ç”¨äº AES åŠ å¯†/è§£å¯†ç”¨æˆ·å¯†ç 
# âš ï¸ é‡è¦ï¼šè¯·ç”Ÿæˆéšæœºå¯†é’¥å¹¶å¦¥å–„ä¿ç®¡
# ç”Ÿæˆæ–¹æ³•ï¼šopenssl rand -base64 32
PASSWORD_SECRET_KEY = "your-very-secret-key-change-this-to-random-string"
```

**ç”Ÿæˆéšæœºå¯†é’¥**ï¼š

```bash
openssl rand -base64 32
```

å°†ç”Ÿæˆçš„éšæœºå­—ç¬¦ä¸²æ›¿æ¢ `your-very-secret-key-change-this-to-random-string`

---

### æ­¥éª¤ 11ï¼šé‡å¯åº”ç”¨ï¼ˆ5åˆ†é’Ÿï¼‰

```bash
pm2 restart ship-haopengyou
```

æˆ–

```bash
npm run dev
```

---

## âœ… åŠŸèƒ½æµ‹è¯•æ¸…å•

### æµ‹è¯• 1ï¼šç”¨æˆ·æ³¨å†Œ

1. è®¿é—®ï¼š`http://139.199.212.38:3005/auth/register`
2. è¾“å…¥ï¼š
   - é‚®ç®±ï¼š`test@example.com`
   - æ˜µç§°ï¼š`æµ‹è¯•ç”¨æˆ·`
   - å¯†ç ï¼š`123456`
   - ç¡®è®¤å¯†ç ï¼š`123456`
3. ç‚¹å‡»"æ³¨å†Œ"
4. âœ… åº”è¯¥è·³è½¬åˆ°ç™»å½•é¡µé¢ï¼Œæ˜¾ç¤º"æ³¨å†ŒæˆåŠŸ"

### æµ‹è¯• 2ï¼šç”¨æˆ·ç™»å½•

1. è®¿é—®ï¼š`http://139.199.212.38:3005/auth/signin`
2. è¾“å…¥ï¼š
   - é‚®ç®±ï¼š`test@example.com`
   - å¯†ç ï¼š`123456`
3. ç‚¹å‡»"ç™»å½•"
4. âœ… åº”è¯¥è·³è½¬åˆ°é¦–é¡µï¼Œæ˜¾ç¤ºå·²ç™»å½•çŠ¶æ€

### æµ‹è¯• 3ï¼šæ³¨å†Œç®¡ç†å‘˜è´¦å·

1. è®¿é—®ï¼š`http://139.199.212.38:3005/auth/register`
2. ä½¿ç”¨ `.env` ä¸­é…ç½®çš„ç®¡ç†å‘˜é‚®ç®±æ³¨å†Œ
3. è®¾ç½®å¯†ç å¹¶å®Œæˆæ³¨å†Œ

### æµ‹è¯• 4ï¼šç®¡ç†å‘˜æŸ¥çœ‹ç”¨æˆ·å¯†ç 

1. ç”¨ç®¡ç†å‘˜é‚®ç®±ç™»å½•
2. è®¿é—®ï¼š`http://139.199.212.38:3005/admin/users`
3. âœ… åº”è¯¥çœ‹åˆ°ç”¨æˆ·åˆ—è¡¨ï¼ŒåŒ…æ‹¬ï¼š
   - é‚®ç®±
   - æ˜µç§°
   - **å¯†ç ï¼ˆæ˜æ–‡æ˜¾ç¤ºï¼‰** â­
   - è´¦å·ç±»å‹
   - ç§¯åˆ†
   - å¤´åƒ
   - æ³¨å†Œæ—¶é—´

**é¢„æœŸæ•ˆæœ**ï¼š

| é‚®ç®± | æ˜µç§° | å¯†ç ï¼ˆæ˜æ–‡ï¼‰ | è´¦å·ç±»å‹ | ç§¯åˆ† |
|------|------|-------------|----------|------|
| test@example.com | æµ‹è¯•ç”¨æˆ· | `123456` | é‚®ç®±å¯†ç  | 100 |
| admin@qq.com | ç®¡ç†å‘˜ | `admin123` | é‚®ç®±å¯†ç  | 100 |

### æµ‹è¯• 5ï¼šéç®¡ç†å‘˜æ— æ³•è®¿é—®

1. ç”¨éç®¡ç†å‘˜é‚®ç®±ç™»å½•
2. è®¿é—®ï¼š`http://139.199.212.38:3005/admin`
3. âœ… åº”è¯¥æ˜¾ç¤º "No access"

---

## ğŸ“Š æ–‡ä»¶æ¸…å•æ€»ç»“

### æ–°å»ºæ–‡ä»¶ï¼ˆ3ä¸ªï¼‰

| æ–‡ä»¶ | ä½œç”¨ | è¡Œæ•° |
|------|------|------|
| `src/lib/password.ts` | å¯†ç åŠ å¯†/è§£å¯†å·¥å…· | ~60è¡Œ |
| `src/app/api/auth/register/route.ts` | ç”¨æˆ·æ³¨å†ŒAPI | ~75è¡Œ |
| `src/app/[locale]/(default)/auth/register/page.tsx` | æ³¨å†Œé¡µé¢UI | ~120è¡Œ |

### ä¿®æ”¹æ–‡ä»¶ï¼ˆ5ä¸ªï¼‰

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | ä½ç½® |
|------|---------|------|
| `src/db/schema.ts` | æ·»åŠ å¯†ç å­—æ®µ | users è¡¨å®šä¹‰ |
| `src/auth/config.ts` | æ·»åŠ é‚®ç®±ç™»å½• | providers æ•°ç»„ |
| `src/auth/handler.ts` | å¤„ç†é‚®ç®±ç™»å½• | handleSignInUser å‡½æ•° |
| `src/components/sign/form.tsx` | æ·»åŠ ç™»å½•è¡¨å• | ç»„ä»¶åº•éƒ¨ |
| `src/app/[locale]/(admin)/admin/users/page.tsx` | æ˜¾ç¤ºå¯†ç åˆ— | å®Œæ•´æ›¿æ¢ |

### é…ç½®æ–‡ä»¶ï¼ˆ1ä¸ªï¼‰

| æ–‡ä»¶ | é…ç½®é¡¹ |
|------|--------|
| `.env` | `ADMIN_EMAILS`ã€`PASSWORD_SECRET_KEY` |

---

## ğŸ” å®‰å…¨è¯´æ˜

### AES åŠ å¯†ç‰¹ç‚¹

**ä¼˜ç‚¹**ï¼š
- âœ… ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹ç”¨æˆ·å¯†ç 
- âœ… ç”¨æˆ·å¿˜è®°å¯†ç ï¼Œç®¡ç†å‘˜å¯ä»¥ç›´æ¥å‘Šè¯‰ä»–
- âœ… æ•°æ®åº“æ³„éœ²ï¼Œå¯†ç ä»æœ‰ä¸€å®šä¿æŠ¤ï¼ˆéœ€è¦å¯†é’¥ï¼‰

**ç¼ºç‚¹**ï¼š
- âš ï¸ å¦‚æœå¯†é’¥æ³„éœ²ï¼Œæ‰€æœ‰å¯†ç å¯è¢«è§£å¯†
- âš ï¸ ç®¡ç†å‘˜èƒ½çœ‹åˆ°æ‰€æœ‰å¯†ç ï¼ˆéšç§è€ƒè™‘ï¼‰
- âš ï¸ ä¸ç¬¦åˆè¡Œä¸šå®‰å…¨æœ€ä½³å®è·µï¼ˆæ ‡å‡†åšæ³•æ˜¯ bcrypt å•å‘åŠ å¯†ï¼‰

### å¯†é’¥ç®¡ç†

**é‡è¦**ï¼š
1. âœ… å¯†é’¥å¿…é¡»éšæœºç”Ÿæˆ
2. âœ… å¯†é’¥å¿…é¡»ä¿å¯†
3. âœ… å¯†é’¥å¿…é¡»å¤‡ä»½ï¼ˆä¸¢å¤±åˆ™æ— æ³•è§£å¯†ï¼‰
4. âŒ å¯†é’¥ä¸èƒ½æ³„éœ²
5. âŒ å¯†é’¥ä¸èƒ½æäº¤åˆ° Git

---

## ğŸ¯ å®Œæˆæ ‡å‡†

### åŠŸèƒ½å®Œæˆæ ‡å‡†

- [ ] ç”¨æˆ·å¯ä»¥æ³¨å†Œï¼ˆé‚®ç®±+å¯†ç ï¼‰
- [ ] ç”¨æˆ·å¯ä»¥ç™»å½•ï¼ˆé‚®ç®±+å¯†ç ï¼‰
- [ ] å¯†ç åŠ å¯†å­˜å‚¨åœ¨æ•°æ®åº“
- [ ] ç®¡ç†å‘˜é…ç½®äº†é‚®ç®±
- [ ] ç®¡ç†å‘˜å¯ä»¥è®¿é—® `/admin/users`
- [ ] ç®¡ç†å‘˜å¯ä»¥çœ‹åˆ°ç”¨æˆ·å¯†ç æ˜æ–‡

### ä»£ç å®Œæˆæ ‡å‡†

- [ ] æ‰€æœ‰æ–°æ–‡ä»¶å·²åˆ›å»º
- [ ] æ‰€æœ‰ä¿®æ”¹æ–‡ä»¶å·²æ›´æ–°
- [ ] æ•°æ®åº“ Schema å·²æ›´æ–°
- [ ] ç¯å¢ƒå˜é‡å·²é…ç½®
- [ ] åº”ç”¨å·²é‡å¯

### æµ‹è¯•å®Œæˆæ ‡å‡†

- [ ] æ³¨å†ŒåŠŸèƒ½æµ‹è¯•é€šè¿‡
- [ ] ç™»å½•åŠŸèƒ½æµ‹è¯•é€šè¿‡
- [ ] ç®¡ç†å‘˜åå°è®¿é—®æµ‹è¯•é€šè¿‡
- [ ] å¯†ç æ˜æ–‡æ˜¾ç¤ºæµ‹è¯•é€šè¿‡
- [ ] éç®¡ç†å‘˜æ— æ³•è®¿é—®æµ‹è¯•é€šè¿‡

---

## ğŸš€ å¼€å§‹å®æ–½ç¡®è®¤

è¯·ç¡®è®¤ä»¥ä¸‹å†…å®¹ï¼š

### âœ… åŠŸèƒ½éœ€æ±‚ç¡®è®¤

- [ ] ç”¨æˆ·å¯†ç ä½¿ç”¨ AES åŠ å¯†ï¼ˆå¯é€†ï¼‰
- [ ] ç®¡ç†å‘˜å¯ä»¥åœ¨åå°çœ‹åˆ°å¯†ç æ˜æ–‡
- [ ] ä¸éœ€è¦é‚®ç®±éªŒè¯åŠŸèƒ½
- [ ] ä¸éœ€è¦å¿˜è®°å¯†ç åŠŸèƒ½

### âœ… æŠ€æœ¯æ–¹æ¡ˆç¡®è®¤

- [ ] ä½¿ç”¨ crypto-js è¿›è¡Œ AES åŠ å¯†
- [ ] ä½¿ç”¨ next-auth è¿›è¡Œè®¤è¯
- [ ] å¯†é’¥å­˜å‚¨åœ¨ç¯å¢ƒå˜é‡ä¸­
- [ ] ç®¡ç†åå°å·²å­˜åœ¨ï¼Œåªéœ€ä¿®æ”¹ç”¨æˆ·åˆ—è¡¨

### âœ… å®‰å…¨é£é™©ç¡®è®¤

- [ ] ç†è§£ AES åŠ å¯†çš„ä¼˜ç¼ºç‚¹
- [ ] ç†è§£å¯†é’¥æ³„éœ²çš„é£é™©
- [ ] ç†è§£ç®¡ç†å‘˜èƒ½çœ‹åˆ°æ‰€æœ‰å¯†ç 
- [ ] æ„¿æ„æ¥å—è¿™ç§å®‰å…¨æ¨¡å‹

---

## ğŸ“ å®æ–½æ”¯æŒ

å‡†å¤‡å¥½å¼€å§‹å®æ–½äº†å—ï¼Ÿ

**é¢„è®¡è€—æ—¶**ï¼š2-3å°æ—¶  
**éš¾åº¦ç­‰çº§**ï¼šâ­â­ ä¸­ç­‰  
**æˆåŠŸç‡**ï¼š95%+

**æˆ‘å¯ä»¥å¸®æ‚¨**ï¼š
1. âœ… é€æ­¥æ‰§è¡Œæ¯ä¸ªæ­¥éª¤
2. âœ… åˆ›å»ºæ‰€æœ‰æ–°æ–‡ä»¶
3. âœ… ä¿®æ”¹æ‰€æœ‰ç°æœ‰æ–‡ä»¶
4. âœ… é…ç½®ç¯å¢ƒå˜é‡
5. âœ… æµ‹è¯•æ‰€æœ‰åŠŸèƒ½
6. âœ… è§£å†³é‡åˆ°çš„é—®é¢˜

---

**è¯·ç¡®è®¤æ–¹æ¡ˆåå›å¤ "å¼€å§‹å®æ–½"ï¼** ğŸš€

æˆ–è€…å¦‚æœéœ€è¦ä¿®æ”¹æ–¹æ¡ˆï¼Œè¯·å‘Šè¯‰æˆ‘å…·ä½“éœ€è¦è°ƒæ•´çš„åœ°æ–¹ã€‚






