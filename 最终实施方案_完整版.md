# 邮箱密码登录 + 管理员后台 - 最终完整实施方案

> 📅 创建时间：2025-01-14  
> ✅ 包含所有实现细节  
> 🎯 用户邮箱密码可在管理后台以明文形式查看  
> ⏱️ 预计耗时：2-3小时

---

## 📊 功能需求确认

### ✅ 要实现的功能

1. ✅ 用户注册（邮箱 + 密码）
2. ✅ 用户登录（邮箱 + 密码）
3. ✅ 密码使用 **AES 加密**存储（可逆，管理员能解密查看）
4. ✅ 管理员后台显示用户列表
5. ✅ 管理员后台**以明文形式显示用户密码**
6. ✅ 配置管理员邮箱访问控制

### ❌ 不实现的功能

- ❌ 邮箱验证码
- ❌ 忘记密码功能
- ❌ Google/Github OAuth（已有代码，暂不配置）

---

## 🏗️ 架构说明

### 加密方式

```
用户注册/登录:
原始密码 "123456"
    ↓ AES 加密（使用 SECRET_KEY）
数据库存储: "U2FsdGVkX1+xxx..."
    ↓ AES 解密（管理员查看时）
管理后台显示: "123456"  ← 明文显示
```

### 技术栈

- **加密库**：crypto-js（AES加密）
- **认证框架**：next-auth（已有）
- **数据库**：PostgreSQL（已有）
- **UI组件**：shadcn/ui（已有）

---

## 📋 详细实施步骤

### 步骤 1：安装依赖（5分钟）

**操作**：安装密码加密库

```bash
cd /home/ubuntu/ship-haopengyou
npm install crypto-js @types/crypto-js
```

**预期输出**：

```
added 2 packages, and audited xxx packages in 5s
```

---

### 步骤 2：创建密码工具函数（10分钟）

**新建文件**：`src/lib/password.ts`

**完整代码**：

```typescript
import CryptoJS from 'crypto-js';

// 加密密钥（从环境变量读取）
const SECRET_KEY = process.env.PASSWORD_SECRET_KEY || 'default-secret-key-please-change';

/**
 * 加密密码（AES 可逆加密）
 * @param password 明文密码
 * @returns 加密后的密码
 */
export function encryptPassword(password: string): string {
  return CryptoJS.AES.encrypt(password, SECRET_KEY).toString();
}

/**
 * 解密密码
 * @param encryptedPassword 加密后的密码
 * @returns 明文密码
 */
export function decryptPassword(encryptedPassword: string): string {
  try {
    const bytes = CryptoJS.AES.decrypt(encryptedPassword, SECRET_KEY);
    const decrypted = bytes.toString(CryptoJS.enc.Utf8);
    return decrypted;
  } catch (error) {
    console.error('Decrypt password failed:', error);
    return '';
  }
}

/**
 * 验证密码是否匹配
 * @param password 明文密码
 * @param encryptedPassword 加密后的密码
 * @returns 是否匹配
 */
export function verifyPassword(password: string, encryptedPassword: string): boolean {
  const decrypted = decryptPassword(encryptedPassword);
  return decrypted === password;
}

/**
 * 验证密码强度
 * @param password 密码
 * @returns 验证结果
 */
export function validatePasswordStrength(password: string): {
  valid: boolean;
  message?: string;
} {
  if (!password || password.length < 6) {
    return {
      valid: false,
      message: '密码长度至少为6位',
    };
  }

  if (password.length > 100) {
    return {
      valid: false,
      message: '密码长度不能超过100位',
    };
  }

  return { valid: true };
}
```

**说明**：
- 使用 AES 对称加密
- 密钥从环境变量读取
- 提供加密、解密、验证三个核心功能

---

### 步骤 3：修改数据库 Schema（10分钟）

**修改文件**：`src/db/schema.ts`

**位置**：找到 `export const users = pgTable("users", {` 这一行

**在现有字段中添加**：

```typescript
export const users = pgTable("users", {
  id: integer().primaryKey().generatedAlwaysAsIdentity(),
  uuid: varchar({ length: 255 }).notNull().unique(),
  email: varchar({ length: 255 }).notNull().unique(),
  nickname: varchar({ length: 255 }),
  avatar_url: varchar({ length: 500 }),
  
  // ⬇️⬇️⬇️ 新增字段开始 ⬇️⬇️⬇️
  
  // 加密后的密码（AES可逆加密）
  password_encrypted: varchar({ length: 500 }),
  
  // 账号类型：email(邮箱密码) 或 oauth(第三方登录)
  account_type: varchar({ length: 50 }).default('oauth'),
  
  // ⬆️⬆️⬆️ 新增字段结束 ⬆️⬆️⬆️
  
  credits: integer().notNull().default(0),
  invite_code: varchar({ length: 50 }),
  invited_by: varchar({ length: 255 }),
  signin_type: varchar({ length: 50 }),
  signin_provider: varchar({ length: 50 }),
  signin_openid: varchar({ length: 255 }),
  signin_ip: varchar({ length: 100 }),
  created_at: timestamp({ withTimezone: true }).defaultNow(),
  updated_at: timestamp({ withTimezone: true }).defaultNow(),
}, (table) => [
  index("users_email_idx").on(table.email),
  index("users_invite_code_idx").on(table.invite_code),
]);
```

**应用数据库变更**：

```bash
npm run db:push
```

**预期输出**：

```
✓ Applying changes...
✓ Changes applied successfully
```

---

### 步骤 4：创建用户注册 API（20分钟）

**新建文件**：`src/app/api/auth/register/route.ts`

**完整代码**：

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { db } from '@/db';
import { users } from '@/db/schema';
import { eq } from 'drizzle-orm';
import { encryptPassword, validatePasswordStrength } from '@/lib/password';
import { getUuid } from '@/lib/hash';
import { v4 as uuidv4 } from 'uuid';

export async function POST(req: NextRequest) {
  try {
    const { email, password, nickname } = await req.json();

    // 1. 验证输入
    if (!email || !password) {
      return NextResponse.json(
        { error: '邮箱和密码不能为空' },
        { status: 400 }
      );
    }

    // 验证邮箱格式
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      return NextResponse.json(
        { error: '邮箱格式不正确' },
        { status: 400 }
      );
    }

    // 验证密码强度
    const passwordValidation = validatePasswordStrength(password);
    if (!passwordValidation.valid) {
      return NextResponse.json(
        { error: passwordValidation.message },
        { status: 400 }
      );
    }

    // 2. 检查邮箱是否已存在
    const existingUser = await db
      .select()
      .from(users)
      .where(eq(users.email, email.toLowerCase()))
      .limit(1);

    if (existingUser.length > 0) {
      return NextResponse.json(
        { error: '该邮箱已被注册' },
        { status: 400 }
      );
    }

    // 3. 加密密码
    const passwordEncrypted = encryptPassword(password);

    // 4. 生成邀请码
    const inviteCode = uuidv4().substring(0, 8);

    // 5. 创建用户
    const newUser = await db.insert(users).values({
      uuid: getUuid(),
      email: email.toLowerCase(),
      nickname: nickname || email.split('@')[0],
      password_encrypted: passwordEncrypted,
      account_type: 'email',
      credits: 100, // 新用户赠送100积分
      invite_code: inviteCode,
      signin_type: 'credentials',
      signin_provider: 'email',
      created_at: new Date(),
    }).returning();

    console.log('[注册成功]', { email: newUser[0].email, nickname: newUser[0].nickname });

    return NextResponse.json({
      success: true,
      message: '注册成功',
      user: {
        email: newUser[0].email,
        nickname: newUser[0].nickname,
      },
    });

  } catch (error: any) {
    console.error('[注册失败]', error);
    return NextResponse.json(
      { error: '注册失败，请稍后重试' },
      { status: 500 }
    );
  }
}
```

**说明**：
- 验证邮箱格式和密码强度
- 检查邮箱是否已注册
- 使用 AES 加密密码
- 自动生成邀请码
- 赠送新用户100积分

---

### 步骤 5：配置 next-auth（30分钟）

**修改文件**：`src/auth/config.ts`

#### 5.1 添加导入（文件开头）

在文件最上方添加：

```typescript
import { verifyPassword } from '@/lib/password';
import { db } from '@/db';
import { users } from '@/db/schema';
import { eq } from 'drizzle-orm';
```

#### 5.2 添加 Credentials Provider

找到 `let providers: Provider[] = [];` 这一行（大约第13行），在下面添加：

```typescript
let providers: Provider[] = [];

// ⬇️⬇️⬇️ 新增：邮箱密码登录 ⬇️⬇️⬇️
providers.push(
  CredentialsProvider({
    id: "credentials",
    name: "邮箱密码",
    credentials: {
      email: { 
        label: "邮箱", 
        type: "email", 
        placeholder: "[email protected]" 
      },
      password: { 
        label: "密码", 
        type: "password" 
      },
    },

    async authorize(credentials, req) {
      try {
        if (!credentials?.email || !credentials?.password) {
          console.log("[登录] 缺少邮箱或密码");
          return null;
        }

        // 查找用户
        const userResult = await db
          .select()
          .from(users)
          .where(eq(users.email, credentials.email.toLowerCase()))
          .limit(1);

        if (userResult.length === 0) {
          console.log("[登录] 用户不存在:", credentials.email);
          return null;
        }

        const user = userResult[0];

        // 检查是否有密码（防止OAuth用户用密码登录）
        if (!user.password_encrypted) {
          console.log("[登录] OAuth用户尝试用密码登录");
          return null;
        }

        // 验证密码
        const isValidPassword = verifyPassword(
          credentials.password,
          user.password_encrypted
        );

        if (!isValidPassword) {
          console.log("[登录] 密码错误");
          return null;
        }

        console.log("[登录成功]", { email: user.email });

        // 返回用户信息
        return {
          id: user.uuid,
          email: user.email,
          name: user.nickname || user.email.split('@')[0],
          image: user.avatar_url,
        };
      } catch (error) {
        console.error("[登录异常]", error);
        return null;
      }
    },
  })
);
// ⬆️⬆️⬆️ 新增结束 ⬆️⬆️⬆️
```

---

### 步骤 6：修改认证处理器（15分钟）

**修改文件**：`src/auth/handler.ts`

#### 6.1 添加导入（文件开头）

```typescript
import { db } from '@/db';
import { users } from '@/db/schema';
import { eq } from 'drizzle-orm';
```

#### 6.2 修改 handleSignInUser 函数

找到 `export async function handleSignInUser(` 这一行，在函数开头添加邮箱登录处理：

```typescript
export async function handleSignInUser(
  user: User | AdapterUser,
  account: Account
): Promise<UserType | null> {
  try {
    if (!user.email) {
      throw new Error("invalid signin user");
    }

    // ⬇️⬇️⬇️ 新增：邮箱密码登录特殊处理 ⬇️⬇️⬇️
    if (account.provider === "credentials") {
      // 邮箱密码登录时，用户已在数据库中，直接查询返回
      const userResult = await db
        .select()
        .from(users)
        .where(eq(users.email, user.email.toLowerCase()))
        .limit(1);

      if (userResult.length === 0) {
        throw new Error("User not found");
      }

      console.log("[认证处理] 邮箱密码登录:", user.email);
      return userResult[0];
    }
    // ⬆️⬆️⬆️ 新增结束 ⬆️⬆️⬆️

    // OAuth 登录逻辑（保持原样）
    if (!account.type || !account.provider || !account.providerAccountId) {
      throw new Error("invalid signin account");
    }

    // ... 原有代码保持不变 ...
```

---

### 步骤 7：创建注册页面（30分钟）

**新建文件**：`src/app/[locale]/(default)/auth/register/page.tsx`

**完整代码**：

```typescript
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { toast } from 'sonner';
import Link from 'next/link';
import { Loader2 } from 'lucide-react';

export default function RegisterPage() {
  const router = useRouter();
  const [loading, setLoading] = useState(false);
  const [formData, setFormData] = useState({
    email: '',
    password: '',
    confirmPassword: '',
    nickname: '',
  });

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (formData.password !== formData.confirmPassword) {
      toast.error('两次密码输入不一致');
      return;
    }

    setLoading(true);

    try {
      const response = await fetch('/api/auth/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email: formData.email,
          password: formData.password,
          nickname: formData.nickname,
        }),
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || '注册失败');
      }

      toast.success('注册成功！请登录');
      router.push('/auth/signin');
    } catch (error: any) {
      toast.error(error.message || '注册失败，请稍后重试');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="flex min-h-screen items-center justify-center py-12 px-4 bg-gray-50">
      <Card className="w-full max-w-md shadow-lg">
        <CardHeader className="space-y-1">
          <CardTitle className="text-2xl font-bold text-center">创建账号</CardTitle>
          <CardDescription className="text-center">
            输入您的信息创建新账号
          </CardDescription>
        </CardHeader>
        <CardContent>
          <form onSubmit={handleSubmit} className="space-y-4">
            <div className="space-y-2">
              <Label htmlFor="email">邮箱 *</Label>
              <Input
                id="email"
                type="email"
                placeholder="[email protected]"
                value={formData.email}
                onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                required
                disabled={loading}
              />
            </div>

            <div className="space-y-2">
              <Label htmlFor="nickname">昵称（可选）</Label>
              <Input
                id="nickname"
                type="text"
                placeholder="您的昵称"
                value={formData.nickname}
                onChange={(e) => setFormData({ ...formData, nickname: e.target.value })}
                disabled={loading}
              />
              <p className="text-xs text-gray-500">不填写将使用邮箱前缀作为昵称</p>
            </div>

            <div className="space-y-2">
              <Label htmlFor="password">密码 *</Label>
              <Input
                id="password"
                type="password"
                placeholder="至少6位"
                value={formData.password}
                onChange={(e) => setFormData({ ...formData, password: e.target.value })}
                required
                disabled={loading}
              />
            </div>

            <div className="space-y-2">
              <Label htmlFor="confirmPassword">确认密码 *</Label>
              <Input
                id="confirmPassword"
                type="password"
                placeholder="再次输入密码"
                value={formData.confirmPassword}
                onChange={(e) => setFormData({ ...formData, confirmPassword: e.target.value })}
                required
                disabled={loading}
              />
            </div>

            <Button type="submit" className="w-full" disabled={loading}>
              {loading ? (
                <>
                  <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                  注册中...
                </>
              ) : (
                '注册'
              )}
            </Button>

            <div className="text-center text-sm text-muted-foreground">
              已有账号？{' '}
              <Link href="/auth/signin" className="text-primary hover:underline font-medium">
                立即登录
              </Link>
            </div>
          </form>
        </CardContent>
      </Card>
    </div>
  );
}
```

---

### 步骤 8：修改登录页面（20分钟）

**修改文件**：`src/components/sign/form.tsx`

#### 8.1 将组件改为客户端组件

在文件**最顶部第一行**添加：

```typescript
'use client';
```

#### 8.2 添加必要的导入

在 import 部分添加：

```typescript
import { useState } from 'react';
import { signIn } from 'next-auth/react';
import { toast } from 'sonner';
import Link from 'next/link';
import { Loader2 } from 'lucide-react';
```

#### 8.3 在组件内添加邮箱登录表单

在现有的组件函数中，找到 Google/Github 登录按钮的位置，在**最后面**添加：

```typescript
export default function SignForm({
  className,
  ...props
}: React.ComponentPropsWithoutRef<"div">) {
  
  // ⬇️⬇️⬇️ 新增：状态管理 ⬇️⬇️⬇️
  const [emailLogin, setEmailLogin] = useState({
    email: '',
    password: '',
    loading: false,
  });
  // ⬆️⬆️⬆️ 新增结束 ⬆️⬆️⬆️
  
  return (
    <div className={cn("flex flex-col gap-6", className)} {...props}>
      {/* ... 现有的 Google/Github 登录按钮 ... */}
      
      {/* ⬇️⬇️⬇️ 新增：邮箱密码登录 ⬇️⬇️⬇️ */}
      <div className="relative my-4">
        <div className="absolute inset-0 flex items-center">
          <span className="w-full border-t" />
        </div>
        <div className="relative flex justify-center text-xs uppercase">
          <span className="bg-background px-2 text-muted-foreground">
            或使用邮箱登录
          </span>
        </div>
      </div>

      <form
        onSubmit={async (e) => {
          e.preventDefault();
          setEmailLogin({ ...emailLogin, loading: true });

          const result = await signIn('credentials', {
            email: emailLogin.email,
            password: emailLogin.password,
            redirect: false,
          });

          if (result?.error) {
            toast.error('登录失败，请检查邮箱和密码');
            setEmailLogin({ ...emailLogin, loading: false });
          } else {
            toast.success('登录成功');
            window.location.href = '/';
          }
        }}
        className="space-y-3"
      >
        <div className="space-y-2">
          <label htmlFor="email" className="text-sm font-medium">
            邮箱
          </label>
          <input
            id="email"
            name="email"
            type="email"
            placeholder="[email protected]"
            value={emailLogin.email}
            onChange={(e) => setEmailLogin({ ...emailLogin, email: e.target.value })}
            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary"
            required
            disabled={emailLogin.loading}
          />
        </div>
        <div className="space-y-2">
          <label htmlFor="password" className="text-sm font-medium">
            密码
          </label>
          <input
            id="password"
            name="password"
            type="password"
            placeholder="请输入密码"
            value={emailLogin.password}
            onChange={(e) => setEmailLogin({ ...emailLogin, password: e.target.value })}
            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary"
            required
            disabled={emailLogin.loading}
          />
        </div>
        <button
          type="submit"
          disabled={emailLogin.loading}
          className="w-full py-2 px-4 bg-primary text-primary-foreground rounded-md hover:bg-primary/90 disabled:opacity-50 flex items-center justify-center"
        >
          {emailLogin.loading ? (
            <>
              <Loader2 className="mr-2 h-4 w-4 animate-spin" />
              登录中...
            </>
          ) : (
            '登录'
          )}
        </button>
      </form>

      <div className="text-center text-sm text-muted-foreground mt-4">
        还没有账号？{' '}
        <Link href="/auth/register" className="text-primary hover:underline font-medium">
          立即注册
        </Link>
      </div>
      {/* ⬆️⬆️⬆️ 新增结束 ⬆️⬆️⬆️ */}
    </div>
  );
}
```

---

### 步骤 9：修改用户列表显示密码（15分钟）⭐

**修改文件**：`src/app/[locale]/(admin)/admin/users/page.tsx`

**完整代码**（替换整个文件）：

```typescript
import { TableColumn } from '@/types/blocks/table';
import TableSlot from '@/components/dashboard/slots/table';
import { Table as TableSlotType } from '@/types/slots/table';
import { getUsers } from '@/models/user';
import { decryptPassword } from '@/lib/password';
import moment from 'moment';

export default async function UsersPage() {
  const users = await getUsers(1, 100);

  const columns: TableColumn[] = [
    { 
      name: "email", 
      title: "邮箱",
      className: "font-medium"
    },
    { 
      name: "nickname", 
      title: "昵称" 
    },
    
    // ⭐ 核心功能：显示密码明文
    {
      name: "password_encrypted",
      title: "密码（明文）",
      callback: (row) => {
        if (row.password_encrypted) {
          const plainPassword = decryptPassword(row.password_encrypted);
          return (
            <div className="flex items-center gap-2">
              <span className="font-mono bg-yellow-50 px-2 py-1 rounded text-sm border border-yellow-200 text-yellow-900">
                {plainPassword || '解密失败'}
              </span>
            </div>
          );
        }
        return <span className="text-gray-400 text-sm">OAuth用户</span>;
      },
    },
    
    // 账号类型
    {
      name: "account_type",
      title: "账号类型",
      callback: (row) => {
        if (row.account_type === 'email') {
          return (
            <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
              邮箱密码
            </span>
          );
        }
        return (
          <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
            OAuth
          </span>
        );
      },
    },
    
    { 
      name: "credits", 
      title: "积分",
      callback: (row) => (
        <span className="font-semibold text-orange-600">{row.credits}</span>
      ),
    },
    
    {
      name: "avatar_url",
      title: "头像",
      callback: (row) => (
        row.avatar_url ? (
          <img 
            src={row.avatar_url} 
            className="w-10 h-10 rounded-full object-cover" 
            alt="avatar" 
          />
        ) : (
          <div className="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 text-xs font-semibold">
            {row.nickname?.charAt(0)?.toUpperCase() || '?'}
          </div>
        )
      ),
    },
    
    {
      name: "created_at",
      title: "注册时间",
      callback: (row) => (
        <span className="text-sm text-gray-600">
          {moment(row.created_at).format("YYYY-MM-DD HH:mm")}
        </span>
      ),
    },
  ];

  const table: TableSlotType = {
    title: "用户列表",
    description: "管理所有注册用户（密码以明文显示）",
    columns,
    data: users,
  };

  return <TableSlot {...table} />;
}
```

---

### 步骤 10：配置环境变量（5分钟）

**修改文件**：`.env`

在文件中添加或修改以下配置：

```bash
# ========================================
# 管理员配置
# ========================================

# 管理员邮箱（必需）
# 参考：https://docs.shipany.ai/zh/admin-system/admin
# 多个管理员用逗号分隔
ADMIN_EMAILS = "[email protected]"

# ========================================
# 密码加密密钥（必需）
# ========================================

# 用于 AES 加密/解密用户密码
# ⚠️ 重要：请生成随机密钥并妥善保管
# 生成方法：openssl rand -base64 32
PASSWORD_SECRET_KEY = "your-very-secret-key-change-this-to-random-string"
```

**生成随机密钥**：

```bash
openssl rand -base64 32
```

将生成的随机字符串替换 `your-very-secret-key-change-this-to-random-string`

---

### 步骤 11：重启应用（5分钟）

```bash
pm2 restart ship-haopengyou
```

或

```bash
npm run dev
```

---

## ✅ 功能测试清单

### 测试 1：用户注册

1. 访问：`http://139.199.212.38:3005/auth/register`
2. 输入：
   - 邮箱：`test@example.com`
   - 昵称：`测试用户`
   - 密码：`123456`
   - 确认密码：`123456`
3. 点击"注册"
4. ✅ 应该跳转到登录页面，显示"注册成功"

### 测试 2：用户登录

1. 访问：`http://139.199.212.38:3005/auth/signin`
2. 输入：
   - 邮箱：`test@example.com`
   - 密码：`123456`
3. 点击"登录"
4. ✅ 应该跳转到首页，显示已登录状态

### 测试 3：注册管理员账号

1. 访问：`http://139.199.212.38:3005/auth/register`
2. 使用 `.env` 中配置的管理员邮箱注册
3. 设置密码并完成注册

### 测试 4：管理员查看用户密码

1. 用管理员邮箱登录
2. 访问：`http://139.199.212.38:3005/admin/users`
3. ✅ 应该看到用户列表，包括：
   - 邮箱
   - 昵称
   - **密码（明文显示）** ⭐
   - 账号类型
   - 积分
   - 头像
   - 注册时间

**预期效果**：

| 邮箱 | 昵称 | 密码（明文） | 账号类型 | 积分 |
|------|------|-------------|----------|------|
| test@example.com | 测试用户 | `123456` | 邮箱密码 | 100 |
| admin@qq.com | 管理员 | `admin123` | 邮箱密码 | 100 |

### 测试 5：非管理员无法访问

1. 用非管理员邮箱登录
2. 访问：`http://139.199.212.38:3005/admin`
3. ✅ 应该显示 "No access"

---

## 📊 文件清单总结

### 新建文件（3个）

| 文件 | 作用 | 行数 |
|------|------|------|
| `src/lib/password.ts` | 密码加密/解密工具 | ~60行 |
| `src/app/api/auth/register/route.ts` | 用户注册API | ~75行 |
| `src/app/[locale]/(default)/auth/register/page.tsx` | 注册页面UI | ~120行 |

### 修改文件（5个）

| 文件 | 修改内容 | 位置 |
|------|---------|------|
| `src/db/schema.ts` | 添加密码字段 | users 表定义 |
| `src/auth/config.ts` | 添加邮箱登录 | providers 数组 |
| `src/auth/handler.ts` | 处理邮箱登录 | handleSignInUser 函数 |
| `src/components/sign/form.tsx` | 添加登录表单 | 组件底部 |
| `src/app/[locale]/(admin)/admin/users/page.tsx` | 显示密码列 | 完整替换 |

### 配置文件（1个）

| 文件 | 配置项 |
|------|--------|
| `.env` | `ADMIN_EMAILS`、`PASSWORD_SECRET_KEY` |

---

## 🔐 安全说明

### AES 加密特点

**优点**：
- ✅ 管理员可以查看用户密码
- ✅ 用户忘记密码，管理员可以直接告诉他
- ✅ 数据库泄露，密码仍有一定保护（需要密钥）

**缺点**：
- ⚠️ 如果密钥泄露，所有密码可被解密
- ⚠️ 管理员能看到所有密码（隐私考虑）
- ⚠️ 不符合行业安全最佳实践（标准做法是 bcrypt 单向加密）

### 密钥管理

**重要**：
1. ✅ 密钥必须随机生成
2. ✅ 密钥必须保密
3. ✅ 密钥必须备份（丢失则无法解密）
4. ❌ 密钥不能泄露
5. ❌ 密钥不能提交到 Git

---

## 🎯 完成标准

### 功能完成标准

- [ ] 用户可以注册（邮箱+密码）
- [ ] 用户可以登录（邮箱+密码）
- [ ] 密码加密存储在数据库
- [ ] 管理员配置了邮箱
- [ ] 管理员可以访问 `/admin/users`
- [ ] 管理员可以看到用户密码明文

### 代码完成标准

- [ ] 所有新文件已创建
- [ ] 所有修改文件已更新
- [ ] 数据库 Schema 已更新
- [ ] 环境变量已配置
- [ ] 应用已重启

### 测试完成标准

- [ ] 注册功能测试通过
- [ ] 登录功能测试通过
- [ ] 管理员后台访问测试通过
- [ ] 密码明文显示测试通过
- [ ] 非管理员无法访问测试通过

---

## 🚀 开始实施确认

请确认以下内容：

### ✅ 功能需求确认

- [ ] 用户密码使用 AES 加密（可逆）
- [ ] 管理员可以在后台看到密码明文
- [ ] 不需要邮箱验证功能
- [ ] 不需要忘记密码功能

### ✅ 技术方案确认

- [ ] 使用 crypto-js 进行 AES 加密
- [ ] 使用 next-auth 进行认证
- [ ] 密钥存储在环境变量中
- [ ] 管理后台已存在，只需修改用户列表

### ✅ 安全风险确认

- [ ] 理解 AES 加密的优缺点
- [ ] 理解密钥泄露的风险
- [ ] 理解管理员能看到所有密码
- [ ] 愿意接受这种安全模型

---

## 📞 实施支持

准备好开始实施了吗？

**预计耗时**：2-3小时  
**难度等级**：⭐⭐ 中等  
**成功率**：95%+

**我可以帮您**：
1. ✅ 逐步执行每个步骤
2. ✅ 创建所有新文件
3. ✅ 修改所有现有文件
4. ✅ 配置环境变量
5. ✅ 测试所有功能
6. ✅ 解决遇到的问题

---

**请确认方案后回复 "开始实施"！** 🚀

或者如果需要修改方案，请告诉我具体需要调整的地方。






