# 支付服务 - Creem

ShipAny 支持使用 Creem 进行支付，可用于产品付款、会员订阅、购买积分等场景。

## Creem 设置

1. 注册一个 Creem 账户
2. 在 Creem 后台创建店铺
3. 选择店铺，设置店铺经营信息
4. 在 Creem 开发者中心生成 API 密钥
5. 在 Creem 后台创建产品
6. 在 ShipAny 项目配置文件中，填写 Creem 相关的配置信息。

开发环境配置文件
生产环境配置文件

- 支付成功后跳转的页面路径
- 支付失败后跳转的页面路径
- 支付取消后跳转的页面路径

页面路径可以填相对路径，也可以填绝对路径。如果填的是相对路径，跳转时会自动拼接配置的网站地址，并带上多语言参数。

比如按照以上配置，在中文页面支付成功后的跳转路径是：

- 支付提供商，默认是，如果需要使用 Creem 支付，请设置为
- 环境，测试使用，线上使用
- Creem API 密钥，不同环境使用不同的密钥
- Creem 支付通知验证密钥，在 Creem 后台配置 Webhook 地址后，进入 Webhook 地址的管理页面，复制。
- 价格表中的 product_id 与在 Creem 后台创建的产品 ID 对应关系

比如在 ShipAny 项目中设置的价格表有三个支付方案，对应的 product_id 分别是、、，你需要在 Creem 后台为这三个方案创建对应的产品，复制每个产品的 Product ID，与价格表中的 product_id 对应关系填写到中。

## 价格表支付

ShipAny 模板内置了一个价格表和对应的支付逻辑，你可以根据自己的需求，简单修改即可快速实现支付功能。

### 配置价格表内容

ShipAny 模板内置的价格表配置文件位于：目录下，支持多语言，默认包含和两个价格表配置文件。

比如英文价格表的默认配置为：

默认的价格表预览为:

你可以根据自己的需求，修改价格表配置文件中的内容。

### 修改价格表组件

默认的价格表组件位于：

你可以根据自己的需求，修改价格表的展示形式。

### 修改价格表下单逻辑

默认的价格表下单逻辑位于：

你可以根据自己的需求，修改价格表的下单逻辑。

### 修改支付回调逻辑

在价格表下单逻辑中，默认配置的支付回调地址是：

用户支付后，会在浏览器跳转到这个地址，并带上包含支付信息的参数。

默认的支付回调处理逻辑位于：

你可以根据自己的需求，修改处理支付回调的逻辑，比如更新订单状态、给用户发送邮件通知、给用户赠送积分等。

支付回调是同步逻辑，依赖浏览器跳转到回调地址，才能处理支付结果。这种方式不太可靠，可能出现跳转过程中用户关闭了浏览器等情况，导致支付结果没有被正常处理。

更可靠的方式是通过 Webhook，配置支付结果异步通知。

### 修改支付通知逻辑

你需要先在 Creem 后台配置 Webhook 地址

比如把 Webhook 地址配置为：

用户支付后，Creem 会把支付信息推送到这个地址。

处理支付通知

默认的支付通知逻辑位于：

你可以根据自己的需求，修改处理支付通知的逻辑，比如更新订单状态、给用户发送邮件通知、给用户赠送积分等。

## 本地测试

### 开启测试模式

在 Creem 后台进入店铺，点击右上角的，开启测试模式。

### 生成测试密钥

在测试模式下，进入开发者中心，设置测试 API 密钥。

### 测试支付通知

注册 ngrok 账号，按指示安装命令行工具。

启动 ngrok 服务，监听本地端口，并生成一个临时的域名。

在 Creem 后台测试模式中，配置 Webhook 地址为 ngrok 生成的域名

Endpoint 填写支付通知地址，比如。

添加 Webhook 地址后，在 Webhook 管理页面，复制，跟支付密钥一起填入文件中。

### 测试支付

在本地启动项目，访问页面，点击下单按钮，下单成功后跳转到支付页面。

使用 Stripe 测试卡支付，支付成功后浏览器跳转到支付回调地址，监听的地址收到支付通知。

参考:
- Creem 官方文档
- Creem SDK
- Creem Webhook 配置