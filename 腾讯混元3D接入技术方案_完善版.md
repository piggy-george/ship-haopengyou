# å¥½æœ‹å‹AIé€ ç‰©å¹³å° - 3Dæ¨¡å‹ç”ŸæˆåŠŸèƒ½æŠ€æœ¯æ–¹æ¡ˆ

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

åœ¨å¥½æœ‹å‹AIé€ ç‰©å¹³å°çš„Createé¡µé¢ä¸­é›†æˆå…ˆè¿›çš„3Dæ¨¡å‹ç”ŸæˆæœåŠ¡ï¼Œä¸ºç”¨æˆ·æä¾›æ–‡ç”Ÿ3Då’Œå›¾ç”Ÿ3DåŠŸèƒ½ï¼Œæ”¯æŒå¤šè§†å›¾è¾“å…¥å’Œä¸“ä¸šçº§3Dæ¨¡å‹ç”Ÿæˆã€‚

## ğŸ¯ åŠŸèƒ½ç›®æ ‡

- **æ ¸å¿ƒåŠŸèƒ½**ï¼šæ–‡æœ¬ç”Ÿæˆ3Dã€å›¾ç‰‡ç”Ÿæˆ3Dã€å¤šè§†å›¾3Dç”Ÿæˆ
- **ç‰ˆæœ¬æ”¯æŒ**ï¼šä¸“ä¸šç‰ˆã€æé€Ÿç‰ˆï¼ˆåŸºç¡€ç‰ˆå¯é€‰ï¼‰
- **æ™ºèƒ½é˜Ÿåˆ—**ï¼šä»»åŠ¡æ’é˜Ÿå¤„ç†ï¼Œè‡ªé€‚åº”å¹¶å‘ç®¡ç†
- **æ–‡ä»¶ç®¡ç†**ï¼šå›¾ç‰‡ä¸Šä¼ ä¿å­˜ã€æ¨¡å‹æ–‡ä»¶7å¤©è¿‡æœŸè‡ªåŠ¨æ¸…ç†
- **ç§¯åˆ†ç³»ç»Ÿ**ï¼šç²¾å‡†è®¡è´¹ã€å¤±è´¥é€€æ¬¾ã€ä½™é¢æ£€æŸ¥
- **ARæ”¯æŒ**ï¼šæ”¯æŒç§»åŠ¨ç«¯ARé¢„è§ˆåŠŸèƒ½

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æŠ€æœ¯æ ˆ
- **æ¡†æ¶**ï¼šNext.js 15 + TypeScript
- **æ•°æ®åº“**ï¼šPostgreSQL + Drizzle ORM
- **å­˜å‚¨**ï¼šæ–‡ä»¶å­˜å‚¨æœåŠ¡ (ç°æœ‰storageç³»ç»Ÿ)
- **è®¤è¯**ï¼šNext-Auth (ç°æœ‰ç³»ç»Ÿ)
- **é˜Ÿåˆ—**ï¼šæ™ºèƒ½é˜Ÿåˆ—ç³»ç»Ÿ (æ”¯æŒé«˜å³°æœŸç®¡ç†)
- **3Dæ¸²æŸ“**ï¼šThree.js + AR.js
- **äº‘æœåŠ¡SDK**ï¼šè…¾è®¯äº‘å®˜æ–¹SDK

### ç›®å½•ç»“æ„
```
src/
â”œâ”€â”€ app/api/ai/generate/
â”‚   â”œâ”€â”€ text-to-3d/              # 3Dç”ŸæˆAPI
â”‚   â”‚   â”œâ”€â”€ route.ts             # ä¸»è¦æ¥å£
â”‚   â”‚   â””â”€â”€ status/route.ts      # çŠ¶æ€æŸ¥è¯¢
â”‚   â””â”€â”€ text-to-image/           # å·²æœ‰
â”œâ”€â”€ lib/ai/
â”‚   â”œâ”€â”€ model3d-service.ts       # 3Dç”ŸæˆæœåŠ¡å°è£…
â”‚   â”œâ”€â”€ cloud-sdk.ts            # äº‘æœåŠ¡SDKé›†æˆ
â”‚   â””â”€â”€ stable-diffusion.ts     # å·²æœ‰
â”œâ”€â”€ lib/queue/
â”‚   â”œâ”€â”€ model3d-queue.ts         # é˜Ÿåˆ—ç®¡ç†å™¨
â”‚   â””â”€â”€ peak-manager.ts          # é«˜å³°æœŸç®¡ç†
â”œâ”€â”€ lib/notification/
â”‚   â””â”€â”€ completion-notifier.ts   # å®Œæˆé€šçŸ¥ç³»ç»Ÿ
â”œâ”€â”€ components/ai-tools/
â”‚   â”œâ”€â”€ Model3DGenerator.tsx     # 3Dç”Ÿæˆç»„ä»¶
â”‚   â”œâ”€â”€ MultiViewUploader.tsx    # å¤šè§†å›¾ä¸Šä¼ 
â”‚   â”œâ”€â”€ Model3DViewer.tsx        # 3Dæ¨¡å‹é¢„è§ˆ
â”‚   â”œâ”€â”€ ARViewer.tsx             # ARé¢„è§ˆç»„ä»¶
â”‚   â””â”€â”€ CompletionModal.tsx      # å®Œæˆå¼¹çª—
â”œâ”€â”€ app/[locale]/(default)/create/
â”‚   â””â”€â”€ text-to-3d/page.tsx     # 3Dç”Ÿæˆé¡µé¢
â””â”€â”€ lib/tasks/
    â””â”€â”€ cleanup-expired-files.ts # æ–‡ä»¶æ¸…ç†ä»»åŠ¡
```

## ğŸ“Š æ•°æ®åº“è®¾è®¡

### æ‰©å±•ç°æœ‰è¡¨ç»“æ„

```sql
-- æ‰©å±• ai_generation_records è¡¨
ALTER TABLE ai_generation_records ADD COLUMN input_images JSON;
ALTER TABLE ai_generation_records ADD COLUMN multi_view_images JSON;
ALTER TABLE ai_generation_records ADD COLUMN cloud_job_id VARCHAR(255);
ALTER TABLE ai_generation_records ADD COLUMN queue_position INTEGER;
ALTER TABLE ai_generation_records ADD COLUMN processing_started_at TIMESTAMP;
ALTER TABLE ai_generation_records ADD COLUMN expires_at TIMESTAMP;

-- ç¤¾åŒºåŠŸèƒ½é¢„åŸ‹å­—æ®µ
ALTER TABLE ai_generation_records ADD COLUMN is_public BOOLEAN DEFAULT FALSE;
ALTER TABLE ai_generation_records ADD COLUMN share_settings JSON;
ALTER TABLE ai_generation_records ADD COLUMN community_tags JSON;
ALTER TABLE ai_generation_records ADD COLUMN like_count INTEGER DEFAULT 0;
ALTER TABLE ai_generation_records ADD COLUMN view_count INTEGER DEFAULT 0;
ALTER TABLE ai_generation_records ADD COLUMN featured BOOLEAN DEFAULT FALSE;

-- æ–°å¢æ™ºèƒ½é˜Ÿåˆ—ç®¡ç†è¡¨
CREATE TABLE model3d_queue (
  id SERIAL PRIMARY KEY,
  record_uuid VARCHAR(255) UNIQUE NOT NULL,
  user_uuid VARCHAR(255) NOT NULL,
  version VARCHAR(20) NOT NULL, -- 'basic', 'pro', 'rapid'
  priority INTEGER DEFAULT 0,
  status VARCHAR(20) DEFAULT 'waiting', -- 'waiting', 'processing', 'completed', 'failed'
  peak_period BOOLEAN DEFAULT FALSE, -- æ˜¯å¦é«˜å³°æœŸæäº¤
  estimated_time INTEGER, -- é¢„ä¼°å¤„ç†æ—¶é—´(ç§’)
  created_at TIMESTAMP DEFAULT NOW(),
  started_at TIMESTAMP,
  completed_at TIMESTAMP
);

-- 3Dæ¨¡å‹äº¤äº’è¡¨ï¼ˆç¤¾åŒºåŠŸèƒ½é¢„ç•™ï¼‰
CREATE TABLE model3d_interactions (
  id SERIAL PRIMARY KEY,
  record_uuid VARCHAR(255) NOT NULL,
  user_uuid VARCHAR(255) NOT NULL,
  interaction_type VARCHAR(50) NOT NULL, -- 'like', 'bookmark', 'comment', 'share'
  created_at TIMESTAMP DEFAULT NOW(),
  metadata JSON -- é¢å¤–æ•°æ®ï¼ˆå¦‚è¯„è®ºå†…å®¹ï¼‰
);

CREATE INDEX idx_queue_status ON model3d_queue(status);
CREATE INDEX idx_queue_created ON model3d_queue(created_at);
CREATE INDEX idx_queue_peak ON model3d_queue(peak_period);
```

## ğŸ”§ æ ¸å¿ƒæ¨¡å—è®¾è®¡

### 1. 3Dç”ŸæˆæœåŠ¡å°è£… (`src/lib/ai/model3d-service.ts`)

```typescript
// ä½¿ç”¨è…¾è®¯äº‘å®˜æ–¹SDK
import * as tencentcloud from "tencentcloud-sdk-nodejs"

export class Model3DService {
  private client: any

  constructor() {
    // åˆå§‹åŒ–è…¾è®¯äº‘SDK
    const Credential = tencentcloud.common.Credential
    const ClientProfile = tencentcloud.common.ClientProfile
    const HttpProfile = tencentcloud.common.HttpProfile

    const cred = new Credential(
      process.env.TENCENT_SECRET_ID,
      process.env.TENCENT_SECRET_KEY
    )

    const httpProfile = new HttpProfile()
    httpProfile.endpoint = "ai3d.tencentcloudapi.com"

    const clientProfile = new ClientProfile()
    clientProfile.httpProfile = httpProfile

    const Ai3dClient = tencentcloud.ai3d.v20250513.Client
    this.client = new Ai3dClient(cred, process.env.TENCENT_REGION, clientProfile)
  }

  // ç»Ÿä¸€çš„3Dç”Ÿæˆæ¥å£
  async generateModel(params: Model3DParams): Promise<JobResult> {
    try {
      const request = this.buildRequest(params)
      let response

      switch (params.version) {
        case 'basic':
          response = await this.client.SubmitHunyuanTo3DJob(request)
          break
        case 'pro':
          response = await this.client.SubmitHunyuanTo3DProJob(request)
          break
        case 'rapid':
          response = await this.client.SubmitHunyuanTo3DRapidJob(request)
          break
        default:
          throw new Error('ä¸æ”¯æŒçš„ç”Ÿæˆç‰ˆæœ¬')
      }

      return {
        jobId: response.JobId,
        requestId: response.RequestId
      }
    } catch (error) {
      throw new Error('æ¨¡å‹ç”Ÿæˆè¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•')
    }
  }

  // æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
  async queryStatus(jobId: string, version: string): Promise<JobStatus> {
    try {
      const request = { JobId: jobId }
      let response

      switch (version) {
        case 'basic':
          response = await this.client.QueryHunyuanTo3DJob(request)
          break
        case 'pro':
          response = await this.client.QueryHunyuanTo3DProJob(request)
          break
        case 'rapid':
          response = await this.client.QueryHunyuanTo3DRapidJob(request)
          break
      }

      return {
        status: response.Status,
        errorCode: response.ErrorCode,
        errorMessage: response.ErrorMessage ? 'ç”Ÿæˆè¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·é‡è¯•' : undefined,
        resultFiles: response.ResultFile3Ds,
        requestId: response.RequestId
      }
    } catch (error) {
      throw new Error('çŠ¶æ€æŸ¥è¯¢å¤±è´¥')
    }
  }

  private buildRequest(params: Model3DParams): any {
    const request: any = {}

    if (params.prompt) request.Prompt = params.prompt
    if (params.imageUrl) request.ImageUrl = params.imageUrl
    if (params.multiViewImages?.length) {
      request.MultiViewImages = params.multiViewImages
    }
    if (params.enablePBR !== undefined) request.EnablePBR = params.enablePBR
    if (params.resultFormat) request.ResultFormat = params.resultFormat

    // ä¸“ä¸šç‰ˆç‰¹æœ‰å‚æ•°
    if (params.version === 'pro') {
      if (params.generateType) request.GenerateType = params.generateType
      if (params.faceCount) request.FaceCount = params.faceCount
    }

    return request
  }
}
```

### 2. æ™ºèƒ½é˜Ÿåˆ—ç®¡ç†ç³»ç»Ÿ (`src/lib/queue/model3d-queue.ts`)

```typescript
export class SmartQueueManager {
  private static instance: SmartQueueManager
  private processingJobs = new Set<string>()
  private readonly MAX_CONCURRENT = 3
  private readonly PEAK_HOUR_START = 9  // 9ç‚¹
  private readonly PEAK_HOUR_END = 22   // 22ç‚¹

  static getInstance(): SmartQueueManager {
    if (!this.instance) {
      this.instance = new SmartQueueManager()
    }
    return this.instance
  }

  // æ·»åŠ ä»»åŠ¡åˆ°é˜Ÿåˆ—ï¼ˆæ— ç”¨æˆ·é™åˆ¶ï¼‰
  async addToQueue(recordUuid: string, version: string): Promise<void> {
    const record = await this.getGenerationRecord(recordUuid)
    if (!record) throw new Error('ç”Ÿæˆè®°å½•ä¸å­˜åœ¨')

    const isPeakPeriod = this.isPeakHour()
    const estimatedTime = this.calculateEstimatedTime(version, isPeakPeriod)

    await db.insert(model3dQueue).values({
      record_uuid: recordUuid,
      user_uuid: record.user_uuid,
      version,
      status: 'waiting',
      priority: 0, // æš‚æ—¶ä¸è®¾ç”¨æˆ·ä¼˜å…ˆçº§
      peak_period: isPeakPeriod,
      estimated_time: estimatedTime
    })

    // ç«‹å³å°è¯•å¤„ç†é˜Ÿåˆ—
    this.processQueue()
  }

  // é«˜å³°æœŸæ£€æµ‹
  private isPeakHour(): boolean {
    const hour = new Date().getHours()
    return hour >= this.PEAK_HOUR_START && hour <= this.PEAK_HOUR_END
  }

  // åŠ¨æ€è°ƒæ•´å¤„ç†èƒ½åŠ›
  private async processQueue(): Promise<void> {
    const currentLoad = this.processingJobs.size
    const isPeak = this.isPeakHour()

    // é«˜å³°æœŸå¯èƒ½éœ€è¦æ›´ä¿å®ˆçš„å¹¶å‘æ§åˆ¶
    const maxConcurrent = isPeak ? Math.max(1, this.MAX_CONCURRENT - 1) : this.MAX_CONCURRENT

    if (currentLoad >= maxConcurrent) {
      return
    }

    const waitingJobs = await db.select().from(model3dQueue)
      .where(eq(model3dQueue.status, 'waiting'))
      .orderBy(asc(model3dQueue.created_at))
      .limit(maxConcurrent - currentLoad)

    for (const job of waitingJobs) {
      if (this.processingJobs.size >= maxConcurrent) break

      this.processingJobs.add(job.record_uuid)
      this.processJob(job).finally(() => {
        this.processingJobs.delete(job.record_uuid)
        // å¤„ç†å®Œæˆåç»§ç»­å¤„ç†é˜Ÿåˆ—
        setTimeout(() => this.processQueue(), 2000)
      })
    }
  }

  // è·å–ç”¨æˆ·å‹å¥½çš„é˜Ÿåˆ—çŠ¶æ€
  async getQueueStatus(recordUuid: string): Promise<QueueStats> {
    const queueItem = await db.select().from(model3dQueue)
      .where(eq(model3dQueue.record_uuid, recordUuid))
      .limit(1)

    if (!queueItem[0]) {
      throw new Error('é˜Ÿåˆ—é¡¹ç›®ä¸å­˜åœ¨')
    }

    if (queueItem[0].status === 'processing') {
      return {
        position: 0,
        totalInQueue: 0,
        estimatedWaitTime: 0,
        message: 'æ­£åœ¨ç”Ÿæˆä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…...'
      }
    }

    if (queueItem[0].status === 'completed') {
      return {
        position: 0,
        totalInQueue: 0,
        estimatedWaitTime: 0,
        message: 'ç”Ÿæˆå·²å®Œæˆ'
      }
    }

    const position = await this.calculatePosition(queueItem[0])
    const totalInQueue = await this.getTotalInQueue()

    return {
      position: position + 1,
      totalInQueue,
      estimatedWaitTime: this.calculateWaitTime(position, queueItem[0].version),
      message: `æ’é˜Ÿä¸­ï¼Œå‰é¢è¿˜æœ‰ ${position} ä¸ªä»»åŠ¡`
    }
  }

  private calculateEstimatedTime(version: string, isPeakPeriod: boolean): number {
    const baseTimes = {
      rapid: 60,   // 1åˆ†é’Ÿ
      basic: 120,  // 2åˆ†é’Ÿ
      pro: 180     // 3åˆ†é’Ÿ
    }

    const baseTime = baseTimes[version] || 120
    return isPeakPeriod ? Math.floor(baseTime * 1.5) : baseTime
  }

  private calculateWaitTime(position: number, version: string): number {
    const avgTime = this.calculateEstimatedTime(version, this.isPeakHour())
    return Math.ceil(position * avgTime / this.MAX_CONCURRENT)
  }
}
```

### 3. å®Œæˆé€šçŸ¥ç³»ç»Ÿ (`src/lib/notification/completion-notifier.ts`)

```typescript
export class CompletionNotifier {
  // ç”Ÿæˆå®Œæˆæ—¶çš„ç»Ÿä¸€é€šçŸ¥æ¥å£
  static async notifyCompletion(recordUuid: string): Promise<void> {
    try {
      const record = await db.select().from(aiGenerationRecords)
        .where(eq(aiGenerationRecords.uuid, recordUuid))
        .limit(1)

      if (!record[0]) return

      // å‘é€æµè§ˆå™¨é€šçŸ¥
      await this.sendBrowserNotification(record[0])

      // æ›´æ–°å‰ç«¯çŠ¶æ€ï¼ˆé€šè¿‡Server-Sent Eventsï¼‰
      await this.updateFrontendStatus(record[0])

    } catch (error) {
      console.error('Notification failed:', error)
    }
  }

  private static async sendBrowserNotification(record: any): Promise<void> {
    // å®ç°æµè§ˆå™¨æ¨é€é€šçŸ¥
    // å¯ä»¥ä½¿ç”¨ Web Push API æˆ–ç®€å•çš„çŠ¶æ€æ›´æ–°
  }

  private static async updateFrontendStatus(record: any): Promise<void> {
    // é€šè¿‡ SSE æˆ– WebSocket é€šçŸ¥å‰ç«¯
    // è¿™é‡Œå¯ä»¥å®ç°å®æ—¶çŠ¶æ€æ›´æ–°
  }
}
```

### 4. ARé¢„è§ˆæ”¯æŒ (`src/components/ai-tools/ARViewer.tsx`)

```typescript
'use client'

import { useEffect, useRef, useState } from 'react'
import * as THREE from 'three'
import { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader'

interface ARViewerProps {
  modelUrl: string
  onClose: () => void
}

export function ARViewer({ modelUrl, onClose }: ARViewerProps) {
  const containerRef = useRef<HTMLDivElement>(null)
  const [isARSupported, setIsARSupported] = useState(false)
  const [isLoading, setIsLoading] = useState(true)

  useEffect(() => {
    checkARSupport()
    if (isARSupported) {
      initializeARViewer()
    }
  }, [isARSupported])

  const checkARSupport = async () => {
    if ('xr' in navigator) {
      const isSupported = await (navigator as any).xr?.isSessionSupported('immersive-ar')
      setIsARSupported(isSupported)
    } else {
      setIsARSupported(false)
    }
  }

  const initializeARViewer = async () => {
    try {
      if (!containerRef.current) return

      const scene = new THREE.Scene()
      const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000)
      const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true })

      renderer.setSize(window.innerWidth, window.innerHeight)
      renderer.xr.enabled = true
      containerRef.current.appendChild(renderer.domElement)

      // åŠ è½½3Dæ¨¡å‹
      const loader = new GLTFLoader()
      const gltf = await loader.loadAsync(modelUrl)

      const model = gltf.scene
      model.scale.setScalar(0.5)
      scene.add(model)

      // æ·»åŠ å…‰ç…§
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.6)
      scene.add(ambientLight)

      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8)
      directionalLight.position.set(1, 1, 1)
      scene.add(directionalLight)

      camera.position.z = 2

      // ARä¼šè¯
      const startAR = async () => {
        const session = await (navigator as any).xr.requestSession('immersive-ar')
        renderer.xr.setSession(session)

        session.addEventListener('end', () => {
          onClose()
        })
      }

      // æ¸²æŸ“å¾ªç¯
      const animate = () => {
        renderer.setAnimationLoop(() => {
          model.rotation.y += 0.01
          renderer.render(scene, camera)
        })
      }

      animate()
      setIsLoading(false)

      // è‡ªåŠ¨å¯åŠ¨ARï¼ˆå¦‚æœæ”¯æŒï¼‰
      if (isARSupported) {
        await startAR()
      }

    } catch (error) {
      console.error('ARåˆå§‹åŒ–å¤±è´¥:', error)
      setIsLoading(false)
    }
  }

  if (!isARSupported) {
    return (
      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div className="bg-white p-6 rounded-lg max-w-md">
          <h3 className="text-lg font-semibold mb-4">ARä¸å¯ç”¨</h3>
          <p className="text-gray-600 mb-4">
            æ‚¨çš„è®¾å¤‡æˆ–æµè§ˆå™¨ä¸æ”¯æŒARåŠŸèƒ½ã€‚è¯·ä½¿ç”¨æ”¯æŒWebXRçš„æµè§ˆå™¨åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šä½“éªŒã€‚
          </p>
          <button
            onClick={onClose}
            className="w-full bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600"
          >
            å…³é—­
          </button>
        </div>
      </div>
    )
  }

  return (
    <div className="fixed inset-0 z-50">
      <div ref={containerRef} className="w-full h-full">
        {isLoading && (
          <div className="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center">
            <div className="text-white text-lg">æ­£åœ¨åŠ è½½ARé¢„è§ˆ...</div>
          </div>
        )}

        <button
          onClick={onClose}
          className="absolute top-4 right-4 bg-white bg-opacity-80 rounded-full p-2 z-10"
        >
          âœ•
        </button>
      </div>
    </div>
  )
}
```

### 5. å®Œæˆå¼¹çª—ç»„ä»¶ (`src/components/ai-tools/CompletionModal.tsx`)

```typescript
'use client'

import { useState } from 'react'
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog'
import { Button } from '@/components/ui/button'
import { Download, Eye, Smartphone } from 'lucide-react'
import { Model3DViewer } from './Model3DViewer'
import { ARViewer } from './ARViewer'

interface CompletionModalProps {
  isOpen: boolean
  onClose: () => void
  modelData: {
    recordId: string
    modelUrl: string
    previewImage?: string
    format: string
    creditsUsed: number
  }
}

export function CompletionModal({ isOpen, onClose, modelData }: CompletionModalProps) {
  const [showViewer, setShowViewer] = useState(false)
  const [showAR, setShowAR] = useState(false)

  const handleDownload = async () => {
    try {
      const response = await fetch(modelData.modelUrl)
      const blob = await response.blob()
      const url = window.URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url
      a.download = `model_${modelData.recordId}.${modelData.format.toLowerCase()}`
      document.body.appendChild(a)
      a.click()
      document.body.removeChild(a)
      window.URL.revokeObjectURL(url)
    } catch (error) {
      console.error('ä¸‹è½½å¤±è´¥:', error)
    }
  }

  const handlePreview = () => {
    setShowViewer(true)
  }

  const handleARPreview = () => {
    setShowAR(true)
  }

  return (
    <>
      <Dialog open={isOpen} onOpenChange={onClose}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle className="flex items-center gap-2">
              ğŸ‰ 3Dæ¨¡å‹ç”Ÿæˆå®Œæˆï¼
            </DialogTitle>
          </DialogHeader>

          <div className="space-y-4">
            {modelData.previewImage && (
              <div className="w-full h-48 bg-gray-100 rounded-lg overflow-hidden">
                <img
                  src={modelData.previewImage}
                  alt="æ¨¡å‹é¢„è§ˆ"
                  className="w-full h-full object-cover"
                />
              </div>
            )}

            <div className="text-sm text-gray-600 text-center">
              ç”Ÿæˆæ ¼å¼ï¼š{modelData.format} | æ¶ˆè€—ç§¯åˆ†ï¼š{modelData.creditsUsed}
            </div>

            <div className="grid grid-cols-1 gap-3">
              <Button
                onClick={handlePreview}
                className="w-full flex items-center gap-2"
                variant="outline"
              >
                <Eye className="w-4 h-4" />
                3Dé¢„è§ˆ
              </Button>

              <Button
                onClick={handleARPreview}
                className="w-full flex items-center gap-2"
                variant="outline"
              >
                <Smartphone className="w-4 h-4" />
                ARé¢„è§ˆ
              </Button>

              <Button
                onClick={handleDownload}
                className="w-full flex items-center gap-2"
              >
                <Download className="w-4 h-4" />
                ä¸‹è½½æ¨¡å‹
              </Button>
            </div>

            <div className="text-xs text-gray-500 text-center">
              æ–‡ä»¶å°†åœ¨7å¤©åè‡ªåŠ¨è¿‡æœŸï¼Œè¯·åŠæ—¶ä¸‹è½½ä¿å­˜
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* 3Dé¢„è§ˆå™¨ */}
      {showViewer && (
        <Model3DViewer
          modelUrl={modelData.modelUrl}
          format={modelData.format}
          onClose={() => setShowViewer(false)}
        />
      )}

      {/* ARé¢„è§ˆå™¨ */}
      {showAR && (
        <ARViewer
          modelUrl={modelData.modelUrl}
          onClose={() => setShowAR(false)}
        />
      )}
    </>
  )
}
```

## ğŸ›¡ï¸ ç”¨æˆ·å‹å¥½çš„é”™è¯¯å¤„ç†

### é”™è¯¯ç±»å‹æ˜ å°„

```typescript
interface ErrorHandler {
  // APIé”™è¯¯æ˜ å°„ä¸ºç”¨æˆ·å‹å¥½çš„æç¤º
  errorMap: {
    'AuthFailure.SignatureFailure': 'æœåŠ¡è¿æ¥å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•'
    'InvalidParameter': 'å‚æ•°è®¾ç½®æœ‰è¯¯ï¼Œè¯·æ£€æŸ¥è¾“å…¥å†…å®¹'
    'LimitExceeded': 'å½“å‰æœåŠ¡ç¹å¿™ï¼Œè¯·ç¨åé‡è¯•'
    'RequestLimitExceeded': 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•'
    'ResourceNotFound': 'è¯·æ±‚çš„èµ„æºä¸å­˜åœ¨'
    'InternalError': 'æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œæˆ‘ä»¬æ­£åœ¨ä¿®å¤ä¸­'
    'InvalidParameterValue': 'è¾“å…¥å†…å®¹ä¸ç¬¦åˆè¦æ±‚ï¼Œè¯·é‡æ–°æ£€æŸ¥'
    'MissingParameter': 'ç¼ºå°‘å¿…è¦ä¿¡æ¯ï¼Œè¯·å®Œå–„åé‡è¯•'
    'UnsupportedOperation': 'å½“å‰æ“ä½œæš‚ä¸æ”¯æŒ'
    'ResourceUnavailable': 'æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•'
  }

  // ä¸šåŠ¡é”™è¯¯å¤„ç†
  businessErrors: {
    'INSUFFICIENT_CREDITS': {
      title: 'ç§¯åˆ†ä¸è¶³'
      message: 'å½“å‰ç§¯åˆ†ä¸è¶³ä»¥å®Œæˆæ­¤æ¬¡ç”Ÿæˆï¼Œè¯·å……å€¼åé‡è¯•'
      action: 'å»å……å€¼'
    }
    'INVALID_IMAGE_FORMAT': {
      title: 'å›¾ç‰‡æ ¼å¼é”™è¯¯'
      message: 'è¯·ä¸Šä¼ PNGã€JPGã€JPEGæˆ–WEBPæ ¼å¼çš„å›¾ç‰‡'
      action: 'é‡æ–°ä¸Šä¼ '
    }
    'IMAGE_TOO_LARGE': {
      title: 'å›¾ç‰‡è¿‡å¤§'
      message: 'å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡10MBï¼Œè¯·å‹ç¼©åé‡æ–°ä¸Šä¼ '
      action: 'é‡æ–°ä¸Šä¼ '
    }
    'QUEUE_FULL': {
      title: 'æœåŠ¡ç¹å¿™'
      message: 'å½“å‰ç”Ÿæˆè¯·æ±‚è¾ƒå¤šï¼Œè¯·ç¨åé‡è¯•'
      action: 'ç¨åé‡è¯•'
    }
    'GENERATION_FAILED': {
      title: 'ç”Ÿæˆå¤±è´¥'
      message: 'æ¨¡å‹ç”Ÿæˆè¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œç§¯åˆ†å·²é€€è¿˜ï¼Œè¯·é‡è¯•'
      action: 'é‡æ–°ç”Ÿæˆ'
    }
  }
}

// é”™è¯¯å¤„ç†å‡½æ•°
export function handleAPIError(error: any): UserFriendlyError {
  // éšè—æ‰€æœ‰æŠ€æœ¯ç»†èŠ‚ï¼Œåªè¿”å›ç”¨æˆ·å‹å¥½çš„æç¤º
  const errorCode = error.code || error.message

  if (ERROR_HANDLER.errorMap[errorCode]) {
    return {
      title: 'ç”Ÿæˆé‡åˆ°é—®é¢˜',
      message: ERROR_HANDLER.errorMap[errorCode],
      action: 'é‡è¯•'
    }
  }

  // é»˜è®¤é”™è¯¯æç¤º
  return {
    title: 'æœåŠ¡æš‚æ—¶ä¸å¯ç”¨',
    message: 'æˆ‘ä»¬æ­£åœ¨åŠªåŠ›ä¿®å¤ä¸­ï¼Œè¯·ç¨åé‡è¯•',
    action: 'é‡è¯•'
  }
}
```

## ğŸ“ˆ å®Œæ•´å¼€å‘è®¡åˆ’

### Phase 1: æ ¸å¿ƒåŠŸèƒ½å¼€å‘ (3-4å‘¨)
- âœ… é›†æˆè…¾è®¯äº‘å®˜æ–¹SDK
- âœ… å®ç°3Dç”ŸæˆæœåŠ¡å°è£…
- âœ… å¼€å‘æ™ºèƒ½é˜Ÿåˆ—ç®¡ç†ç³»ç»Ÿ
- âœ… åˆ›å»ºå®Œæˆé€šçŸ¥å¼¹çª—
- âœ… å®ç°ç”¨æˆ·å‹å¥½çš„é”™è¯¯å¤„ç†

### Phase 2: é«˜çº§åŠŸèƒ½å¼€å‘ (2-3å‘¨)
- âœ… å¤šè§†å›¾å›¾ç‰‡ä¸Šä¼ æŒ‡å¯¼
- âœ… 3Dæ¨¡å‹é¢„è§ˆå™¨(Three.js)
- âœ… ARé¢„è§ˆåŠŸèƒ½
- âœ… ç§»åŠ¨ç«¯å“åº”å¼ä¼˜åŒ–
- âœ… é«˜å³°æœŸé˜Ÿåˆ—ç®¡ç†ç­–ç•¥

### Phase 3: å®Œå–„ä¸ä¼˜åŒ– (1-2å‘¨)
- âœ… ç¤¾åŒºåŠŸèƒ½æ•°æ®åº“é¢„åŸ‹
- âœ… æ–‡ä»¶è¿‡æœŸæ¸…ç†æœºåˆ¶
- âœ… æ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–
- âœ… ç”¨æˆ·ä½“éªŒç»†èŠ‚æ‰“ç£¨

### Phase 4: æµ‹è¯•ä¸å‘å¸ƒ (1å‘¨)
- âœ… å…¨åŠŸèƒ½é›†æˆæµ‹è¯•
- âœ… å‹åŠ›æµ‹è¯•å’Œä¼˜åŒ–
- âœ… ç”¨æˆ·ä½“éªŒæµ‹è¯•
- âœ… æ­£å¼å‘å¸ƒ

## ğŸ’° æˆæœ¬æ§åˆ¶ä¸ç›‘æ§

### æ— ç”¨æˆ·é™åˆ¶ç­–ç•¥
- ä¸è®¾ç½®å•ç”¨æˆ·æ¯æ—¥ç”Ÿæˆé™åˆ¶
- é€šè¿‡é˜Ÿåˆ—ç®¡ç†è‡ªç„¶è°ƒèŠ‚ä½¿ç”¨é¢‘ç‡
- é‡ç‚¹ä¼˜åŒ–é˜Ÿåˆ—æ•ˆç‡å’Œç”¨æˆ·ä½“éªŒ

### é«˜å³°æœŸç®¡ç†
- æ™ºèƒ½æ£€æµ‹é«˜å³°æ—¶æ®µ(9:00-22:00)
- åŠ¨æ€è°ƒæ•´å¹¶å‘å¤„ç†èƒ½åŠ›
- ä¼˜åŒ–é¢„ä¼°ç­‰å¾…æ—¶é—´ç®—æ³•
- ä¼˜å…ˆä¿è¯ç”¨æˆ·ä½“éªŒ

### ç›‘æ§æŒ‡æ ‡
```typescript
interface MonitoringMetrics {
  queue: {
    averageWaitTime: number    // å¹³å‡ç­‰å¾…æ—¶é—´
    peakHourMultiplier: number // é«˜å³°æœŸå€æ•°
    concurrentJobs: number     // å¹¶å‘ä»»åŠ¡æ•°
  }

  business: {
    dailyGenerations: number   // æ¯æ—¥ç”Ÿæˆé‡
    successRate: number        // æˆåŠŸç‡
    userSatisfaction: number   // ç”¨æˆ·æ»¡æ„åº¦
  }

  technical: {
    apiResponseTime: number    // APIå“åº”æ—¶é—´
    errorRate: number          // é”™è¯¯ç‡
    resourceUtilization: number // èµ„æºä½¿ç”¨ç‡
  }
}
```

## ğŸ“± ç§»åŠ¨ç«¯ä¸ARæ”¯æŒ

### ARé¢„è§ˆåŠŸèƒ½
- WebXR APIé›†æˆ
- æ”¯æŒiOS Safariå’ŒAndroid Chrome
- é™çº§ç­–ç•¥ï¼šä¸æ”¯æŒARæ—¶æ˜¾ç¤ºå¸¸è§„3Dé¢„è§ˆ
- ç”¨æˆ·è®¾å¤‡æ£€æµ‹å’Œå…¼å®¹æ€§æç¤º

### ç§»åŠ¨ç«¯ä¼˜åŒ–
- è§¦æ‘¸æ‰‹åŠ¿æ”¯æŒ
- å“åº”å¼ç•Œé¢è®¾è®¡
- æ€§èƒ½ä¼˜åŒ–ï¼ˆä½ç«¯è®¾å¤‡é€‚é…ï¼‰
- ç¦»çº¿ä¸‹è½½æ”¯æŒ

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0
**åˆ›å»ºæ—¶é—´**: 2025-09-27
**æ›´æ–°æ—¶é—´**: 2025-09-27
**ä¸»è¦æ›´æ–°**:
- âœ… é›†æˆè…¾è®¯äº‘å®˜æ–¹SDKï¼Œç®€åŒ–å¼€å‘å¤æ‚åº¦
- âœ… å®ç°ç”¨æˆ·å‹å¥½çš„é”™è¯¯å¤„ç†ï¼Œéšè—æŠ€æœ¯ç»†èŠ‚
- âœ… æ·»åŠ ARé¢„è§ˆåŠŸèƒ½æ”¯æŒ
- âœ… å®Œå–„é«˜å³°æœŸé˜Ÿåˆ—ç®¡ç†ç­–ç•¥
- âœ… è®¾è®¡å®Œæˆé€šçŸ¥å¼¹çª—ç³»ç»Ÿ
- âœ… æ— ç”¨æˆ·ç”Ÿæˆé™åˆ¶ï¼Œä¼˜åŒ–ç”¨æˆ·ä½“éªŒ
- âœ… å…¨åŠŸèƒ½å¼€å‘è®¡åˆ’ï¼Œä¸åˆ†é˜¶æ®µå®ç°